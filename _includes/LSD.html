<pre>
<code><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> ExitStack, contextmanager
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> date, timedelta
<span class="hljs-keyword">from</span> dateutil.relativedelta <span class="hljs-keyword">import</span> relativedelta
<span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha256
<span class="hljs-keyword">from</span> json <span class="hljs-keyword">import</span> dumps
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> markupsafe <span class="hljs-keyword">import</span> Markup
<span class="hljs-keyword">from</span> psycopg2 <span class="hljs-keyword">import</span> OperationalError
<span class="hljs-keyword">import</span> math
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">from</span> textwrap <span class="hljs-keyword">import</span> shorten
</code></pre>

<div id="strings"><span>##CONTENT##</span></div>
<div id="typed"></div>

<pre><code>
_logger = logging.getLogger(<span class="hljs-string">"##TITLE##"</span>)


MAX_HASH_VERSION = <span class="hljs-number">3</span>

PAYMENT_STATE_SELECTION = [
        (<span class="hljs-string">'not_paid'</span>, <span class="hljs-string">'Not Paid'</span>),
        (<span class="hljs-string">'in_ğŸ•·'</span>, <span class="hljs-string">'In ğŸ•·'</span>),
        (<span class="hljs-string">'paid'</span>, <span class="hljs-string">'Paid'</span>),
        (<span class="hljs-string">'partial'</span>, <span class="hljs-string">'Partially Paid'</span>),
        (<span class="hljs-string">'reversed'</span>, <span class="hljs-string">'Reversed'</span>),
        (<span class="hljs-string">'invoicing_legacy'</span>, <span class="hljs-string">'Invoicing App Legacy'</span>),
]

TYPE_REVERSE_MAP = {
    <span class="hljs-string">'entry'</span>: <span class="hljs-string">'entry'</span>,
    <span class="hljs-string">'out_ğŸ•¸'</span>: <span class="hljs-string">'out_refund'</span>,
    <span class="hljs-string">'out_refund'</span>: <span class="hljs-string">'entry'</span>,
    <span class="hljs-string">'in_ğŸ•¸'</span>: <span class="hljs-string">'in_refund'</span>,
    <span class="hljs-string">'in_refund'</span>: <span class="hljs-string">'entry'</span>,
    <span class="hljs-string">'out_receipt'</span>: <span class="hljs-string">'out_refund'</span>,
    <span class="hljs-string">'in_receipt'</span>: <span class="hljs-string">'in_refund'</span>,
}

EMPTY = <span class="hljs-built_in">object</span>()


    <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountMove</span>(models.Model):
    _name = <span class="hljs-string">"ğŸ¦‹.ğŸ†"</span>
    _inherit = [<span class="hljs-string">'portal.mixin'</span>, <span class="hljs-string">'mail.thread.main.attachment'</span>, <span class="hljs-string">'mail.activity.mixin'</span>, <span class="hljs-string">'sequence.mixin'</span>]
    _description = <span class="hljs-string">"ğŸ“– Entry"</span>
    _order = <span class="hljs-string">'ğŸ“† desc, name desc, ğŸ•¸_ğŸ“† desc, id desc'</span>
    _mail_post_access = <span class="hljs-string">'read'</span>
    _check_<b class="MagicREVOLUTION">ğŸªğŸ¦’ğŸ«</b>_auto = <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>
    _sequence_index = <span class="hljs-string">"ğŸ“–_ğŸ’ƒ"</span>
    _rec_names_search = [<span class="hljs-string">'name'</span>, <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ.name'</span>, <span class="hljs-string">'ref'</span>]
    _systray_view = <span class="hljs-string">'activity'</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±property</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_sequence_monthly_regex</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.sequence_override_regex <span class="hljs-keyword">or</span> <span class="hljs-built_in">super</span>()._sequence_monthly_regex

<span class="hljs-meta">    ğŸ‡®ğŸ‡±property</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_sequence_yearly_regex</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.sequence_override_regex <span class="hljs-keyword">or</span> <span class="hljs-built_in">super</span>()._sequence_yearly_regex

<span class="hljs-meta">    ğŸ‡®ğŸ‡±property</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_sequence_fixed_regex</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.sequence_override_regex <span class="hljs-keyword">or</span> <span class="hljs-built_in">super</span>()._sequence_fixed_regex


    <span class="hljs-comment"># ==============================================================================================</span>
    <span class="hljs-comment">#                                          ğŸ“– ENTRY</span>
    <span class="hljs-comment"># ==============================================================================================</span>

    <span class="hljs-comment"># === ğŸ¦‹ing âœ¨ === #</span>
    name = âœ¨.Char(
        string=<span class="hljs-string">'Number'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_name'</span>, inverse=<span class="hljs-string">'_inverse_name'</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        index=<span class="hljs-string">'trigram'</span>,
    )
    ref = âœ¨.Char(
        string=<span class="hljs-string">'Reference'</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        index=<span class="hljs-string">'trigram'</span>,
    )
    ğŸ“† = âœ¨.ğŸ“†(
        string=<span class="hljs-string">'ğŸ“†'</span>,
        index=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ“†'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, required=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, preâ˜¢ï¸=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
    )
    state = âœ¨.Selection(
        selection=[
            (<span class="hljs-string">'draft'</span>, <span class="hljs-string">'Draft'</span>),
            (<span class="hljs-string">'posted'</span>, <span class="hljs-string">'Posted'</span>),
            (<span class="hljs-string">'cancel'</span>, <span class="hljs-string">'Cancelled'</span>),
        ],
        string=<span class="hljs-string">'Status'</span>,
        required=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        default=<span class="hljs-string">'draft'</span>,
    )
    ğŸ†_type = âœ¨.Selection(
        selection=[
            (<span class="hljs-string">'entry'</span>, <span class="hljs-string">'ğŸ“– Entry'</span>),
            (<span class="hljs-string">'out_ğŸ•¸'</span>, <span class="hljs-string">'Customer ğŸ•¸'</span>),
            (<span class="hljs-string">'out_refund'</span>, <span class="hljs-string">'Customer ğŸ‘¬ Note'</span>),
            (<span class="hljs-string">'in_ğŸ•¸'</span>, <span class="hljs-string">'Vendor Bill'</span>),
            (<span class="hljs-string">'in_refund'</span>, <span class="hljs-string">'Vendor ğŸ‘¬ Note'</span>),
            (<span class="hljs-string">'out_receipt'</span>, <span class="hljs-string">'Sales Receipt'</span>),
            (<span class="hljs-string">'in_receipt'</span>, <span class="hljs-string">'Purchase Receipt'</span>),
        ],
        string=<span class="hljs-string">'Type'</span>,
        required=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        change_default=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        index=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        default=<span class="hljs-string">"entry"</span>,
    )
    is_storno = âœ¨.Boolean(
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_is_storno'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
    )
    ğŸ“–_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        <span class="hljs-string">'ğŸ¦‹.ğŸ“–'</span>,
        string=<span class="hljs-string">'ğŸ“–'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ“–_ğŸ’ƒ'</span>, inverse=<span class="hljs-string">'_inverse_ğŸ“–_ğŸ’ƒ'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, preâ˜¢ï¸=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        required=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        check_ğŸªğŸ¦’ğŸ«=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        domain=<span class="hljs-string">"[('id', 'in', suitable_ğŸ“–_ğŸ‘¯â€â™€ï¸)]"</span>,
    )
    ğŸªğŸ¦’ğŸ«_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        comodel_name=<span class="hljs-string">'res.ğŸªğŸ¦’ğŸ«'</span>,
        string=<span class="hljs-string">'ğŸªğŸ¦’ğŸ«'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>, inverse=<span class="hljs-string">'_inverse_ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, preâ˜¢ï¸=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        index=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
    )
    ğŸŒˆ_ğŸ‘¯â€â™€ï¸ = âœ¨.ğŸ§šâ€â™€ï¸(
        <span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>,
        <span class="hljs-string">'ğŸ†_ğŸ’ƒ'</span>,
        string=<span class="hljs-string">'ğŸ“– Items'</span>,
        copy=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
    )

    <span class="hljs-comment"># === ğŸ•· âœ¨ === #</span>
    ğŸ•·_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        comodel_name=<span class="hljs-string">'ğŸ¦‹.ğŸ•·'</span>,
        string=<span class="hljs-string">"ğŸ•·"</span>,
        index=<span class="hljs-string">'btree_not_null'</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        check_ğŸªğŸ¦’ğŸ«=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
    )

    <span class="hljs-comment"># === Statement âœ¨ === #</span>
    statement_ğŸŒˆ_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        comodel_name=<span class="hljs-string">'ğŸ¦‹.bank.statement.ğŸŒˆ'</span>,
        string=<span class="hljs-string">"Statement ğŸŒˆ"</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        check_ğŸªğŸ¦’ğŸ«=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        index=<span class="hljs-string">'btree_not_null'</span>,
    )
    statement_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        related=<span class="hljs-string">"statement_ğŸŒˆ_ğŸ’ƒ.statement_ğŸ’ƒ"</span>
    )

    <span class="hljs-comment"># === ğŸ’¸ basis feature âœ¨ === #</span>
    <span class="hljs-comment"># used to keep track of the ğŸ’€ ğŸ’¸ basis reconciliation. This is needed</span>
    <span class="hljs-comment"># when cancelling the source: it will post the inverse ğŸ“– entry to</span>
    <span class="hljs-comment"># cancel that part too.</span>
    ğŸ’€_ğŸ’¸_basis_rec_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        comodel_name=<span class="hljs-string">'ğŸ¦‹.partial.reconcile'</span>,
        string=<span class="hljs-string">'ğŸ’€ ğŸ’¸ Basis Entry of'</span>,
    )
    ğŸ’€_ğŸ’¸_basis_origin_ğŸ†_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        comodel_name=<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>,
        index=<span class="hljs-string">'btree_not_null'</span>,
        string=<span class="hljs-string">"ğŸ’¸ Basis Origin"</span>,
        readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"The ğŸ“– entry from which this ğŸ’€ ğŸ’¸ basis ğŸ“– entry has been created."</span>,
    )
    ğŸ’€_ğŸ’¸_basis_created_ğŸ†_ğŸ‘¯â€â™€ï¸ = âœ¨.ğŸ§šâ€â™€ï¸(
        string=<span class="hljs-string">"ğŸ’¸ Basis Entries"</span>,
        comodel_name=<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>,
        inverse_name=<span class="hljs-string">'ğŸ’€_ğŸ’¸_basis_origin_ğŸ†_ğŸ’ƒ'</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"The ğŸ’¸ basis entries created from the ğŸ’€es on this entry, when reconciling its ğŸŒˆs."</span>,
    )

    <span class="hljs-comment"># used by ğŸ’¸ basis ğŸ’€es, telling the ğŸŒˆs of the ğŸ† are always</span>
    <span class="hljs-comment"># exigible. This happens if the ğŸ† contains no payable or receivable ğŸŒˆ.</span>
    always_ğŸ’€_exigible = âœ¨.Boolean(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_always_ğŸ’€_exigible'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)

    <span class="hljs-comment"># === Misc âœ¨ === #</span>
    auto_post = âœ¨.Selection(
        string=<span class="hljs-string">'Auto-post'</span>,
        selection=[
            (<span class="hljs-string">'no'</span>, <span class="hljs-string">'No'</span>),
            (<span class="hljs-string">'at_ğŸ“†'</span>, <span class="hljs-string">'At ğŸ“†'</span>),
            (<span class="hljs-string">'monthly'</span>, <span class="hljs-string">'Monthly'</span>),
            (<span class="hljs-string">'quarterly'</span>, <span class="hljs-string">'Quarterly'</span>),
            (<span class="hljs-string">'yearly'</span>, <span class="hljs-string">'Yearly'</span>),
        ],
        default=<span class="hljs-string">'no'</span>, required=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">'Specify whether this entry is posted automatically on its ğŸ¦‹ing ğŸ“†, and any similar recurring ğŸ•¸s.'</span>)
    auto_post_until = âœ¨.ğŸ“†(
        string=<span class="hljs-string">'Auto-post until'</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_auto_post_until'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">'This recurring ğŸ† will be posted up to and including this ğŸ“†.'</span>)
    auto_post_origin_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        comodel_name=<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>,
        string=<span class="hljs-string">'First recurring entry'</span>,
        readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        index=<span class="hljs-string">'btree_not_null'</span>,
    )
    hide_post_button = âœ¨.Boolean(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_hide_post_button'</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)
    to_check = âœ¨.Boolean(
        string=<span class="hljs-string">'To Check'</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"If this checkbox is ticked, it means that the user was not sure of all the related "</span>
             <span class="hljs-string">"information at the time of the creation of the ğŸ† and that the ğŸ† needs to be "</span>
             <span class="hljs-string">"checked again."</span>,
    )
    posted_before = âœ¨.Boolean(copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)
    suitable_ğŸ“–_ğŸ‘¯â€â™€ï¸ = âœ¨.Many2many(
        <span class="hljs-string">'ğŸ¦‹.ğŸ“–'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_suitable_ğŸ“–_ğŸ‘¯â€â™€ï¸'</span>,
    )
    highest_name = âœ¨.Char(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_highest_name'</span>)
    made_sequence_hole = âœ¨.Boolean(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_made_sequence_hole'</span>)
    show_name_warning = âœ¨.Boolean(store=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)
    type_name = âœ¨.Char(<span class="hljs-string">'Type Name'</span>, â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_type_name'</span>)
    country_code = âœ¨.Char(related=<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¦‹_fiscal_country_ğŸ’ƒ.code'</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)
    attachment_ğŸ‘¯â€â™€ï¸ = âœ¨.ğŸ§šâ€â™€ï¸(<span class="hljs-string">'ir.attachment'</span>, <span class="hljs-string">'res_ğŸ’ƒ'</span>, domain=[(<span class="hljs-string">'res_model'</span>, <span class="hljs-string">'='</span>, <span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>)], string=<span class="hljs-string">'Attachments'</span>)

    <span class="hljs-comment"># === Hash âœ¨ === #</span>
    restrict_mode_hash_table = âœ¨.Boolean(related=<span class="hljs-string">'ğŸ“–_ğŸ’ƒ.restrict_mode_hash_table'</span>)
    secure_sequence_number = âœ¨.Integer(string=<span class="hljs-string">"Inalteralbility No Gap Sequence #"</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, index=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)
    inalterable_hash = âœ¨.Char(string=<span class="hljs-string">"Inalterability Hash"</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)
    string_to_hash = âœ¨.Char(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_string_to_hash'</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)

    <span class="hljs-comment"># ==============================================================================================</span>
    <span class="hljs-comment">#                                          ğŸ•¸</span>
    <span class="hljs-comment"># ==============================================================================================</span>

    ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸ = âœ¨.ğŸ§šâ€â™€ï¸(  <span class="hljs-comment"># /!\ ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸ is just a subset of ğŸŒˆ_ğŸ‘¯â€â™€ï¸.</span>
        <span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>,
        <span class="hljs-string">'ğŸ†_ğŸ’ƒ'</span>,
        string=<span class="hljs-string">'ğŸ•¸ ğŸŒˆs'</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        domain=[(<span class="hljs-string">'display_type'</span>, <span class="hljs-string">'in'</span>, (<span class="hljs-string">'product'</span>, <span class="hljs-string">'ğŸŒˆ_section'</span>, <span class="hljs-string">'ğŸŒˆ_note'</span>))],
    )

    <span class="hljs-comment"># === ğŸ“† âœ¨ === #</span>
    ğŸ•¸_ğŸ“† = âœ¨.ğŸ“†(
        string=<span class="hljs-string">'ğŸ•¸/Bill ğŸ“†'</span>,
        index=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
    )
    ğŸ•¸_ğŸ“†_due = âœ¨.ğŸ“†(
        string=<span class="hljs-string">'Due ğŸ“†'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ•¸_ğŸ“†_due'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        index=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
    )
    delivery_ğŸ“† = âœ¨.ğŸ“†(
        string=<span class="hljs-string">'Delivery ğŸ“†'</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_delivery_ğŸ“†'</span>,
    )
    show_delivery_ğŸ“† = âœ¨.Boolean(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_show_delivery_ğŸ“†'</span>)
    ğŸ•¸_ğŸ•·_term_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        comodel_name=<span class="hljs-string">'ğŸ¦‹.ğŸ•·.term'</span>,
        string=<span class="hljs-string">'ğŸ•· Terms'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ•¸_ğŸ•·_term_ğŸ’ƒ'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, preâ˜¢ï¸=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        inverse=<span class="hljs-string">'_inverse_ğŸ•¸_ğŸ•·_term_ğŸ’ƒ'</span>,
        check_ğŸªğŸ¦’ğŸ«=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
    )
    needed_terms = âœ¨.Binary(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_needed_terms'</span>, exportable=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)
    needed_terms_dirty = âœ¨.Boolean(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_needed_terms'</span>)
    ğŸ’€_calculation_rounding_method = âœ¨.Selection(
        related=<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ’€_calculation_rounding_method'</span>,
        string=<span class="hljs-string">'ğŸ’€ calculation rounding method'</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)
    <span class="hljs-comment"># === ğŸ¤  âœ¨ === #</span>
    ğŸ¤ _ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        <span class="hljs-string">'res.ğŸ¤ '</span>,
        string=<span class="hljs-string">'ğŸ¤ '</span>,
        readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        inverse=<span class="hljs-string">'_inverse_ğŸ¤ _ğŸ’ƒ'</span>,
        check_ğŸªğŸ¦’ğŸ«=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        change_default=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        index=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        ondelete=<span class="hljs-string">'restrict'</span>,
    )
    commercial_ğŸ¤ _ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        <span class="hljs-string">'res.ğŸ¤ '</span>,
        string=<span class="hljs-string">'Commercial Entity'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_commercial_ğŸ¤ _ğŸ’ƒ'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        ondelete=<span class="hljs-string">'restrict'</span>,
    )
    ğŸ¤ _shipping_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        comodel_name=<span class="hljs-string">'res.ğŸ¤ '</span>,
        string=<span class="hljs-string">'Delivery Address'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ¤ _shipping_ğŸ’ƒ'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, preâ˜¢ï¸=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        check_ğŸªğŸ¦’ğŸ«=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"The delivery address will be used in the computation of the fiscal position."</span>,
    )
    ğŸ¤ _bank_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        <span class="hljs-string">'res.ğŸ¤ .bank'</span>,
        string=<span class="hljs-string">'Recipient Bank'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ¤ _bank_ğŸ’ƒ'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"Bank ğŸ¦‹ Number to which the ğŸ•¸ will be paid. "</span>
             <span class="hljs-string">"A ğŸªğŸ¦’ğŸ« bank ğŸ¦‹ if this is a Customer ğŸ•¸ or Vendor ğŸ‘¬ Note, "</span>
             <span class="hljs-string">"otherwise a ğŸ¤  bank ğŸ¦‹ number."</span>,
        check_ğŸªğŸ¦’ğŸ«=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        ondelete=<span class="hljs-string">'restrict'</span>,
    )
    fiscal_position_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        <span class="hljs-string">'ğŸ¦‹.fiscal.position'</span>,
        string=<span class="hljs-string">'Fiscal Position'</span>,
        check_ğŸªğŸ¦’ğŸ«=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_fiscal_position_ğŸ’ƒ'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, preâ˜¢ï¸=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        ondelete=<span class="hljs-string">"restrict"</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"Fiscal positions are used to adapt ğŸ’€es and ğŸ¦‹s for particular "</span>
             <span class="hljs-string">"customers or sales orders/ğŸ•¸s. The default value comes from the customer."</span>,
    )

    <span class="hljs-comment"># === ğŸ•· âœ¨ === #</span>
    ğŸ•·_reference = âœ¨.Char(
        string=<span class="hljs-string">'ğŸ•· Reference'</span>,
        index=<span class="hljs-string">'trigram'</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"The ğŸ•· reference to set on ğŸ“– items."</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ•·_reference'</span>, inverse=<span class="hljs-string">'_inverse_ğŸ•·_reference'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
    )
    display_qr_code = âœ¨.Boolean(
        string=<span class="hljs-string">"Display QR-code"</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_display_qr_code'</span>,
    )
    qr_code_method = âœ¨.Selection(
        string=<span class="hljs-string">"ğŸ•· QR-code"</span>, copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        selection=<span class="hljs-keyword">lambda</span> ğŸ‡¬ğŸ‡§: ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'res.ğŸ¤ .bank'</span>].get_available_qr_methods_in_sequence(),
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"Type of QR-code to be generated for the ğŸ•· of this ğŸ•¸, "</span>
             <span class="hljs-string">"when printing it. If left blank, the first available and usable method "</span>
             <span class="hljs-string">"will be used."</span>,
    )

    <span class="hljs-comment"># === ğŸ•· widget âœ¨ === #</span>
    ğŸ•¸_outstanding_ğŸ‘¬s_ğŸ‘—s_widget = âœ¨.Binary(
        groups=<span class="hljs-string">"ğŸ¦‹.group_ğŸ¦‹_ğŸ•¸,ğŸ¦‹.group_ğŸ¦‹_readonly"</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ•·s_widget_to_reconcile_info'</span>,
        exportable=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
    )
    ğŸ•¸_has_outstanding = âœ¨.Boolean(
        groups=<span class="hljs-string">"ğŸ¦‹.group_ğŸ¦‹_ğŸ•¸,ğŸ¦‹.group_ğŸ¦‹_readonly"</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ•·s_widget_to_reconcile_info'</span>,
    )
    ğŸ•¸_ğŸ•·s_widget = âœ¨.Binary(
        groups=<span class="hljs-string">"ğŸ¦‹.group_ğŸ¦‹_ğŸ•¸,ğŸ¦‹.group_ğŸ¦‹_readonly"</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ•·s_widget_reconciled_info'</span>,
        exportable=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
    )

    <span class="hljs-comment"># === ğŸ‘½ âœ¨ === #</span>
    ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        string=<span class="hljs-string">'ğŸªğŸ¦’ğŸ« ğŸ‘½'</span>,
        related=<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ'</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
    )
    ğŸ‘½_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        <span class="hljs-string">'res.ğŸ‘½'</span>,
        string=<span class="hljs-string">'ğŸ‘½'</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        required=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ‘½_ğŸ’ƒ'</span>, inverse=<span class="hljs-string">'_inverse_ğŸ‘½_ğŸ’ƒ'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, preâ˜¢ï¸=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
    )

    <span class="hljs-comment"># === ğŸ¤‘ âœ¨ === #</span>
    direction_sign = âœ¨.Integer(
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_direction_sign'</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"Multiplicator depending on the document type, to convert a price into a ğŸ‘‘"</span>,
    )
    ğŸ¤‘_unğŸ’€ed = âœ¨.ğŸ’°(
        string=<span class="hljs-string">'UnğŸ’€ed ğŸ¤‘'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ¤‘'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
    )
    ğŸ¤‘_ğŸ’€ = âœ¨.ğŸ’°(
        string=<span class="hljs-string">'ğŸ’€'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ¤‘'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
    )
    ğŸ¤‘_ğŸ‘€ = âœ¨.ğŸ’°(
        string=<span class="hljs-string">'ğŸ‘€'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ¤‘'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        inverse=<span class="hljs-string">'_inverse_ğŸ¤‘_ğŸ‘€'</span>,
    )
    ğŸ¤‘_residual = âœ¨.ğŸ’°(
        string=<span class="hljs-string">'ğŸ¤‘ Due'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ¤‘'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
    )
    ğŸ¤‘_unğŸ’€ed_signed = âœ¨.ğŸ’°(
        string=<span class="hljs-string">'UnğŸ’€ed ğŸ¤‘ Signed'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ¤‘'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        ğŸ‘½_field=<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ'</span>,
    )
    ğŸ¤‘_ğŸ’€_signed = âœ¨.ğŸ’°(
        string=<span class="hljs-string">'ğŸ’€ Signed'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ¤‘'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        ğŸ‘½_field=<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ'</span>,
    )
    ğŸ¤‘_ğŸ‘€_signed = âœ¨.ğŸ’°(
        string=<span class="hljs-string">'ğŸ‘€ Signed'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ¤‘'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        ğŸ‘½_field=<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ'</span>,
    )
    ğŸ¤‘_ğŸ‘€_in_ğŸ‘½_signed = âœ¨.ğŸ’°(
        string=<span class="hljs-string">'ğŸ‘€ in ğŸ‘½ Signed'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ¤‘'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        ğŸ‘½_field=<span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>,
    )
    ğŸ¤‘_residual_signed = âœ¨.ğŸ’°(
        string=<span class="hljs-string">'ğŸ¤‘ Due Signed'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ¤‘'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        ğŸ‘½_field=<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ'</span>,
    )
    ğŸ’€_ğŸ‘€s = âœ¨.Binary(
        string=<span class="hljs-string">"ğŸ•¸ ğŸ‘€s"</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ’€_ğŸ‘€s'</span>,
        inverse=<span class="hljs-string">'_inverse_ğŸ’€_ğŸ‘€s'</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">'Edit ğŸ’€ ğŸ¤‘s if you encounter rounding issues.'</span>,
        exportable=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
    )
    ğŸ•·_state = âœ¨.Selection(
        selection=ğŸ•·_STATE_SELECTION,
        string=<span class="hljs-string">"ğŸ•· Status"</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ•·_state'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
    )
    ğŸ¤‘_ğŸ‘€_words = âœ¨.Char(
        string=<span class="hljs-string">"ğŸ¤‘ ğŸ‘€ in words"</span>,
        â˜¢ï¸=<span class="hljs-string">"_â˜¢ï¸_ğŸ¤‘_ğŸ‘€_words"</span>,
    )

    <span class="hljs-comment"># === Reverse feature âœ¨ === #</span>
    reversed_entry_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        comodel_name=<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>,
        string=<span class="hljs-string">"Reversal of"</span>,
        index=<span class="hljs-string">'btree_not_null'</span>,
        readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        check_ğŸªğŸ¦’ğŸ«=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
    )
    reversal_ğŸ†_ğŸ’ƒ = âœ¨.ğŸ§šâ€â™€ï¸(<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>, <span class="hljs-string">'reversed_entry_ğŸ’ƒ'</span>)

    <span class="hljs-comment"># === Vendor bill âœ¨ === #</span>
    ğŸ•¸_vendor_bill_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        <span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>,
        store=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        check_ğŸªğŸ¦’ğŸ«=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        string=<span class="hljs-string">'Vendor Bill'</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"Auto-complete from a past bill."</span>,
    )
    ğŸ•¸_source_email = âœ¨.Char(string=<span class="hljs-string">'Source Email'</span>, tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)
    ğŸ•¸_ğŸ¤ _display_name = âœ¨.Char(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ•¸_ğŸ¤ _display_info'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)

    <span class="hljs-comment"># === Fiduciary mode âœ¨ === #</span>
    quick_edit_mode = âœ¨.Boolean(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_quick_edit_mode'</span>)
    quick_edit_ğŸ‘€_ğŸ¤‘ = âœ¨.ğŸ’°(
        string=<span class="hljs-string">'ğŸ‘€ (ğŸ’€ inc.)'</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">'Use this field to encode the ğŸ‘€ ğŸ¤‘ of the ğŸ•¸.\n'</span>
             <span class="hljs-string">'Odoo will automatically create one ğŸ•¸ ğŸŒˆ with default values to match it.'</span>,
    )
    quick_encoding_vals = âœ¨.Binary(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_quick_encoding_vals'</span>, exportable=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)

    <span class="hljs-comment"># === Misc Information === #</span>
    narration = âœ¨.Html(
        string=<span class="hljs-string">'Terms and Conditions'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_narration'</span>, store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
    )
    is_ğŸ†_sent = âœ¨.Boolean(
        readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"It indicates that the ğŸ•¸/ğŸ•· has been sent or the PDF has been generated."</span>,
    )
    is_being_sent = âœ¨.Boolean(
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"Is the ğŸ† being sent asynchronously"</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_is_being_sent'</span>
    )

    ğŸ•¸_user_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        string=<span class="hljs-string">'Salesperson'</span>,
        comodel_name=<span class="hljs-string">'res.users'</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ•¸_default_sale_person'</span>,
        store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
    )
    <span class="hljs-comment"># Technical field used to fit the generic behavior in mail templates.</span>
    user_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(string=<span class="hljs-string">'User'</span>, related=<span class="hljs-string">'ğŸ•¸_user_ğŸ’ƒ'</span>)
    ğŸ•¸_origin = âœ¨.Char(
        string=<span class="hljs-string">'Origin'</span>,
        readonly=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        tracking=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"The document(s) that generated the ğŸ•¸."</span>,
    )
    ğŸ•¸_incoterm_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        comodel_name=<span class="hljs-string">'ğŸ¦‹.incoterms'</span>,
        string=<span class="hljs-string">'Incoterm'</span>,
        default=<span class="hljs-keyword">lambda</span> ğŸ‡¬ğŸ‡§: ğŸ‡¬ğŸ‡§.env.ğŸªğŸ¦’ğŸ«.incoterm_ğŸ’ƒ,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">'International Commercial Terms are a series of predefined commercial '</span>
             <span class="hljs-string">'terms used in international transactions.'</span>,
    )
    incoterm_location = âœ¨.Char(
        string=<span class="hljs-string">'Incoterm Location'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_incoterm_location'</span>,
        readonly=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        store=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
    )
    ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        comodel_name=<span class="hljs-string">'ğŸ¦‹.ğŸ’¸.rounding'</span>,
        string=<span class="hljs-string">'ğŸ’¸ Rounding Method'</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">'Defines the smallest coinage of the ğŸ‘½ that can be used to pay by ğŸ’¸.'</span>,
    )
    send_and_print_values = âœ¨.Json(copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)
    ğŸ•¸_pdf_report_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        comodel_name=<span class="hljs-string">'ir.attachment'</span>,
        string=<span class="hljs-string">"PDF Attachment"</span>,
        â˜¢ï¸=<span class="hljs-keyword">lambda</span> ğŸ‡¬ğŸ‡§: ğŸ‡¬ğŸ‡§._â˜¢ï¸_linked_attachment_ğŸ’ƒ(<span class="hljs-string">'ğŸ•¸_pdf_report_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ•¸_pdf_report_file'</span>),
        depends=[<span class="hljs-string">'ğŸ•¸_pdf_report_file'</span>]
    )
    ğŸ•¸_pdf_report_file = âœ¨.Binary(
        attachment=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        string=<span class="hljs-string">"PDF File"</span>,
        copy=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
    )

    <span class="hljs-comment"># === Display purpose âœ¨ === #</span>
    <span class="hljs-comment"># used to have a dynamic domain on ğŸ“– / ğŸ’€es in the form view.</span>
    ğŸ•¸_filter_type_domain = âœ¨.Char(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ•¸_filter_type_domain'</span>)
    bank_ğŸ¤ _ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(
        comodel_name=<span class="hljs-string">'res.ğŸ¤ '</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_bank_ğŸ¤ _ğŸ’ƒ'</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">'Technical field to get the domain on the bank'</span>,
    )
    <span class="hljs-comment"># used to display a message when the ğŸ•¸'s ğŸ¦‹ing ğŸ“† is prior of the ğŸ’€ lock ğŸ“†</span>
    ğŸ’€_lock_ğŸ“†_message = âœ¨.Char(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ’€_lock_ğŸ“†_message'</span>)
    <span class="hljs-comment"># used for tracking the status of the ğŸ‘½</span>
    display_inactive_ğŸ‘½_warning = âœ¨.Boolean(â˜¢ï¸=<span class="hljs-string">"_â˜¢ï¸_display_inactive_ğŸ‘½_warning"</span>)
    ğŸ’€_country_ğŸ’ƒ = âœ¨.ğŸ§â€â™‚ï¸(  <span class="hljs-comment"># used to filter the available ğŸ’€es depending on the fiscal country and fiscal position.</span>
        comodel_name=<span class="hljs-string">'res.country'</span>,
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ’€_country_ğŸ’ƒ'</span>,
    )
    ğŸ’€_country_code = âœ¨.Char(â˜¢ï¸=<span class="hljs-string">"_â˜¢ï¸_ğŸ’€_country_code"</span>)
    has_reconciled_entries = âœ¨.Boolean(â˜¢ï¸=<span class="hljs-string">"_â˜¢ï¸_has_reconciled_entries"</span>)
    show_reset_to_draft_button = âœ¨.Boolean(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_show_reset_to_draft_button'</span>)
    ğŸ¤ _ğŸ‘¬_warning = âœ¨.Text(
        â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ¤ _ğŸ‘¬_warning'</span>,
        groups=<span class="hljs-string">"ğŸ¦‹.group_ğŸ¦‹_ğŸ•¸,ğŸ¦‹.group_ğŸ¦‹_readonly"</span>,
    )
    ğŸ¤ _ğŸ‘¬ = âœ¨.ğŸ’°(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_ğŸ¤ _ğŸ‘¬'</span>)
    duplicated_ref_ğŸ‘¯â€â™€ï¸ = âœ¨.Many2many(comodel_name=<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>, â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_duplicated_ref_ğŸ‘¯â€â™€ï¸'</span>)
    need_cancel_request = âœ¨.Boolean(â˜¢ï¸=<span class="hljs-string">'_â˜¢ï¸_need_cancel_request'</span>)

    <span class="hljs-comment"># used to display the various ğŸ“†s and ğŸ¤‘ dues on the ğŸ•¸'s PDF</span>
    ğŸ•·_term_details = âœ¨.Binary(â˜¢ï¸=<span class="hljs-string">"_â˜¢ï¸_ğŸ•·_term_details"</span>, exportable=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)
    show_ğŸ•·_term_details = âœ¨.Boolean(â˜¢ï¸=<span class="hljs-string">"_â˜¢ï¸_show_ğŸ•·_term_details"</span>)
    show_ğŸ’¯_details = âœ¨.Boolean(â˜¢ï¸=<span class="hljs-string">"_â˜¢ï¸_show_ğŸ•·_term_details"</span>)

    _sql_constraints = [(
        <span class="hljs-string">'unique_name'</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"Another entry with the same name already exists."</span>,
    )]

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_auto_init</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-built_in">super</span>()._auto_init()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> index_exists(ğŸ‡¬ğŸ‡§.env.cr, <span class="hljs-string">'ğŸ¦‹_ğŸ†_to_check_ğŸ’ƒx'</span>):
            ğŸ‡¬ğŸ‡§.env.cr.execute(<span class="hljs-string">"""
                CREATE INDEX ğŸ¦‹_ğŸ†_to_check_ğŸ’ƒx
                          ON ğŸ¦‹_ğŸ†(ğŸ“–_ğŸ’ƒ)
                       WHERE to_check = true
            """</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> index_exists(ğŸ‡¬ğŸ‡§.env.cr, <span class="hljs-string">'ğŸ¦‹_ğŸ†_ğŸ•·_ğŸ’ƒx'</span>):
            ğŸ‡¬ğŸ‡§.env.cr.execute(<span class="hljs-string">"""
                CREATE INDEX ğŸ¦‹_ğŸ†_ğŸ•·_ğŸ’ƒx
                          ON ğŸ¦‹_ğŸ†(ğŸ“–_ğŸ’ƒ, state, ğŸ•·_state, ğŸ†_type, ğŸ“†)
            """</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> index_exists(ğŸ‡¬ğŸ‡§.env.cr, <span class="hljs-string">'ğŸ¦‹_ğŸ†_unique_name'</span>):
            ğŸ‡¬ğŸ‡§.env.cr.execute(<span class="hljs-string">"""
                CREATE UNIQUE INDEX ğŸ¦‹_ğŸ†_unique_name
                                 ON ğŸ¦‹_ğŸ†(name, ğŸ“–_ğŸ’ƒ)
                              WHERE (state = 'posted' AND name != '/')
            """</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> index_exists(ğŸ‡¬ğŸ‡§.env.cr, <span class="hljs-string">'ğŸ¦‹_ğŸ†_sequence_index3'</span>):
            <span class="hljs-comment"># Used for gap detection in list views</span>
            ğŸ‡¬ğŸ‡§.env.cr.execute(<span class="hljs-string">"""
                CREATE INDEX ğŸ¦‹_ğŸ†_sequence_index3
                          ON ğŸ¦‹_ğŸ† (ğŸ“–_ğŸ’ƒ, sequence_prefix desc, (sequence_number+1) desc)
            """</span>)

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># â˜¢ï¸ METHODS</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ†_type'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ•¸_default_sale_person</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-comment"># We want to modify the sale person only when we don't have one and if the ğŸ† type corresponds to this condition</span>
        <span class="hljs-comment"># If the ğŸ† doesn't correspond, we reğŸ† the sale person</span>
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ†.is_sale_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                ğŸ†.ğŸ•¸_user_ğŸ’ƒ = ğŸ†.ğŸ•¸_user_ğŸ’ƒ <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§.env.user
            <span class="hljs-keyword">else</span>:
                ğŸ†.ğŸ•¸_user_ğŸ’ƒ = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_is_being_sent</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.is_being_sent = <span class="hljs-built_in">bool</span>(ğŸ†.send_and_print_values)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ•·_reference</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> m: (
            m.state == <span class="hljs-string">'posted'</span>
            <span class="hljs-keyword">and</span> m.ğŸ†_type == <span class="hljs-string">'out_ğŸ•¸'</span>
            <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> m.ğŸ•·_reference
        )):
            ğŸ†.ğŸ•·_reference = ğŸ†._get_ğŸ•¸_â˜¢ï¸d_reference()
        ğŸ‡¬ğŸ‡§._inverse_ğŸ•·_reference()

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ•¸_ğŸ“†'</span>, <span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ“†</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†.ğŸ•¸_ğŸ“†:
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†.ğŸ“†:
                    ğŸ†.ğŸ“† = âœ¨.ğŸ“†.context_today(ğŸ‡¬ğŸ‡§)
                <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>
            ğŸ¦‹ing_ğŸ“† = ğŸ†.ğŸ•¸_ğŸ“†
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†.is_sale_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                ğŸ¦‹ing_ğŸ“† = ğŸ†._get_ğŸ¦‹ing_ğŸ“†(ğŸ†.ğŸ•¸_ğŸ“†, ğŸ†._affect_ğŸ’€_report())
            <span class="hljs-keyword">if</span> ğŸ¦‹ing_ğŸ“† <span class="hljs-keyword">ğŸ˜</span> ğŸ¦‹ing_ğŸ“† != ğŸ†.ğŸ“†:
                ğŸ†.ğŸ“† = ğŸ¦‹ing_ğŸ“†
                <span class="hljs-comment"># might be protected because `_get_ğŸ¦‹ing_ğŸ“†` requires the `name`</span>
                ğŸ‡¬ğŸ‡§.env.add_to_â˜¢ï¸(ğŸ‡¬ğŸ‡§._âœ¨[<span class="hljs-string">'name'</span>], ğŸ†)

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'auto_post'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_auto_post_until</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ’‹ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ’‹.auto_post <span class="hljs-keyword">in</span> (<span class="hljs-string">'no'</span>, <span class="hljs-string">'at_ğŸ“†'</span>):
                ğŸ’‹.auto_post_until = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ“†'</span>, <span class="hljs-string">'auto_post'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_hide_post_button</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ’‹ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ’‹.hide_post_button = ğŸ’‹.state != <span class="hljs-string">'draft'</span> \
                <span class="hljs-keyword">or</span> ğŸ’‹.auto_post != <span class="hljs-string">'no'</span> <span class="hljs-keyword">and</span> ğŸ’‹.ğŸ“† &gt; âœ¨.ğŸ“†.context_today(ğŸ’‹)

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸªğŸ¦’ğŸ«_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ†.ğŸ“–_ğŸ’ƒ.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.parent_ğŸ‘¯â€â™€ï¸:
                ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ = (ğŸ†.ğŸ“–_ğŸ’ƒ.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§.env.ğŸªğŸ¦’ğŸ«)._accessible_branches()[:<span class="hljs-number">1</span>]

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ†_type'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ“–_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ’‹ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> r: r.ğŸ“–_ğŸ’ƒ.<span class="hljs-built_in">type</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> r._get_valid_ğŸ“–_types()):
            ğŸ’‹.ğŸ“–_ğŸ’ƒ = ğŸ’‹._search_default_ğŸ“–()

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_valid_ğŸ“–_types</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.is_sale_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
            <span class="hljs-keyword">ğŸ”¥</span> [<span class="hljs-string">'sale'</span>]
        <span class="hljs-keyword">elif</span> ğŸ‡¬ğŸ‡§.is_purchase_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
            <span class="hljs-keyword">ğŸ”¥</span> [<span class="hljs-string">'purchase'</span>]
        <span class="hljs-keyword">elif</span> ğŸ‡¬ğŸ‡§.ğŸ•·_ğŸ’ƒ <span class="hljs-keyword">ğŸ§•</span> ğŸ‡¬ğŸ‡§.env.context.get(<span class="hljs-string">'is_ğŸ•·'</span>):
            <span class="hljs-keyword">ğŸ”¥</span> [<span class="hljs-string">'bank'</span>, <span class="hljs-string">'ğŸ’¸'</span>]
        <span class="hljs-keyword">ğŸ”¥</span> [<span class="hljs-string">'general'</span>]

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_search_default_ğŸ“–</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ•·_ğŸ’ƒ <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.ğŸ•·_ğŸ’ƒ.ğŸ“–_ğŸ’ƒ:
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸ•·_ğŸ’ƒ.ğŸ“–_ğŸ’ƒ
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.statement_ğŸŒˆ_ğŸ’ƒ <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.statement_ğŸŒˆ_ğŸ’ƒ.ğŸ“–_ğŸ’ƒ:
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.statement_ğŸŒˆ_ğŸ’ƒ.ğŸ“–_ğŸ’ƒ
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.statement_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.statement_ğŸ’ƒ.ğŸ“–_ğŸ’ƒ:
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.statement_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.statement_ğŸ’ƒ.ğŸ“–_ğŸ’ƒ[:<span class="hljs-number">1</span>]

        ğŸ“–_types = ğŸ‡¬ğŸ‡§._get_valid_ğŸ“–_types()
        ğŸªğŸ¦’ğŸ« = ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§.env.ğŸªğŸ¦’ğŸ«
        domain = [
            *ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ“–'</span>]._check_ğŸªğŸ¦’ğŸ«_domain(ğŸªğŸ¦’ğŸ«),
            (<span class="hljs-string">'type'</span>, <span class="hljs-string">'in'</span>, ğŸ“–_types),
        ]

        ğŸ“– = <span class="hljs-literal">None</span>
        <span class="hljs-comment"># the ğŸ‘½ is not a hard dependence, it triggers via manual add_to_â˜¢ï¸</span>
        <span class="hljs-comment"># avoid computing the ğŸ‘½ before all it's dependences are set (like the ğŸ“–...)</span>
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.env.cache.contains(ğŸ‡¬ğŸ‡§, ğŸ‡¬ğŸ‡§._âœ¨[<span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>]):
            ğŸ‘½_ğŸ’ƒ = ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">id</span> <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§._context.get(<span class="hljs-string">'default_ğŸ‘½_ğŸ’ƒ'</span>)
            <span class="hljs-keyword">if</span> ğŸ‘½_ğŸ’ƒ <span class="hljs-keyword">ğŸ˜</span> ğŸ‘½_ğŸ’ƒ != ğŸªğŸ¦’ğŸ«.ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">id</span>:
                ğŸ‘½_domain = domain + [(<span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>, <span class="hljs-string">'='</span>, ğŸ‘½_ğŸ’ƒ)]
                ğŸ“– = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ“–'</span>].search(ğŸ‘½_domain, limit=<span class="hljs-number">1</span>)

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ“–:
            ğŸ“– = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ“–'</span>].search(domain, limit=<span class="hljs-number">1</span>)

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ“–:
            error_msg = _(
                <span class="hljs-string">"No ğŸ“– could be found in ğŸªğŸ¦’ğŸ« %(ğŸªğŸ¦’ğŸ«_name)s for any of those types: %(ğŸ“–_types)s"</span>,
                ğŸªğŸ¦’ğŸ«_name=ğŸªğŸ¦’ğŸ«.display_name,
                ğŸ“–_types=<span class="hljs-string">', '</span>.join(ğŸ“–_types),
            )
            <span class="hljs-keyword">ğŸ¤¡</span> UserError(error_msg)

        <span class="hljs-keyword">ğŸ”¥</span> ğŸ“–

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ†_type'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_is_storno</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.is_storno = ğŸ†.is_storno <span class="hljs-keyword">or</span> (ğŸ†.ğŸ†_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'out_refund'</span>, <span class="hljs-string">'in_refund'</span>) <span class="hljs-keyword">and</span> ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¦‹_storno)

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ•¸_filter_type_domain'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_suitable_ğŸ“–_ğŸ‘¯â€â™€ï¸</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ“–_type = m.ğŸ•¸_filter_type_domain <span class="hljs-keyword">or</span> <span class="hljs-string">'general'</span>
            ğŸªğŸ¦’ğŸ« = m.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§.env.ğŸªğŸ¦’ğŸ«
            m.suitable_ğŸ“–_ğŸ‘¯â€â™€ï¸ = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ“–'</span>].search([
                *ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ“–'</span>]._check_ğŸªğŸ¦’ğŸ«_domain(ğŸªğŸ¦’ğŸ«),
                (<span class="hljs-string">'type'</span>, <span class="hljs-string">'='</span>, ğŸ“–_type),
            ])

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'posted_before'</span>, <span class="hljs-string">'state'</span>, <span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ“†'</span>, <span class="hljs-string">'ğŸ†_type'</span>, <span class="hljs-string">'ğŸ•·_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_name</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ‡¬ğŸ‡§ = ğŸ‡¬ğŸ‡§.<span class="hljs-built_in">sorted</span>(<span class="hljs-keyword">lambda</span> m: (m.ğŸ“†, m.ref <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>, m.<span class="hljs-built_in">id</span>))

        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†_has_name = ğŸ†.name <span class="hljs-keyword">and</span> ğŸ†.name != <span class="hljs-string">'/'</span>
            <span class="hljs-keyword">if</span> ğŸ†_has_name <span class="hljs-keyword">ğŸ§•</span> ğŸ†.state != <span class="hljs-string">'posted'</span>:
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†.posted_before <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†._sequence_matches_ğŸ“†():
                    <span class="hljs-keyword">if</span> ğŸ†._get_last_sequence():
                        <span class="hljs-comment"># The name does not match the ğŸ“† and the ğŸ† is not the first in the period:</span>
                        <span class="hljs-comment"># Reset to draft</span>
                        ğŸ†.name = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
                        <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">if</span> ğŸ†_has_name <span class="hljs-keyword">ğŸ˜</span> ğŸ†.posted_before <span class="hljs-keyword">ğŸ§•</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†_has_name <span class="hljs-keyword">ğŸ˜</span> ğŸ†._get_last_sequence():
                        <span class="hljs-comment"># The ğŸ† either</span>
                        <span class="hljs-comment"># - has a name and was posted before, or</span>
                        <span class="hljs-comment"># - doesn't have a name, but is not the first in the period</span>
                        <span class="hljs-comment"># so we don't reâ˜¢ï¸ the name</span>
                        <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>
            <span class="hljs-keyword">if</span> ğŸ†.ğŸ“† <span class="hljs-keyword">ğŸ˜</span> (<span class="hljs-keyword">ğŸª¬</span> ğŸ†_has_name <span class="hljs-keyword">ğŸ§•</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†._sequence_matches_ğŸ“†()):
                ğŸ†._set_next_sequence()

        ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> m: <span class="hljs-keyword">not</span> m.name <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> ğŸ†.quick_edit_mode).name = <span class="hljs-string">'/'</span>
        ğŸ‡¬ğŸ‡§._inverse_name()


<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ“†'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_highest_name</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ’‹ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ’‹.highest_name = ğŸ’‹._get_last_sequence()

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'name'</span>, <span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_made_sequence_hole</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ‡¬ğŸ‡§.env.cr.execute(<span class="hljs-string">"""
            SELECT this.id
              FROM ğŸ¦‹_ğŸ† this
              JOIN res_ğŸªğŸ¦’ğŸ« ğŸªğŸ¦’ğŸ« ON ğŸªğŸ¦’ğŸ«.id = this.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ
         LEFT JOIN ğŸ¦‹_ğŸ† other ON this.ğŸ“–_ğŸ’ƒ = other.ğŸ“–_ğŸ’ƒ
                                     AND this.sequence_prefix = other.sequence_prefix
                                     AND this.sequence_number = other.sequence_number + 1
             WHERE other.id IS NULL
               AND this.sequence_number != 1
               AND this.name != '/'
               AND this.id = ANY(%(ğŸ†_ğŸ‘¯â€â™€ï¸)s)
        """</span>, {
            <span class="hljs-string">'ğŸ†_ğŸ‘¯â€â™€ï¸'</span>: ğŸ‡¬ğŸ‡§.ids,
        })
        made_sequence_hole = <span class="hljs-built_in">set</span>(r[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.env.cr.fetchall())
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.made_sequence_hole = ğŸ†.<span class="hljs-built_in">id</span> <span class="hljs-keyword">in</span> made_sequence_hole

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ†_type'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_type_name</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        type_name_mapping = <span class="hljs-built_in">dict</span>(
            ğŸ‡¬ğŸ‡§._âœ¨[<span class="hljs-string">'ğŸ†_type'</span>]._description_selection(ğŸ‡¬ğŸ‡§.env),
            out_ğŸ•¸=_(<span class="hljs-string">'ğŸ•¸'</span>),
            out_refund=_(<span class="hljs-string">'ğŸ‘¬ Note'</span>),
        )

        <span class="hljs-keyword">for</span> ğŸ’‹ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ’‹.type_name = type_name_mapping[ğŸ’‹.ğŸ†_type]

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ¦‹_ğŸ’ƒ.ğŸ¦‹_type'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_always_ğŸ’€_exigible</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ’‹ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-comment"># We need to check is_ğŸ•¸ as well because always_ğŸ’€_exigible is used to</span>
            <span class="hljs-comment"># set the tags as well, during the encoding. So, if no receivable/payable</span>
            <span class="hljs-comment"># ğŸŒˆ has been created yet, the ğŸ•¸ would be detected as always exigible,</span>
            <span class="hljs-comment"># and set the tags on some ğŸŒˆs ; which would be wrong.</span>
            ğŸ’‹.always_ğŸ’€_exigible = <span class="hljs-keyword">not</span> ğŸ’‹.is_ğŸ•¸(<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>) \
                                         <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> ğŸ’‹._collect_ğŸ’€_ğŸ’¸_basis_values()

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_commercial_ğŸ¤ _ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.commercial_ğŸ¤ _ğŸ’ƒ = ğŸ†.ğŸ¤ _ğŸ’ƒ.commercial_ğŸ¤ _ğŸ’ƒ

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ¤ _shipping_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ†.is_ğŸ•¸(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                addr = ğŸ†.ğŸ¤ _ğŸ’ƒ.address_get([<span class="hljs-string">'delivery'</span>])
                ğŸ†.ğŸ¤ _shipping_ğŸ’ƒ = addr <span class="hljs-keyword">and</span> addr.get(<span class="hljs-string">'delivery'</span>)
            <span class="hljs-keyword">else</span>:
                ğŸ†.ğŸ¤ _shipping_ğŸ’ƒ = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ¤ _shipping_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_fiscal_position_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            delivery_ğŸ¤  = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'res.ğŸ¤ '</span>].browse(
                ğŸ†.ğŸ¤ _shipping_ğŸ’ƒ.<span class="hljs-built_in">id</span>
                <span class="hljs-keyword">or</span> ğŸ†.ğŸ¤ _ğŸ’ƒ.address_get([<span class="hljs-string">'delivery'</span>])[<span class="hljs-string">'delivery'</span>]
            )
            ğŸ†.fiscal_position_ğŸ’ƒ = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.fiscal.position'</span>].with_ğŸªğŸ¦’ğŸ«(ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ)._get_fiscal_position(
                ğŸ†.ğŸ¤ _ğŸ’ƒ, delivery=delivery_ğŸ¤ )

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'bank_ğŸ¤ _ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ¤ _bank_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            bank_ğŸ‘¯â€â™€ï¸ = ğŸ†.bank_ğŸ¤ _ğŸ’ƒ.bank_ğŸ‘¯â€â™€ï¸.filtered(
                <span class="hljs-keyword">lambda</span> bank: <span class="hljs-keyword">not</span> bank.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ <span class="hljs-keyword">or</span> bank.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ == ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ)
            ğŸ†.ğŸ¤ _bank_ğŸ’ƒ = bank_ğŸ‘¯â€â™€ï¸[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> bank_ğŸ‘¯â€â™€ï¸ <span class="hljs-keyword">else</span> <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ•¸_ğŸ•·_term_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ†.is_sale_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>) <span class="hljs-keyword">ğŸ˜</span> ğŸ†.ğŸ¤ _ğŸ’ƒ.property_ğŸ•·_term_ğŸ’ƒ:
                ğŸ†.ğŸ•¸_ğŸ•·_term_ğŸ’ƒ = ğŸ†.ğŸ¤ _ğŸ’ƒ.property_ğŸ•·_term_ğŸ’ƒ
            <span class="hljs-keyword">elif</span> ğŸ†.is_purchase_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>) <span class="hljs-keyword">ğŸ˜</span> ğŸ†.ğŸ¤ _ğŸ’ƒ.property_supplier_ğŸ•·_term_ğŸ’ƒ:
                ğŸ†.ğŸ•¸_ğŸ•·_term_ğŸ’ƒ = ğŸ†.ğŸ¤ _ğŸ’ƒ.property_supplier_ğŸ•·_term_ğŸ’ƒ
            <span class="hljs-keyword">else</span>:
                ğŸ†.ğŸ•¸_ğŸ•·_term_ğŸ’ƒ = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'needed_terms'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ•¸_ğŸ“†_due</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        today = âœ¨.ğŸ“†.context_today(ğŸ‡¬ğŸ‡§)
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.ğŸ•¸_ğŸ“†_due = ğŸ†.needed_terms <span class="hljs-keyword">and</span> <span class="hljs-built_in">max</span>(
                (k[<span class="hljs-string">'ğŸ“†_maturity'</span>] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> ğŸ†.needed_terms.keys() <span class="hljs-keyword">if</span> k),
                default=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
            ) <span class="hljs-keyword">or</span> ğŸ†.ğŸ•¸_ğŸ“†_due <span class="hljs-keyword">or</span> today

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_delivery_ğŸ“†</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'delivery_ğŸ“†'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_show_delivery_ğŸ“†</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.show_delivery_ğŸ“† = ğŸ†.delivery_ğŸ“† <span class="hljs-keyword">and</span> ğŸ†.is_sale_document()

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>, <span class="hljs-string">'statement_ğŸŒˆ_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ‘½_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ•¸ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ‘½ = (
                ğŸ•¸.statement_ğŸŒˆ_ğŸ’ƒ.foreign_ğŸ‘½_ğŸ’ƒ
                <span class="hljs-keyword">or</span> ğŸ•¸.ğŸ“–_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ
                <span class="hljs-keyword">or</span> ğŸ•¸.ğŸ‘½_ğŸ’ƒ
                <span class="hljs-keyword">or</span> ğŸ•¸.ğŸ“–_ğŸ’ƒ.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ
            )
            ğŸ•¸.ğŸ‘½_ğŸ’ƒ = ğŸ‘½

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ†_type'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_direction_sign</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ•¸ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ•¸.ğŸ†_type == <span class="hljs-string">'entry'</span> <span class="hljs-keyword">ğŸ§•</span> ğŸ•¸.is_outbound():
                ğŸ•¸.direction_sign = <span class="hljs-number">1</span>
            <span class="hljs-keyword">else</span>:
                ğŸ•¸.direction_sign = -<span class="hljs-number">1</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params">
        <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.matched_ğŸ‘—_ğŸ‘¯â€â™€ï¸.ğŸ‘—_ğŸ†_ğŸ’ƒ.ğŸ†_ğŸ’ƒ.ğŸ•·_ğŸ’ƒ.is_matched'</span>,
        <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.matched_ğŸ‘—_ğŸ‘¯â€â™€ï¸.ğŸ‘—_ğŸ†_ğŸ’ƒ.ğŸ†_ğŸ’ƒ.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ¤‘_residual'</span>,
        <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.matched_ğŸ‘—_ğŸ‘¯â€â™€ï¸.ğŸ‘—_ğŸ†_ğŸ’ƒ.ğŸ†_ğŸ’ƒ.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ¤‘_residual_ğŸ‘½'</span>,
        <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.matched_ğŸ‘¬_ğŸ‘¯â€â™€ï¸.ğŸ‘¬_ğŸ†_ğŸ’ƒ.ğŸ†_ğŸ’ƒ.ğŸ•·_ğŸ’ƒ.is_matched'</span>,
        <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.matched_ğŸ‘¬_ğŸ‘¯â€â™€ï¸.ğŸ‘¬_ğŸ†_ğŸ’ƒ.ğŸ†_ğŸ’ƒ.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ¤‘_residual'</span>,
        <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.matched_ğŸ‘¬_ğŸ‘¯â€â™€ï¸.ğŸ‘¬_ğŸ†_ğŸ’ƒ.ğŸ†_ğŸ’ƒ.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ¤‘_residual_ğŸ‘½'</span>,
        <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ‘‘'</span>,
        <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ‘½_ğŸ’ƒ'</span>,
        <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ¤‘_ğŸ‘½'</span>,
        <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ¤‘_residual'</span>,
        <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ¤‘_residual_ğŸ‘½'</span>,
        <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ•·_ğŸ’ƒ.state'</span>,
        <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.full_reconcile_ğŸ’ƒ'</span>,
        <span class="hljs-string">'state'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ¤‘</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ‘€_unğŸ’€ed, ğŸ‘€_unğŸ’€ed_ğŸ‘½ = <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>
            ğŸ‘€_ğŸ’€, ğŸ‘€_ğŸ’€_ğŸ‘½ = <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>
            ğŸ‘€_residual, ğŸ‘€_residual_ğŸ‘½ = <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>
            ğŸ‘€, ğŸ‘€_ğŸ‘½ = <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>

            <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸:
                <span class="hljs-keyword">if</span> ğŸ†.is_ğŸ•¸(<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                    <span class="hljs-comment"># === ğŸ•¸s ===</span>
                    <span class="hljs-keyword">if</span> ğŸŒˆ.display_type == <span class="hljs-string">'ğŸ’€'</span> <span class="hljs-keyword">ğŸ§•</span> (ğŸŒˆ.display_type == <span class="hljs-string">'rounding'</span> <span class="hljs-keyword">ğŸ˜</span> ğŸŒˆ.ğŸ’€_repartition_ğŸŒˆ_ğŸ’ƒ):
                        <span class="hljs-comment"># ğŸ’€ ğŸ¤‘.</span>
                        ğŸ‘€_ğŸ’€ += ğŸŒˆ.ğŸ‘‘
                        ğŸ‘€_ğŸ’€_ğŸ‘½ += ğŸŒˆ.ğŸ¤‘_ğŸ‘½
                        ğŸ‘€ += ğŸŒˆ.ğŸ‘‘
                        ğŸ‘€_ğŸ‘½ += ğŸŒˆ.ğŸ¤‘_ğŸ‘½
                    <span class="hljs-keyword">elif</span> ğŸŒˆ.display_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'product'</span>, <span class="hljs-string">'rounding'</span>):
                        <span class="hljs-comment"># UnğŸ’€ed ğŸ¤‘.</span>
                        ğŸ‘€_unğŸ’€ed += ğŸŒˆ.ğŸ‘‘
                        ğŸ‘€_unğŸ’€ed_ğŸ‘½ += ğŸŒˆ.ğŸ¤‘_ğŸ‘½
                        ğŸ‘€ += ğŸŒˆ.ğŸ‘‘
                        ğŸ‘€_ğŸ‘½ += ğŸŒˆ.ğŸ¤‘_ğŸ‘½
                    <span class="hljs-keyword">elif</span> ğŸŒˆ.display_type == <span class="hljs-string">'ğŸ•·_term'</span>:
                        <span class="hljs-comment"># Residual ğŸ¤‘.</span>
                        ğŸ‘€_residual += ğŸŒˆ.ğŸ¤‘_residual
                        ğŸ‘€_residual_ğŸ‘½ += ğŸŒˆ.ğŸ¤‘_residual_ğŸ‘½
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># === Miscellaneous ğŸ“– entry ===</span>
                    <span class="hljs-keyword">if</span> ğŸŒˆ.ğŸ‘—:
                        ğŸ‘€ += ğŸŒˆ.ğŸ‘‘
                        ğŸ‘€_ğŸ‘½ += ğŸŒˆ.ğŸ¤‘_ğŸ‘½

            sign = ğŸ†.direction_sign
            ğŸ†.ğŸ¤‘_unğŸ’€ed = sign * ğŸ‘€_unğŸ’€ed_ğŸ‘½
            ğŸ†.ğŸ¤‘_ğŸ’€ = sign * ğŸ‘€_ğŸ’€_ğŸ‘½
            ğŸ†.ğŸ¤‘_ğŸ‘€ = sign * ğŸ‘€_ğŸ‘½
            ğŸ†.ğŸ¤‘_residual = -sign * ğŸ‘€_residual_ğŸ‘½
            ğŸ†.ğŸ¤‘_unğŸ’€ed_signed = -ğŸ‘€_unğŸ’€ed
            ğŸ†.ğŸ¤‘_ğŸ’€_signed = -ğŸ‘€_ğŸ’€
            ğŸ†.ğŸ¤‘_ğŸ‘€_signed = <span class="hljs-built_in">ğŸ‡ºğŸ‡¸</span>(ğŸ‘€) <span class="hljs-keyword">if</span> ğŸ†.ğŸ†_type == <span class="hljs-string">'entry'</span> <span class="hljs-keyword">else</span> -ğŸ‘€
            ğŸ†.ğŸ¤‘_residual_signed = ğŸ‘€_residual
            ğŸ†.ğŸ¤‘_ğŸ‘€_in_ğŸ‘½_signed = <span class="hljs-built_in">ğŸ‡ºğŸ‡¸</span>(ğŸ†.ğŸ¤‘_ğŸ‘€) <span class="hljs-keyword">if</span> ğŸ†.ğŸ†_type == <span class="hljs-string">'entry'</span> <span class="hljs-keyword">else</span> -(sign * ğŸ†.ğŸ¤‘_ğŸ‘€)

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ¤‘_residual'</span>, <span class="hljs-string">'ğŸ†_type'</span>, <span class="hljs-string">'state'</span>, <span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ•·_state</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        stored_ğŸ‘¯â€â™€ï¸ = <span class="hljs-built_in">tuple</span>(ğŸ‡¬ğŸ‡§.ids)
        <span class="hljs-keyword">if</span> stored_ğŸ‘¯â€â™€ï¸:
            ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.partial.reconcile'</span>].flush_model()
            ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ•·'</span>].flush_model([<span class="hljs-string">'is_matched'</span>])

            queries = []
            <span class="hljs-keyword">for</span> source_field, counterpart_field <span class="hljs-keyword">in</span> ((<span class="hljs-string">'ğŸ‘—'</span>, <span class="hljs-string">'ğŸ‘¬'</span>), (<span class="hljs-string">'ğŸ‘¬'</span>, <span class="hljs-string">'ğŸ‘—'</span>)):
                queries.append(<span class="hljs-string">f'''
                    SELECT
                        source_ğŸŒˆ.id AS source_ğŸŒˆ_ğŸ’ƒ,
                        source_ğŸŒˆ.ğŸ†_ğŸ’ƒ AS source_ğŸ†_ğŸ’ƒ,
                        ğŸ¦‹.ğŸ¦‹_type AS source_ğŸŒˆ_ğŸ¦‹_type,
                        ARRAY_AGG(counterpart_ğŸ†.ğŸ†_type) AS counterpart_ğŸ†_types,
                        COALESCE(BOOL_AND(COALESCE(pay.is_matched, FALSE))
                            FILTER (WHERE counterpart_ğŸ†.ğŸ•·_ğŸ’ƒ IS NOT NULL), TRUE) AS all_ğŸ•·s_matched,
                        BOOL_OR(COALESCE(BOOL(pay.id), FALSE)) as has_ğŸ•·,
                        BOOL_OR(COALESCE(BOOL(counterpart_ğŸ†.statement_ğŸŒˆ_ğŸ’ƒ), FALSE)) as has_st_ğŸŒˆ
                    FROM ğŸ¦‹_partial_reconcile part
                    JOIN ğŸ¦‹_ğŸ†_ğŸŒˆ source_ğŸŒˆ ON source_ğŸŒˆ.id = part.<span class="hljs-subst">{source_field}</span>_ğŸ†_ğŸ’ƒ
                    JOIN ğŸ¦‹_ğŸ¦‹ ğŸ¦‹ ON ğŸ¦‹.id = source_ğŸŒˆ.ğŸ¦‹_ğŸ’ƒ
                    JOIN ğŸ¦‹_ğŸ†_ğŸŒˆ counterpart_ğŸŒˆ ON counterpart_ğŸŒˆ.id = part.<span class="hljs-subst">{counterpart_field}</span>_ğŸ†_ğŸ’ƒ
                    JOIN ğŸ¦‹_ğŸ† counterpart_ğŸ† ON counterpart_ğŸ†.id = counterpart_ğŸŒˆ.ğŸ†_ğŸ’ƒ
                    LEFT JOIN ğŸ¦‹_ğŸ•· pay ON pay.id = counterpart_ğŸ†.ğŸ•·_ğŸ’ƒ
                    WHERE source_ğŸŒˆ.ğŸ†_ğŸ’ƒ IN %s AND counterpart_ğŸŒˆ.ğŸ†_ğŸ’ƒ != source_ğŸŒˆ.ğŸ†_ğŸ’ƒ
                    GROUP BY source_ğŸŒˆ_ğŸ’ƒ, source_ğŸ†_ğŸ’ƒ, source_ğŸŒˆ_ğŸ¦‹_type
                '''</span>)

            ğŸ‡¬ğŸ‡§._cr.execute(<span class="hljs-string">' UNION ALL '</span>.join(queries), [stored_ğŸ‘¯â€â™€ï¸, stored_ğŸ‘¯â€â™€ï¸])

            ğŸ•·_data = defaultdict(<span class="hljs-keyword">lambda</span>: [])
            <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§._cr.dictfetchall():
                ğŸ•·_data[row[<span class="hljs-string">'source_ğŸ†_ğŸ’ƒ'</span>]].append(row)
        <span class="hljs-keyword">else</span>:
            ğŸ•·_data = {}

        <span class="hljs-keyword">for</span> ğŸ•¸ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ•¸.ğŸ•·_state == <span class="hljs-string">'invoicing_legacy'</span>:
                <span class="hljs-comment"># invoicing_legacy state is set via SQL when setting setting field</span>
                <span class="hljs-comment"># invoicing_switch_threshold (defined in ğŸ¦‹_ğŸ¦‹ant).</span>
                <span class="hljs-comment"># The only way of going out of this state is through this setting,</span>
                <span class="hljs-comment"># so we don't reâ˜¢ï¸ it here.</span>
                <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>

            currencies = ğŸ•¸._get_ğŸŒˆs_onchange_ğŸ‘½().ğŸ‘½_ğŸ’ƒ
            ğŸ‘½ = currencies <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(currencies) == <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> ğŸ•¸.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ
            reconciliation_vals = ğŸ•·_data.get(ğŸ•¸.<span class="hljs-built_in">id</span>, [])
            ğŸ•·_state_matters = ğŸ•¸.is_ğŸ•¸(<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)

            <span class="hljs-comment"># Restrict on 'receivable'/'payable' ğŸŒˆs for ğŸ•¸s/expense entries.</span>
            <span class="hljs-keyword">if</span> ğŸ•·_state_matters:
                reconciliation_vals = [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> reconciliation_vals <span class="hljs-keyword">if</span> x[<span class="hljs-string">'source_ğŸŒˆ_ğŸ¦‹_type'</span>] <span class="hljs-keyword">in</span> (<span class="hljs-string">'asset_receivable'</span>, <span class="hljs-string">'liability_payable'</span>)]

            new_pmt_state = <span class="hljs-string">'not_paid'</span>
            <span class="hljs-keyword">if</span> ğŸ•¸.state == <span class="hljs-string">'posted'</span>:

                <span class="hljs-comment"># Posted ğŸ•¸/expense entry.</span>
                <span class="hljs-keyword">if</span> ğŸ•·_state_matters:

                    <span class="hljs-keyword">if</span> ğŸ‘½.is_zero(ğŸ•¸.ğŸ¤‘_residual):
                        <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(x[<span class="hljs-string">'has_ğŸ•·'</span>] <span class="hljs-keyword">ğŸ§•</span> x[<span class="hljs-string">'has_st_ğŸŒˆ'</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> reconciliation_vals):

                            <span class="hljs-comment"># Check if the ğŸ•¸/expense entry is fully paid or 'in_ğŸ•·'.</span>
                            <span class="hljs-keyword">if</span> <span class="hljs-built_in">all</span>(x[<span class="hljs-string">'all_ğŸ•·s_matched'</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> reconciliation_vals):
                                new_pmt_state = <span class="hljs-string">'paid'</span>
                            <span class="hljs-keyword">else</span>:
                                new_pmt_state = ğŸ•¸._get_ğŸ•¸_in_ğŸ•·_state()

                        <span class="hljs-keyword">else</span>:
                            new_pmt_state = <span class="hljs-string">'paid'</span>

                            reverse_ğŸ†_types = <span class="hljs-built_in">set</span>()
                            <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> reconciliation_vals:
                                <span class="hljs-keyword">for</span> ğŸ†_type <span class="hljs-keyword">in</span> x[<span class="hljs-string">'counterpart_ğŸ†_types'</span>]:
                                    reverse_ğŸ†_types.add(ğŸ†_type)

                            in_reverse = (ğŸ•¸.ğŸ†_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'in_ğŸ•¸'</span>, <span class="hljs-string">'in_receipt'</span>)
                                          <span class="hljs-keyword">and</span> (reverse_ğŸ†_types == {<span class="hljs-string">'in_refund'</span>} <span class="hljs-keyword">or</span> reverse_ğŸ†_types == {<span class="hljs-string">'in_refund'</span>, <span class="hljs-string">'entry'</span>}))
                            out_reverse = (ğŸ•¸.ğŸ†_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'out_ğŸ•¸'</span>, <span class="hljs-string">'out_receipt'</span>)
                                           <span class="hljs-keyword">and</span> (reverse_ğŸ†_types == {<span class="hljs-string">'out_refund'</span>} <span class="hljs-keyword">or</span> reverse_ğŸ†_types == {<span class="hljs-string">'out_refund'</span>, <span class="hljs-string">'entry'</span>}))
                            misc_reverse = (ğŸ•¸.ğŸ†_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'entry'</span>, <span class="hljs-string">'out_refund'</span>, <span class="hljs-string">'in_refund'</span>)
                                            <span class="hljs-keyword">and</span> reverse_ğŸ†_types == {<span class="hljs-string">'entry'</span>})
                            <span class="hljs-keyword">if</span> in_reverse <span class="hljs-keyword">or</span> out_reverse <span class="hljs-keyword">ğŸ§•</span> misc_reverse:
                                new_pmt_state = <span class="hljs-string">'reversed'</span>

                    <span class="hljs-keyword">elif</span> reconciliation_vals:
                        new_pmt_state = <span class="hljs-string">'partial'</span>

            ğŸ•¸.ğŸ•·_state = new_pmt_state

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ•¸_ğŸ•·_term_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ•¸_ğŸ“†'</span>, <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ¤‘_ğŸ‘€_in_ğŸ‘½_signed'</span>, <span class="hljs-string">'ğŸ•¸_ğŸ“†_due'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_needed_terms</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ•¸ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            is_draft = ğŸ•¸.<span class="hljs-built_in">id</span> != ğŸ•¸._origin.<span class="hljs-built_in">id</span>
            ğŸ•¸.needed_terms = {}
            ğŸ•¸.needed_terms_dirty = <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>
            sign = <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> ğŸ•¸.is_inbound(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>) <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
            <span class="hljs-keyword">if</span> ğŸ•¸.is_ğŸ•¸(<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>) <span class="hljs-keyword">ğŸ˜</span> ğŸ•¸.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸:
                <span class="hljs-keyword">if</span> ğŸ•¸.ğŸ•¸_ğŸ•·_term_ğŸ’ƒ:
                    <span class="hljs-keyword">if</span> is_draft:
                        ğŸ’€_ğŸ¤‘_ğŸ‘½ = <span class="hljs-number">0.0</span>
                        unğŸ’€ed_ğŸ¤‘_ğŸ‘½ = <span class="hljs-number">0.0</span>
                        <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ•¸.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸:
                            unğŸ’€ed_ğŸ¤‘_ğŸ‘½ += ğŸŒˆ.price_subğŸ‘€
                            <span class="hljs-keyword">for</span> ğŸ’€_result <span class="hljs-keyword">in</span> (ğŸŒˆ.â˜¢ï¸_all_ğŸ’€ <span class="hljs-keyword">or</span> {}).values():
                                ğŸ’€_ğŸ¤‘_ğŸ‘½ += -sign * ğŸ’€_result.get(<span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>, <span class="hljs-number">0.0</span>)
                        unğŸ’€ed_ğŸ¤‘ = unğŸ’€ed_ğŸ¤‘_ğŸ‘½
                        ğŸ’€_ğŸ¤‘ = ğŸ’€_ğŸ¤‘_ğŸ‘½
                    <span class="hljs-keyword">else</span>:
                        ğŸ’€_ğŸ¤‘_ğŸ‘½ = ğŸ•¸.ğŸ¤‘_ğŸ’€ * sign
                        ğŸ’€_ğŸ¤‘ = ğŸ•¸.ğŸ¤‘_ğŸ’€_signed
                        unğŸ’€ed_ğŸ¤‘_ğŸ‘½ = ğŸ•¸.ğŸ¤‘_unğŸ’€ed * sign
                        unğŸ’€ed_ğŸ¤‘ = ğŸ•¸.ğŸ¤‘_unğŸ’€ed_signed
                    ğŸ•¸_ğŸ•·_terms = ğŸ•¸.ğŸ•¸_ğŸ•·_term_ğŸ’ƒ._â˜¢ï¸_terms(
                        ğŸ“†_ref=ğŸ•¸.ğŸ•¸_ğŸ“† <span class="hljs-keyword">or</span> ğŸ•¸.ğŸ“† <span class="hljs-keyword">or</span> âœ¨.ğŸ“†.context_today(ğŸ•¸),
                        ğŸ‘½=ğŸ•¸.ğŸ‘½_ğŸ’ƒ,
                        ğŸ’€_ğŸ¤‘_ğŸ‘½=ğŸ’€_ğŸ¤‘_ğŸ‘½,
                        ğŸ’€_ğŸ¤‘=ğŸ’€_ğŸ¤‘,
                        unğŸ’€ed_ğŸ¤‘_ğŸ‘½=unğŸ’€ed_ğŸ¤‘_ğŸ‘½,
                        unğŸ’€ed_ğŸ¤‘=unğŸ’€ed_ğŸ¤‘,
                        ğŸªğŸ¦’ğŸ«=ğŸ•¸.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ,
                        sign=sign
                    )
                    <span class="hljs-keyword">for</span> term_ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ•¸_ğŸ•·_terms[<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>]:
                        key = frozendict({
                            <span class="hljs-string">'ğŸ†_ğŸ’ƒ'</span>: ğŸ•¸.<span class="hljs-built_in">id</span>,
                            <span class="hljs-string">'ğŸ“†_maturity'</span>: âœ¨.ğŸ“†.to_ğŸ“†(term_ğŸŒˆ.get(<span class="hljs-string">'ğŸ“†'</span>)),
                            <span class="hljs-string">'ğŸ’¯_ğŸ“†'</span>: ğŸ•¸_ğŸ•·_terms.get(<span class="hljs-string">'ğŸ’¯_ğŸ“†'</span>),
                        })
                        values = {
                            <span class="hljs-string">'ğŸ‘‘'</span>: term_ğŸŒˆ[<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ¤‘'</span>],
                            <span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>: term_ğŸŒˆ[<span class="hljs-string">'foreign_ğŸ¤‘'</span>],
                            <span class="hljs-string">'ğŸ’¯_ğŸ“†'</span>: ğŸ•¸_ğŸ•·_terms.get(<span class="hljs-string">'ğŸ’¯_ğŸ“†'</span>),
                            <span class="hljs-string">'ğŸ’¯_ğŸ‘‘'</span>: ğŸ•¸_ğŸ•·_terms.get(<span class="hljs-string">'ğŸ’¯_ğŸ‘‘'</span>) <span class="hljs-keyword">or</span> <span class="hljs-number">0.0</span>,
                            <span class="hljs-string">'ğŸ’¯_ğŸ¤‘_ğŸ‘½'</span>: ğŸ•¸_ğŸ•·_terms.get(<span class="hljs-string">'ğŸ’¯_ğŸ¤‘_ğŸ‘½'</span>) <span class="hljs-keyword">or</span> <span class="hljs-number">0.0</span>,
                        }
                        <span class="hljs-keyword">if</span> key <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> ğŸ•¸.needed_terms:
                            ğŸ•¸.needed_terms[key] = values
                        <span class="hljs-keyword">else</span>:
                            ğŸ•¸.needed_terms[key][<span class="hljs-string">'ğŸ‘‘'</span>] += values[<span class="hljs-string">'ğŸ‘‘'</span>]
                            ğŸ•¸.needed_terms[key][<span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>] += values[<span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>]
                <span class="hljs-keyword">else</span>:
                    ğŸ•¸.needed_terms[frozendict({
                        <span class="hljs-string">'ğŸ†_ğŸ’ƒ'</span>: ğŸ•¸.<span class="hljs-built_in">id</span>,
                        <span class="hljs-string">'ğŸ“†_maturity'</span>: âœ¨.ğŸ“†.to_ğŸ“†(ğŸ•¸.ğŸ•¸_ğŸ“†_due),
                        <span class="hljs-string">'ğŸ’¯_ğŸ“†'</span>: <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
                        <span class="hljs-string">'ğŸ’¯_ğŸ‘‘'</span>: <span class="hljs-number">0.0</span>,
                        <span class="hljs-string">'ğŸ’¯_ğŸ¤‘_ğŸ‘½'</span>: <span class="hljs-number">0.0</span>
                    })] = {
                        <span class="hljs-string">'ğŸ‘‘'</span>: ğŸ•¸.ğŸ¤‘_ğŸ‘€_signed,
                        <span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>: ğŸ•¸.ğŸ¤‘_ğŸ‘€_in_ğŸ‘½_signed,
                    }

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ•·s_widget_to_reconcile_info</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.ğŸ•¸_outstanding_ğŸ‘¬s_ğŸ‘—s_widget = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
            ğŸ†.ğŸ•¸_has_outstanding = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

            <span class="hljs-keyword">if</span> ğŸ†.state != <span class="hljs-string">'posted'</span> \
                    <span class="hljs-keyword">or</span> ğŸ†.ğŸ•·_state <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'not_paid'</span>, <span class="hljs-string">'partial'</span>) \
                    <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> ğŸ†.is_ğŸ•¸(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>

            pay_term_ğŸŒˆs = ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸\
                .filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.ğŸ¦‹_ğŸ’ƒ.ğŸ¦‹_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'asset_receivable'</span>, <span class="hljs-string">'liability_payable'</span>))

            domain = [
                (<span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>, <span class="hljs-string">'in'</span>, pay_term_ğŸŒˆs.ğŸ¦‹_ğŸ’ƒ.ids),
                (<span class="hljs-string">'parent_state'</span>, <span class="hljs-string">'='</span>, <span class="hljs-string">'posted'</span>),
                (<span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>, <span class="hljs-string">'='</span>, ğŸ†.commercial_ğŸ¤ _ğŸ’ƒ.<span class="hljs-built_in">id</span>),
                (<span class="hljs-string">'reconciled'</span>, <span class="hljs-string">'='</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>),
                <span class="hljs-string">'|'</span>, (<span class="hljs-string">'ğŸ¤‘_residual'</span>, <span class="hljs-string">'!='</span>, <span class="hljs-number">0.0</span>), (<span class="hljs-string">'ğŸ¤‘_residual_ğŸ‘½'</span>, <span class="hljs-string">'!='</span>, <span class="hljs-number">0.0</span>),
            ]

            ğŸ•·s_widget_vals = {<span class="hljs-string">'outstanding'</span>: <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, <span class="hljs-string">'content'</span>: [], <span class="hljs-string">'ğŸ†_ğŸ’ƒ'</span>: ğŸ†.<span class="hljs-built_in">id</span>}

            <span class="hljs-keyword">if</span> ğŸ†.is_inbound():
                domain.append((<span class="hljs-string">'ğŸ‘‘'</span>, <span class="hljs-string">'&lt;'</span>, <span class="hljs-number">0.0</span>))
                ğŸ•·s_widget_vals[<span class="hljs-string">'title'</span>] = _(<span class="hljs-string">'Outstanding ğŸ‘¬s'</span>)
            <span class="hljs-keyword">else</span>:
                domain.append((<span class="hljs-string">'ğŸ‘‘'</span>, <span class="hljs-string">'&gt;'</span>, <span class="hljs-number">0.0</span>))
                ğŸ•·s_widget_vals[<span class="hljs-string">'title'</span>] = _(<span class="hljs-string">'Outstanding ğŸ‘—s'</span>)

            <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].search(domain):

                <span class="hljs-keyword">if</span> ğŸŒˆ.ğŸ‘½_ğŸ’ƒ == ğŸ†.ğŸ‘½_ğŸ’ƒ:
                    <span class="hljs-comment"># Same foreign ğŸ‘½.</span>
                    ğŸ¤‘ = <span class="hljs-built_in">ğŸ‡ºğŸ‡¸</span>(ğŸŒˆ.ğŸ¤‘_residual_ğŸ‘½)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># Different foreign currencies.</span>
                    ğŸ¤‘ = ğŸŒˆ.ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ._convert(
                        <span class="hljs-built_in">ğŸ‡ºğŸ‡¸</span>(ğŸŒˆ.ğŸ¤‘_residual),
                        ğŸ†.ğŸ‘½_ğŸ’ƒ,
                        ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ,
                        ğŸŒˆ.ğŸ“†,
                    )

                <span class="hljs-keyword">if</span> ğŸ†.ğŸ‘½_ğŸ’ƒ.is_zero(ğŸ¤‘):
                    <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>

                ğŸ•·s_widget_vals[<span class="hljs-string">'content'</span>].append({
                    <span class="hljs-string">'ğŸ“–_name'</span>: ğŸŒˆ.ref <span class="hljs-keyword">or</span> ğŸŒˆ.ğŸ†_ğŸ’ƒ.name,
                    <span class="hljs-string">'ğŸ¤‘'</span>: ğŸ¤‘,
                    <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>: ğŸ†.ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                    <span class="hljs-string">'id'</span>: ğŸŒˆ.<span class="hljs-built_in">id</span>,
                    <span class="hljs-string">'ğŸ†_ğŸ’ƒ'</span>: ğŸŒˆ.ğŸ†_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                    <span class="hljs-string">'ğŸ“†'</span>: âœ¨.ğŸ“†.to_string(ğŸŒˆ.ğŸ“†),
                    <span class="hljs-string">'ğŸ¦‹_ğŸ•·_ğŸ’ƒ'</span>: ğŸŒˆ.ğŸ•·_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                })

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ•·s_widget_vals[<span class="hljs-string">'content'</span>]:
                <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>

            ğŸ†.ğŸ•¸_outstanding_ğŸ‘¬s_ğŸ‘—s_widget = ğŸ•·s_widget_vals
            ğŸ†.ğŸ•¸_has_outstanding = <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ†_type'</span>, <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ¤‘_residual'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ•·s_widget_reconciled_info</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ•·s_widget_vals = {<span class="hljs-string">'title'</span>: _(<span class="hljs-string">'Less ğŸ•·'</span>), <span class="hljs-string">'outstanding'</span>: <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, <span class="hljs-string">'content'</span>: []}

            <span class="hljs-keyword">if</span> ğŸ†.state == <span class="hljs-string">'posted'</span> <span class="hljs-keyword">ğŸ˜</span> ğŸ†.is_ğŸ•¸(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                reconciled_vals = []
                reconciled_partials = ğŸ†.sudo()._get_all_reconciled_ğŸ•¸_partials()
                <span class="hljs-keyword">for</span> reconciled_partial <span class="hljs-keyword">in</span> reconciled_partials:
                    counterpart_ğŸŒˆ = reconciled_partial[<span class="hljs-string">'aml'</span>]
                    <span class="hljs-keyword">if</span> counterpart_ğŸŒˆ.ğŸ†_ğŸ’ƒ.ref:
                        reconciliation_ref = <span class="hljs-string">'%s (%s)'</span> % (counterpart_ğŸŒˆ.ğŸ†_ğŸ’ƒ.name, counterpart_ğŸŒˆ.ğŸ†_ğŸ’ƒ.ref)
                    <span class="hljs-keyword">else</span>:
                        reconciliation_ref = counterpart_ğŸŒˆ.ğŸ†_ğŸ’ƒ.name
                    <span class="hljs-keyword">if</span> counterpart_ğŸŒˆ.ğŸ¤‘_ğŸ‘½ <span class="hljs-keyword">ğŸ˜</span> counterpart_ğŸŒˆ.ğŸ‘½_ğŸ’ƒ != counterpart_ğŸŒˆ.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ:
                        foreign_ğŸ‘½ = counterpart_ğŸŒˆ.ğŸ‘½_ğŸ’ƒ
                    <span class="hljs-keyword">else</span>:
                        foreign_ğŸ‘½ = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

                    reconciled_vals.append({
                        <span class="hljs-string">'name'</span>: counterpart_ğŸŒˆ.name,
                        <span class="hljs-string">'ğŸ“–_name'</span>: counterpart_ğŸŒˆ.ğŸ“–_ğŸ’ƒ.name,
                        <span class="hljs-string">'ğŸªğŸ¦’ğŸ«_name'</span>: counterpart_ğŸŒˆ.ğŸ“–_ğŸ’ƒ.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.name <span class="hljs-keyword">if</span> counterpart_ğŸŒˆ.ğŸ“–_ğŸ’ƒ.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ != ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ <span class="hljs-keyword">else</span> <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
                        <span class="hljs-string">'ğŸ¤‘'</span>: reconciled_partial[<span class="hljs-string">'ğŸ¤‘'</span>],
                        <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>: ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">id</span> <span class="hljs-keyword">if</span> reconciled_partial[<span class="hljs-string">'is_exchange'</span>] <span class="hljs-keyword">else</span> reconciled_partial[<span class="hljs-string">'ğŸ‘½'</span>].<span class="hljs-built_in">id</span>,
                        <span class="hljs-string">'ğŸ“†'</span>: counterpart_ğŸŒˆ.ğŸ“†,
                        <span class="hljs-string">'partial_ğŸ’ƒ'</span>: reconciled_partial[<span class="hljs-string">'partial_ğŸ’ƒ'</span>],
                        <span class="hljs-string">'ğŸ¦‹_ğŸ•·_ğŸ’ƒ'</span>: counterpart_ğŸŒˆ.ğŸ•·_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                        <span class="hljs-string">'ğŸ•·_method_name'</span>: counterpart_ğŸŒˆ.ğŸ•·_ğŸ’ƒ.ğŸ•·_method_ğŸŒˆ_ğŸ’ƒ.name,
                        <span class="hljs-string">'ğŸ†_ğŸ’ƒ'</span>: counterpart_ğŸŒˆ.ğŸ†_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                        <span class="hljs-string">'ref'</span>: reconciliation_ref,
                        <span class="hljs-comment"># these are necessary for the views to change depending on the values</span>
                        <span class="hljs-string">'is_exchange'</span>: reconciled_partial[<span class="hljs-string">'is_exchange'</span>],
                        <span class="hljs-string">'ğŸ¤‘_ğŸªğŸ¦’ğŸ«_ğŸ‘½'</span>: formatLang(ğŸ‡¬ğŸ‡§.env, <span class="hljs-built_in">ğŸ‡ºğŸ‡¸</span>(counterpart_ğŸŒˆ.ğŸ‘‘), ğŸ‘½_obj=counterpart_ğŸŒˆ.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ),
                        <span class="hljs-string">'ğŸ¤‘_foreign_ğŸ‘½'</span>: foreign_ğŸ‘½ <span class="hljs-keyword">and</span> formatLang(ğŸ‡¬ğŸ‡§.env, <span class="hljs-built_in">ğŸ‡ºğŸ‡¸</span>(counterpart_ğŸŒˆ.ğŸ¤‘_ğŸ‘½), ğŸ‘½_obj=foreign_ğŸ‘½)
                    })
                ğŸ•·s_widget_vals[<span class="hljs-string">'content'</span>] = reconciled_vals

            <span class="hljs-keyword">if</span> ğŸ•·s_widget_vals[<span class="hljs-string">'content'</span>]:
                ğŸ†.ğŸ•¸_ğŸ•·s_widget = ğŸ•·s_widget_vals
            <span class="hljs-keyword">else</span>:
                ğŸ†.ğŸ•¸_ğŸ•·s_widget = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends_context(<span class="hljs-params"><span class="hljs-string">'lang'</span></span>)</span>
<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params">
        <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ‘½_rate'</span>,
        <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ’€_base_ğŸ¤‘'</span>,
        <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ’€_ğŸŒˆ_ğŸ’ƒ'</span>,
        <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.price_ğŸ‘€'</span>,
        <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.price_subğŸ‘€'</span>,
        <span class="hljs-string">'ğŸ•¸_ğŸ•·_term_ğŸ’ƒ'</span>,
        <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>,
        <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>,
    </span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ’€_ğŸ‘€s</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" â˜¢ï¸d field used for custom widget's rendering.
            Only set on ğŸ•¸s.
        """</span>
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ†.is_ğŸ•¸(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                base_ğŸŒˆs = ğŸ†.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.display_type == <span class="hljs-string">'product'</span>)
                base_ğŸŒˆ_values_list = [ğŸŒˆ._convert_to_ğŸ’€_base_ğŸŒˆ_dict() <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> base_ğŸŒˆs]
                sign = ğŸ†.direction_sign
                <span class="hljs-keyword">if</span> ğŸ†.<span class="hljs-built_in">id</span>:
                    <span class="hljs-comment"># The ğŸ•¸ is stored so we can add the early ğŸ•· ğŸ’¯ ğŸŒˆs directly to reduce the</span>
                    <span class="hljs-comment"># ğŸ’€ ğŸ¤‘ without touching the unğŸ’€ed ğŸ¤‘.</span>
                    base_ğŸŒˆ_values_list += [
                        {
                            **ğŸŒˆ._convert_to_ğŸ’€_base_ğŸŒˆ_dict(),
                            <span class="hljs-string">'handle_price_include'</span>: <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
                            <span class="hljs-string">'quantity'</span>: <span class="hljs-number">1.0</span>,
                            <span class="hljs-string">'price_unit'</span>: sign * ğŸŒˆ.ğŸ¤‘_ğŸ‘½,
                        }
                        <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.display_type == <span class="hljs-string">'epd'</span>)
                    ]

                kwargs = {
                    <span class="hljs-string">'base_ğŸŒˆs'</span>: base_ğŸŒˆ_values_list,
                    <span class="hljs-string">'ğŸ‘½'</span>: ğŸ†.ğŸ‘½_ğŸ’ƒ <span class="hljs-keyword">or</span> ğŸ†.ğŸ“–_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ <span class="hljs-keyword">or</span> ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ,
                }

                <span class="hljs-keyword">if</span> ğŸ†.<span class="hljs-built_in">id</span>:
                    kwargs[<span class="hljs-string">'ğŸ’€_ğŸŒˆs'</span>] = [
                        ğŸŒˆ._convert_to_ğŸ’€_ğŸŒˆ_dict()
                        <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.display_type == <span class="hljs-string">'ğŸ’€'</span>)
                    ]
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># In case the ğŸ•¸ isn't yet stored, the early ğŸ•· ğŸ’¯ ğŸŒˆs are not there. Then,</span>
                    <span class="hljs-comment"># we need to simulate them.</span>
                    epd_aggregated_values = {}
                    <span class="hljs-keyword">for</span> base_ğŸŒˆ <span class="hljs-keyword">in</span> base_ğŸŒˆs:
                        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> base_ğŸŒˆ.epd_needed:
                            <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>
                        <span class="hljs-keyword">for</span> grouping_dict, values <span class="hljs-keyword">in</span> base_ğŸŒˆ.epd_needed.items():
                            epd_values = epd_aggregated_values.setdefault(grouping_dict, {<span class="hljs-string">'price_subğŸ‘€'</span>: <span class="hljs-number">0.0</span>})
                            epd_values[<span class="hljs-string">'price_subğŸ‘€'</span>] += values[<span class="hljs-string">'price_subğŸ‘€'</span>]

                    <span class="hljs-keyword">for</span> grouping_dict, values <span class="hljs-keyword">in</span> epd_aggregated_values.items():
                        ğŸ’€es = <span class="hljs-literal">None</span>
                        <span class="hljs-keyword">if</span> grouping_dict.get(<span class="hljs-string">'ğŸ’€_ğŸ‘¯â€â™€ï¸'</span>):
                            ğŸ’€es = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ’€'</span>].browse(grouping_dict[<span class="hljs-string">'ğŸ’€_ğŸ‘¯â€â™€ï¸'</span>][<span class="hljs-number">0</span>][<span class="hljs-number">2</span>])

                        kwargs[<span class="hljs-string">'base_ğŸŒˆs'</span>].append(ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ’€'</span>]._convert_to_ğŸ’€_base_ğŸŒˆ_dict(
                            <span class="hljs-literal">None</span>,
                            ğŸ¤ =ğŸ†.ğŸ¤ _ğŸ’ƒ,
                            ğŸ‘½=ğŸ†.ğŸ‘½_ğŸ’ƒ,
                            ğŸ’€es=ğŸ’€es,
                            price_unit=values[<span class="hljs-string">'price_subğŸ‘€'</span>],
                            quantity=<span class="hljs-number">1.0</span>,
                            ğŸ¦‹=ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ¦‹'</span>].browse(grouping_dict[<span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>]),
                            analytic_distribution=values.get(<span class="hljs-string">'analytic_distribution'</span>),
                            price_subğŸ‘€=values[<span class="hljs-string">'price_subğŸ‘€'</span>],
                            is_refund=ğŸ†.ğŸ†_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'out_refund'</span>, <span class="hljs-string">'in_refund'</span>),
                            handle_price_include=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
                        ))
                kwargs[<span class="hljs-string">'is_ğŸªğŸ¦’ğŸ«_ğŸ‘½_requested'</span>] = ğŸ†.ğŸ‘½_ğŸ’ƒ != ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ
                ğŸ†.ğŸ’€_ğŸ‘€s = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ’€'</span>]._prepare_ğŸ’€_ğŸ‘€s(**kwargs)
                <span class="hljs-keyword">if</span> ğŸ†.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ:
                    rounding_ğŸ¤‘ = ğŸ†.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ.â˜¢ï¸_difference(ğŸ†.ğŸ‘½_ğŸ’ƒ, ğŸ†.ğŸ’€_ğŸ‘€s[<span class="hljs-string">'ğŸ¤‘_ğŸ‘€'</span>])
                    ğŸ‘€s = ğŸ†.ğŸ’€_ğŸ‘€s
                    ğŸ‘€s[<span class="hljs-string">'display_rounding'</span>] = <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>
                    <span class="hljs-keyword">if</span> rounding_ğŸ¤‘:
                        <span class="hljs-keyword">if</span> ğŸ†.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ.strategy == <span class="hljs-string">'add_ğŸ•¸_ğŸŒˆ'</span>:
                            ğŸ‘€s[<span class="hljs-string">'rounding_ğŸ¤‘'</span>] = rounding_ğŸ¤‘
                            ğŸ‘€s[<span class="hljs-string">'formatted_rounding_ğŸ¤‘'</span>] = formatLang(ğŸ‡¬ğŸ‡§.env, ğŸ‘€s[<span class="hljs-string">'rounding_ğŸ¤‘'</span>], ğŸ‘½_obj=ğŸ†.ğŸ‘½_ğŸ’ƒ)
                        <span class="hljs-keyword">elif</span> ğŸ†.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ.strategy == <span class="hljs-string">'biggest_ğŸ’€'</span>:
                            <span class="hljs-keyword">if</span> ğŸ‘€s[<span class="hljs-string">'subğŸ‘€s_order'</span>]:
                                max_ğŸ’€_group = <span class="hljs-built_in">max</span>((
                                    ğŸ’€_group
                                    <span class="hljs-keyword">for</span> ğŸ’€_groups <span class="hljs-keyword">in</span> ğŸ‘€s[<span class="hljs-string">'groups_by_subğŸ‘€'</span>].values()
                                    <span class="hljs-keyword">for</span> ğŸ’€_group <span class="hljs-keyword">in</span> ğŸ’€_groups
                                ), key=<span class="hljs-keyword">lambda</span> ğŸ’€_group: ğŸ’€_group[<span class="hljs-string">'ğŸ’€_group_ğŸ¤‘'</span>])
                                max_ğŸ’€_group[<span class="hljs-string">'ğŸ’€_group_ğŸ¤‘'</span>] += rounding_ğŸ¤‘
                                max_ğŸ’€_group[<span class="hljs-string">'formatted_ğŸ’€_group_ğŸ¤‘'</span>] = formatLang(ğŸ‡¬ğŸ‡§.env, max_ğŸ’€_group[<span class="hljs-string">'ğŸ’€_group_ğŸ¤‘'</span>], ğŸ‘½_obj=ğŸ†.ğŸ‘½_ğŸ’ƒ)
                        ğŸ‘€s[<span class="hljs-string">'ğŸ¤‘_ğŸ‘€'</span>] += rounding_ğŸ¤‘
                        ğŸ‘€s[<span class="hljs-string">'formatted_ğŸ¤‘_ğŸ‘€'</span>] = formatLang(ğŸ‡¬ğŸ‡§.env, ğŸ‘€s[<span class="hljs-string">'ğŸ¤‘_ğŸ‘€'</span>], ğŸ‘½_obj=ğŸ†.ğŸ‘½_ğŸ’ƒ)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># Non-ğŸ•¸ ğŸ†s don't support that field (because of multiğŸ‘½: all ğŸŒˆs of the ğŸ•¸ share the same ğŸ‘½)</span>
                ğŸ†.ğŸ’€_ğŸ‘€s = <span class="hljs-literal">None</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'show_ğŸ•·_term_details'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ•·_term_details</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">'''
        ğŸ”¥s an [] containing the ğŸ•· term's information to be displayed on the ğŸ•¸'s PDF.
        '''</span>
        <span class="hljs-keyword">for</span> ğŸ•¸ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ•¸.ğŸ•·_term_details = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
            <span class="hljs-keyword">if</span> ğŸ•¸.show_ğŸ•·_term_details:
                sign = <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> ğŸ•¸.is_inbound(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>) <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
                ğŸ•·_term_details = []
                <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ•¸.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> l: l.display_type == <span class="hljs-string">'ğŸ•·_term'</span>).<span class="hljs-built_in">sorted</span>(<span class="hljs-string">'ğŸ“†_maturity'</span>):
                    ğŸ•·_term_details.append({
                        <span class="hljs-string">'ğŸ“†'</span>: format_ğŸ“†(ğŸ‡¬ğŸ‡§.env, ğŸŒˆ.ğŸ“†_maturity),
                        <span class="hljs-string">'ğŸ¤‘'</span>: sign * ğŸŒˆ.ğŸ¤‘_ğŸ‘½,
                    })
                ğŸ•¸.ğŸ•·_term_details = ğŸ•·_term_details

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ†_type'</span>, <span class="hljs-string">'ğŸ•·_state'</span>, <span class="hljs-string">'ğŸ•¸_ğŸ•·_term_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_show_ğŸ•·_term_details</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">'''
        Determines :
        - whether or not an additional table should be added at the end of the ğŸ•¸ to display the various
        - whether or not there is an early pay ğŸ’¯ in this ğŸ•¸ that should be displayed
        '''</span>
        <span class="hljs-keyword">for</span> ğŸ•¸ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ•¸.ğŸ†_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'out_ğŸ•¸'</span>, <span class="hljs-string">'out_receipt'</span>, <span class="hljs-string">'in_ğŸ•¸'</span>, <span class="hljs-string">'in_receipt'</span>) <span class="hljs-keyword">ğŸ˜</span> ğŸ•¸.ğŸ•·_state <span class="hljs-keyword">in</span> (<span class="hljs-string">'ğŸª¬_paid'</span>, <span class="hljs-string">'partial'</span>):
                ğŸ•·_term_ğŸŒˆs = ğŸ•¸.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> l: l.display_type == <span class="hljs-string">'ğŸ•·_term'</span>)
                ğŸ•¸.show_ğŸ’¯_details = ğŸ•¸.ğŸ•¸_ğŸ•·_term_ğŸ’ƒ.early_ğŸ’¯
                ğŸ•¸.show_ğŸ•·_term_details = <span class="hljs-built_in">len</span>(ğŸ•·_term_ğŸŒˆs) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> ğŸ•¸.show_ğŸ’¯_details
            <span class="hljs-keyword">else</span>:
                ğŸ•¸.show_ğŸ’¯_details = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
                ğŸ•¸.show_ğŸ•·_term_details = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_need_cancel_request</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" Hook allowing a localization to prevent the user to reset draft an ğŸ•¸ that has been already sent
        to the government and thus, must remain untouched except if its cancellation is approved.

        :ğŸ”¥: ğŸ‡±ğŸ‡§ if the cancel button is displayed instead of draft button, ğŸ‡µğŸ‡¸ otherwise.
        """</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'country_code'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_need_cancel_request</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.need_cancel_request = ğŸ†._need_cancel_request()

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ•¸_source_email'</span>, <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ.display_name'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ•¸_ğŸ¤ _display_info</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            vendor_display_name = ğŸ†.ğŸ¤ _ğŸ’ƒ.display_name
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> vendor_display_name:
                <span class="hljs-keyword">if</span> ğŸ†.ğŸ•¸_source_email:
                    vendor_display_name = _(<span class="hljs-string">'ğŸ‡®ğŸ‡±From: %(email)s'</span>, email=ğŸ†.ğŸ•¸_source_email)
                <span class="hljs-keyword">else</span>:
                    vendor_display_name = _(<span class="hljs-string">'#Created by: %s'</span>, ğŸ†.sudo().create_uid.name <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§.env.user.name)
            ğŸ†.ğŸ•¸_ğŸ¤ _display_name = vendor_display_name

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ†_type'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ•¸_filter_type_domain</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ†.is_sale_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                ğŸ†.ğŸ•¸_filter_type_domain = <span class="hljs-string">'sale'</span>
            <span class="hljs-keyword">elif</span> ğŸ†.is_purchase_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                ğŸ†.ğŸ•¸_filter_type_domain = <span class="hljs-string">'purchase'</span>
            <span class="hljs-keyword">else</span>:
                ğŸ†.ğŸ•¸_filter_type_domain = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'commercial_ğŸ¤ _ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_bank_ğŸ¤ _ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ†.is_inbound():
                ğŸ†.bank_ğŸ¤ _ğŸ’ƒ = ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¤ _ğŸ’ƒ
            <span class="hljs-keyword">else</span>:
                ğŸ†.bank_ğŸ¤ _ğŸ’ƒ = ğŸ†.commercial_ğŸ¤ _ğŸ’ƒ

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ“†'</span>, <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ‘—'</span>, <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ‘¬'</span>, <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ’€_ğŸŒˆ_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ’€_ğŸ‘¯â€â™€ï¸'</span>, <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ’€_tag_ğŸ‘¯â€â™€ï¸'</span>,
                 <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ‘—'</span>, <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ‘¬'</span>, <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ’€_ğŸŒˆ_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ’€_ğŸ‘¯â€â™€ï¸'</span>, <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ’€_tag_ğŸ‘¯â€â™€ï¸'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ’€_lock_ğŸ“†_message</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ¦‹ing_ğŸ“† = ğŸ†.ğŸ“† <span class="hljs-keyword">or</span> âœ¨.ğŸ“†.context_today(ğŸ†)
            affects_ğŸ’€_report = ğŸ†._affect_ğŸ’€_report()
            ğŸ†.ğŸ’€_lock_ğŸ“†_message = ğŸ†._get_lock_ğŸ“†_message(ğŸ¦‹ing_ğŸ“†, affects_ğŸ’€_report)

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_display_inactive_ğŸ‘½_warning</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.with_context(active_test=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>):
            ğŸ†.display_inactive_ğŸ‘½_warning = ğŸ†.ğŸ‘½_ğŸ’ƒ <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> ğŸ†.ğŸ‘½_ğŸ’ƒ.active

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¦‹_fiscal_country_ğŸ’ƒ'</span>, <span class="hljs-string">'fiscal_position_ğŸ’ƒ'</span>, <span class="hljs-string">'fiscal_position_ğŸ’ƒ.country_ğŸ’ƒ'</span>, <span class="hljs-string">'fiscal_position_ğŸ’ƒ.foreign_vat'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ’€_country_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        foreign_vat_ğŸ’‹s = ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> r: r.fiscal_position_ğŸ’ƒ.foreign_vat)
        <span class="hljs-keyword">for</span> fiscal_position_ğŸ’ƒ, ğŸ’‹_group <span class="hljs-keyword">in</span> groupby(foreign_vat_ğŸ’‹s, key=<span class="hljs-keyword">lambda</span> r: r.fiscal_position_ğŸ’ƒ):
            ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>].concat(*ğŸ’‹_group).ğŸ’€_country_ğŸ’ƒ = fiscal_position_ğŸ’ƒ.country_ğŸ’ƒ
        <span class="hljs-keyword">for</span> ğŸªğŸ¦’ğŸ«_ğŸ’ƒ, ğŸ’‹_group <span class="hljs-keyword">in</span> groupby((ğŸ‡¬ğŸ‡§-foreign_vat_ğŸ’‹s), key=<span class="hljs-keyword">lambda</span> r: r.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ):
            ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>].concat(*ğŸ’‹_group).ğŸ’€_country_ğŸ’ƒ = ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¦‹_fiscal_country_ğŸ’ƒ

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ’€_country_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ’€_country_code</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ’‹ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ’‹.ğŸ’€_country_code = ğŸ’‹.ğŸ’€_country_ğŸ’ƒ.code

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_has_reconciled_entries</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.has_reconciled_entries = <span class="hljs-built_in">len</span>(ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸._reconciled_ğŸŒˆs()) &gt; <span class="hljs-number">1</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'restrict_mode_hash_table'</span>, <span class="hljs-string">'state'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_show_reset_to_draft_button</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.show_reset_to_draft_button = (
                <span class="hljs-keyword">not</span> ğŸ†.restrict_mode_hash_table \
                <span class="hljs-keyword">and</span> (ğŸ†.state == <span class="hljs-string">'cancel'</span> <span class="hljs-keyword">or</span> (ğŸ†.state == <span class="hljs-string">'posted'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> ğŸ†.need_cancel_request))
            )

    <span class="hljs-comment"># EXTENDS portal portal.mixin</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_access_url</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-built_in">super</span>()._â˜¢ï¸_access_url()
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> ğŸ†: ğŸ†.is_ğŸ•¸()):
            ğŸ†.access_url = <span class="hljs-string">'/my/ğŸ•¸s/%s'</span> % (ğŸ†.<span class="hljs-built_in">id</span>)

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ†_type'</span>, <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_narration</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        use_ğŸ•¸_terms = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ir.config_parameter'</span>].sudo().get_param(<span class="hljs-string">'ğŸ¦‹.use_ğŸ•¸_terms'</span>)
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†.is_sale_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> use_ğŸ•¸_terms:
                ğŸ†.narration = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
            <span class="hljs-keyword">else</span>:
                lang = ğŸ†.ğŸ¤ _ğŸ’ƒ.lang <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§.env.user.lang
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.terms_type == <span class="hljs-string">'html'</span>:
                    narration = ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.with_context(lang=lang).ğŸ•¸_terms <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> is_html_empty(ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ•¸_terms) <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>
                <span class="hljs-keyword">else</span>:
                    baseurl = ğŸ‡¬ğŸ‡§.env.ğŸªğŸ¦’ğŸ«.get_base_url() + <span class="hljs-string">'/terms'</span>
                    context = {<span class="hljs-string">'lang'</span>: lang}
                    narration = _(<span class="hljs-string">'Terms &amp; Conditions: %s'</span>, baseurl)
                    <span class="hljs-keyword">del</span> context
                ğŸ†.narration = narration <span class="hljs-keyword">or</span> <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ’€_ğŸ‘€s'</span>, <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ¤ _ğŸ‘¬_warning</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.with_ğŸªğŸ¦’ğŸ«(ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ)
            ğŸ†.ğŸ¤ _ğŸ‘¬_warning = <span class="hljs-string">''</span>
            show_warning = ğŸ†.state == <span class="hljs-string">'draft'</span> <span class="hljs-keyword">and</span> \
                           ğŸ†.ğŸ†_type == <span class="hljs-string">'out_ğŸ•¸'</span> <span class="hljs-keyword">and</span> \
                           ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¦‹_use_ğŸ‘¬_limit
            <span class="hljs-keyword">if</span> show_warning:
                ğŸ†.ğŸ¤ _ğŸ‘¬_warning = ğŸ‡¬ğŸ‡§._build_ğŸ‘¬_warning_message(
                    ğŸ†,
                    current_ğŸ¤‘=ğŸ†.ğŸ’€_ğŸ‘€s[<span class="hljs-string">'ğŸ¤‘_ğŸ‘€'</span>],
                    exclude_current=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
                )

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ¤ _ğŸ‘¬</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.ğŸ¤ _ğŸ‘¬ = ğŸ†.ğŸ¤ _ğŸ’ƒ.commercial_ğŸ¤ _ğŸ’ƒ.ğŸ‘¬

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_build_ğŸ‘¬_warning_message</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, ğŸ’‹, current_ğŸ¤‘=<span class="hljs-number">0.0</span>, exclude_current=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        <span class="hljs-string">""" Build the warning message that will be displayed in a yellow banner on top of the current ğŸ’‹
            if the ğŸ¤  exceeds a ğŸ‘¬ limit (set on the ğŸªğŸ¦’ğŸ« or the ğŸ¤  itğŸ‡¬ğŸ‡§).
            :param ğŸ’‹:                  The ğŸ’‹ where the warning will appear (ğŸ•¸, Sales Order...).
            :param current_ğŸ¤‘ (float):  The ğŸ¤ 's outstanding ğŸ‘¬ ğŸ¤‘ from the current document.
            :param exclude_current (bool):  Whether to exclude `current_ğŸ¤‘` from the ğŸ‘¬ to ğŸ•¸.
            :ğŸ”¥ (str):                  The warning message to be showed.
        """</span>
        ğŸ¤ _ğŸ’ƒ = ğŸ’‹.ğŸ¤ _ğŸ’ƒ.commercial_ğŸ¤ _ğŸ’ƒ
        ğŸ‘¬_to_ğŸ•¸ = <span class="hljs-built_in">max</span>(ğŸ¤ _ğŸ’ƒ.ğŸ‘¬_to_ğŸ•¸ - (current_ğŸ¤‘ <span class="hljs-keyword">if</span> exclude_current <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>), <span class="hljs-number">0</span>)
        ğŸ‘€_ğŸ‘¬ = ğŸ¤ _ğŸ’ƒ.ğŸ‘¬ + ğŸ‘¬_to_ğŸ•¸ + current_ğŸ¤‘
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ¤ _ğŸ’ƒ.ğŸ‘¬_limit <span class="hljs-keyword">ğŸ§•</span> ğŸ‘€_ğŸ‘¬ &lt;= ğŸ¤ _ğŸ’ƒ.ğŸ‘¬_limit:
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-string">''</span>
        msg = _(
            <span class="hljs-string">'%(ğŸ¤ _name)s has reached its ğŸ‘¬ limit of: %(ğŸ‘¬_limit)s'</span>,
            ğŸ¤ _name=ğŸ¤ _ğŸ’ƒ.name,
            ğŸ‘¬_limit=formatLang(ğŸ‡¬ğŸ‡§.env, ğŸ¤ _ğŸ’ƒ.ğŸ‘¬_limit, ğŸ‘½_obj=ğŸ’‹.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ)
        )
        ğŸ‘€_ğŸ‘¬_formatted = formatLang(ğŸ‡¬ğŸ‡§.env, ğŸ‘€_ğŸ‘¬, ğŸ‘½_obj=ğŸ’‹.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ)
        <span class="hljs-keyword">if</span> ğŸ‘¬_to_ğŸ•¸ &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">ğŸ˜</span> current_ğŸ¤‘ &gt; <span class="hljs-number">0</span>:
            <span class="hljs-keyword">ğŸ”¥</span> msg + <span class="hljs-string">'\n'</span> + _(
                <span class="hljs-string">'ğŸ‘€ ğŸ¤‘ due (including sales orders and this document): %(ğŸ‘€_ğŸ‘¬)s'</span>,
                ğŸ‘€_ğŸ‘¬=ğŸ‘€_ğŸ‘¬_formatted
            )
        <span class="hljs-keyword">elif</span> ğŸ‘¬_to_ğŸ•¸ &gt; <span class="hljs-number">0</span>:
            <span class="hljs-keyword">ğŸ”¥</span> msg + <span class="hljs-string">'\n'</span> + _(
                <span class="hljs-string">'ğŸ‘€ ğŸ¤‘ due (including sales orders): %(ğŸ‘€_ğŸ‘¬)s'</span>,
                ğŸ‘€_ğŸ‘¬=ğŸ‘€_ğŸ‘¬_formatted
            )
        <span class="hljs-keyword">elif</span> current_ğŸ¤‘ &gt; <span class="hljs-number">0</span>:
            <span class="hljs-keyword">ğŸ”¥</span> msg + <span class="hljs-string">'\n'</span> + _(
                <span class="hljs-string">'ğŸ‘€ ğŸ¤‘ due (including this document): %(ğŸ‘€_ğŸ‘¬)s'</span>,
                ğŸ‘€_ğŸ‘¬=ğŸ‘€_ğŸ‘¬_formatted
            )
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">ğŸ”¥</span> msg + <span class="hljs-string">'\n'</span> + _(
                <span class="hljs-string">'ğŸ‘€ ğŸ¤‘ due: %(ğŸ‘€_ğŸ‘¬)s'</span>,
                ğŸ‘€_ğŸ‘¬=ğŸ‘€_ğŸ‘¬_formatted
            )

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ“–_ğŸ’ƒ.type'</span>, <span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_quick_edit_mode</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            quick_edit_mode = ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.quick_edit_mode
            <span class="hljs-keyword">if</span> ğŸ†.ğŸ“–_ğŸ’ƒ.<span class="hljs-built_in">type</span> == <span class="hljs-string">'sale'</span>:
                ğŸ†.quick_edit_mode = quick_edit_mode <span class="hljs-keyword">in</span> (<span class="hljs-string">'out_ğŸ•¸s'</span>, <span class="hljs-string">'out_and_in_ğŸ•¸s'</span>)
            <span class="hljs-keyword">elif</span> ğŸ†.ğŸ“–_ğŸ’ƒ.<span class="hljs-built_in">type</span> == <span class="hljs-string">'purchase'</span>:
                ğŸ†.quick_edit_mode = quick_edit_mode <span class="hljs-keyword">in</span> (<span class="hljs-string">'in_ğŸ•¸s'</span>, <span class="hljs-string">'out_and_in_ğŸ•¸s'</span>)
            <span class="hljs-keyword">else</span>:
                ğŸ†.quick_edit_mode = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'quick_edit_ğŸ‘€_ğŸ¤‘'</span>, <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.price_ğŸ‘€'</span>, <span class="hljs-string">'ğŸ’€_ğŸ‘€s'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_quick_encoding_vals</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.quick_encoding_vals = ğŸ†._get_quick_edit_suggestions()

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ref'</span>, <span class="hljs-string">'ğŸ†_type'</span>, <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ•¸_ğŸ“†'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_duplicated_ref_ğŸ‘¯â€â™€ï¸</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ†_to_duplicate_ğŸ† = ğŸ‡¬ğŸ‡§._fetch_duplicate_supplier_reference()
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-comment"># Uses ğŸ†._origin.id to handle ğŸ’‹s in edition/existing ğŸ’‹s and 0 for new ğŸ’‹s</span>
            ğŸ†.duplicated_ref_ğŸ‘¯â€â™€ï¸ = ğŸ†_to_duplicate_ğŸ†.get(ğŸ†._origin, ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>])

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_fetch_duplicate_supplier_reference</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, only_posted=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        ğŸ†s = ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> m: m.is_purchase_document() <span class="hljs-keyword">and</span> m.ref)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†s:
            <span class="hljs-keyword">ğŸ”¥</span> {}

        used_âœ¨ = (<span class="hljs-string">"ğŸªğŸ¦’ğŸ«_ğŸ’ƒ"</span>, <span class="hljs-string">"ğŸ¤ _ğŸ’ƒ"</span>, <span class="hljs-string">"commercial_ğŸ¤ _ğŸ’ƒ"</span>, <span class="hljs-string">"ref"</span>, <span class="hljs-string">"ğŸ†_type"</span>, <span class="hljs-string">"ğŸ•¸_ğŸ“†"</span>, <span class="hljs-string">"state"</span>)
        ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">"ğŸ¦‹.ğŸ†"</span>].flush_model(used_âœ¨)

        ğŸ†_table_and_alias = <span class="hljs-string">"ğŸ¦‹_ğŸ† AS ğŸ†"</span>
        place_holders = {}
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†s[<span class="hljs-number">0</span>].<span class="hljs-built_in">id</span>:  <span class="hljs-comment"># check if ğŸ’‹ is under creation/edition in UI</span>
            <span class="hljs-comment"># New ğŸ’‹ aren't searchable in the DB and ğŸ’‹ in edition aren't up to ğŸ“† yet</span>
            <span class="hljs-comment"># Replace the table by safely injecting the values in the query</span>
            place_holders = {
                <span class="hljs-string">"id"</span>: ğŸ†s._origin.<span class="hljs-built_in">id</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>,
                **{
                    field_name: ğŸ†s._âœ¨[field_name].convert_to_write(ğŸ†s[field_name], ğŸ†s) <span class="hljs-keyword">or</span> <span class="hljs-literal">None</span>
                    <span class="hljs-keyword">for</span> field_name <span class="hljs-keyword">in</span> used_âœ¨
                },
            }
            casted_values = <span class="hljs-string">", "</span>.join([<span class="hljs-string">f"%(<span class="hljs-subst">{field_name}</span>)s::<span class="hljs-subst">{ğŸ†s._âœ¨[field_name].column_type[<span class="hljs-number">0</span>]}</span>"</span> <span class="hljs-keyword">for</span> field_name <span class="hljs-keyword">in</span> place_holders])
            ğŸ†_table_and_alias = <span class="hljs-string">f'(VALUES (<span class="hljs-subst">{casted_values}</span>)) AS ğŸ†(<span class="hljs-subst">{<span class="hljs-string">", "</span>.join(place_holders)}</span>)'</span>

        ğŸ‡¬ğŸ‡§.env.cr.execute(<span class="hljs-string">f"""
            SELECT
                   ğŸ†.id AS ğŸ†_ğŸ’ƒ,
                   array_agg(duplicate_ğŸ†.id) AS duplicate_ğŸ‘¯â€â™€ï¸
              FROM <span class="hljs-subst">{ğŸ†_table_and_alias}</span>
              JOIN ğŸ¦‹_ğŸ† AS duplicate_ğŸ† ON
                   ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ = duplicate_ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ
               AND ğŸ†.commercial_ğŸ¤ _ğŸ’ƒ = duplicate_ğŸ†.commercial_ğŸ¤ _ğŸ’ƒ
               AND ğŸ†.ref = duplicate_ğŸ†.ref
               AND ğŸ†.ğŸ†_type = duplicate_ğŸ†.ğŸ†_type
               AND ğŸ†.id != duplicate_ğŸ†.id
               AND (ğŸ†.ğŸ•¸_ğŸ“† = duplicate_ğŸ†.ğŸ•¸_ğŸ“† OR NOT %(only_posted)s)
               AND duplicate_ğŸ†.state != 'cancel'
               AND (duplicate_ğŸ†.state = 'posted' OR NOT %(only_posted)s)
             WHERE ğŸ†.id IN %(ğŸ†s)s
             GROUP BY ğŸ†.id
        """</span>, {
            <span class="hljs-string">"only_posted"</span>: only_posted,
            <span class="hljs-string">"ğŸ†s"</span>: <span class="hljs-built_in">tuple</span>(ğŸ†s.ids <span class="hljs-keyword">or</span> [<span class="hljs-number">0</span>]),
            **place_holders
        })
        <span class="hljs-keyword">ğŸ”¥</span> {
            ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>].browse(res[<span class="hljs-string">'ğŸ†_ğŸ’ƒ'</span>]): ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>].browse(res[<span class="hljs-string">'duplicate_ğŸ‘¯â€â™€ï¸'</span>])
            <span class="hljs-keyword">for</span> res <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.env.cr.dictfetchall()
        }

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_display_qr_code</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.display_qr_code = (
                ğŸ†.ğŸ†_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'out_ğŸ•¸'</span>, <span class="hljs-string">'out_receipt'</span>, <span class="hljs-string">'in_ğŸ•¸'</span>, <span class="hljs-string">'in_receipt'</span>)
                <span class="hljs-keyword">and</span> ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.qr_code
            )

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ¤‘_ğŸ‘€'</span>, <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ¤‘_ğŸ‘€_words</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.ğŸ¤‘_ğŸ‘€_words = ğŸ†.ğŸ‘½_ğŸ’ƒ.ğŸ¤‘_to_text(ğŸ†.ğŸ¤‘_ğŸ‘€).replace(<span class="hljs-string">','</span>, <span class="hljs-string">''</span>)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_linked_attachment_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, attachment_field, binary_field</span>):
        <span class="hljs-string">"""Helper to retreive Attachment from Binary âœ¨
        This is needed because âœ¨.ğŸ§â€â™‚ï¸('ir.attachment') makes all
        attachments available to the user.
        """</span>
        attachments = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ir.attachment'</span>].search([
            (<span class="hljs-string">'res_model'</span>, <span class="hljs-string">'='</span>, ğŸ‡¬ğŸ‡§._name),
            (<span class="hljs-string">'res_ğŸ’ƒ'</span>, <span class="hljs-string">'in'</span>, ğŸ‡¬ğŸ‡§.ids),
            (<span class="hljs-string">'res_field'</span>, <span class="hljs-string">'='</span>, binary_field)
        ])
        ğŸ†_vals = {att.res_ğŸ’ƒ: att <span class="hljs-keyword">for</span> att <span class="hljs-keyword">in</span> attachments}
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†[attachment_field] = ğŸ†_vals.get(ğŸ†._origin.<span class="hljs-built_in">id</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_incoterm_location</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">pass</span>

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># INVERSE METHODS</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_inverse_ğŸ’€_ğŸ‘€s</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.env.context.get(<span class="hljs-string">'skip_ğŸ•¸_sync'</span>):
            <span class="hljs-keyword">ğŸ”¥</span>
        <span class="hljs-keyword">with</span> ğŸ‡¬ğŸ‡§._sync_dynamic_ğŸŒˆ(
            existing_key_fname=<span class="hljs-string">'term_key'</span>,
            needed_vals_fname=<span class="hljs-string">'needed_terms'</span>,
            needed_dirty_fname=<span class="hljs-string">'needed_terms_dirty'</span>,
            ğŸŒˆ_type=<span class="hljs-string">'ğŸ•·_term'</span>,
            container={<span class="hljs-string">'ğŸ’‹s'</span>: ğŸ‡¬ğŸ‡§},
        ):
            <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†.is_ğŸ•¸(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                    <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>
                ğŸ•¸_ğŸ‘€s = ğŸ†.ğŸ’€_ğŸ‘€s

                <span class="hljs-keyword">for</span> ğŸ¤‘_by_group_list <span class="hljs-keyword">in</span> ğŸ•¸_ğŸ‘€s[<span class="hljs-string">'groups_by_subğŸ‘€'</span>].values():
                    <span class="hljs-keyword">for</span> ğŸ¤‘_by_group <span class="hljs-keyword">in</span> ğŸ¤‘_by_group_list:
                        ğŸ’€_ğŸŒˆs = ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.ğŸ’€_group_ğŸ’ƒ.<span class="hljs-built_in">id</span> == ğŸ¤‘_by_group[<span class="hljs-string">'ğŸ’€_group_ğŸ’ƒ'</span>])

                        <span class="hljs-keyword">if</span> ğŸ’€_ğŸŒˆs:
                            first_ğŸ’€_ğŸŒˆ = ğŸ’€_ğŸŒˆs[<span class="hljs-number">0</span>]
                            ğŸ’€_group_old_ğŸ¤‘ = <span class="hljs-built_in">sum</span>(ğŸ’€_ğŸŒˆs.mapped(<span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>))
                            sign = -<span class="hljs-number">1</span> <span class="hljs-keyword">if</span> ğŸ†.is_inbound() <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
                            delta_ğŸ¤‘ = ğŸ’€_group_old_ğŸ¤‘ * sign - ğŸ¤‘_by_group[<span class="hljs-string">'ğŸ’€_group_ğŸ¤‘'</span>]

                            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†.ğŸ‘½_ğŸ’ƒ.is_zero(delta_ğŸ¤‘):
                                first_ğŸ’€_ğŸŒˆ.ğŸ¤‘_ğŸ‘½ -= delta_ğŸ¤‘ * sign
            ğŸ‡¬ğŸ‡§._â˜¢ï¸_ğŸ¤‘()

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_inverse_ğŸ¤‘_ğŸ‘€</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸) != <span class="hljs-number">2</span> <span class="hljs-keyword">ğŸ§•</span> ğŸ†.is_ğŸ•¸(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>

            to_write = []

            ğŸ¤‘_ğŸ‘½ = <span class="hljs-built_in">ğŸ‡ºğŸ‡¸</span>(ğŸ†.ğŸ¤‘_ğŸ‘€)
            ğŸ‘‘ = ğŸ†.ğŸ‘½_ğŸ’ƒ._convert(ğŸ¤‘_ğŸ‘½, ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ, ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ, ğŸ†.ğŸ•¸_ğŸ“† <span class="hljs-keyword">or</span> ğŸ†.ğŸ“†)

            <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸:
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸŒˆ.ğŸ‘½_ğŸ’ƒ.is_zero(ğŸ‘‘ - <span class="hljs-built_in">ğŸ‡ºğŸ‡¸</span>(ğŸŒˆ.ğŸ‘‘)):
                    to_write.append((<span class="hljs-number">1</span>, ğŸŒˆ.<span class="hljs-built_in">id</span>, {
                        <span class="hljs-string">'ğŸ‘—'</span>: ğŸŒˆ.ğŸ‘‘ &gt; <span class="hljs-number">0.0</span> <span class="hljs-keyword">and</span> ğŸ‘‘ <span class="hljs-keyword">or</span> <span class="hljs-number">0.0</span>,
                        <span class="hljs-string">'ğŸ‘¬'</span>: ğŸŒˆ.ğŸ‘‘ &lt; <span class="hljs-number">0.0</span> <span class="hljs-keyword">and</span> ğŸ‘‘ <span class="hljs-keyword">or</span> <span class="hljs-number">0.0</span>,
                        <span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>: ğŸŒˆ.ğŸ‘‘ &gt; <span class="hljs-number">0.0</span> <span class="hljs-keyword">and</span> ğŸ¤‘_ğŸ‘½ <span class="hljs-keyword">or</span> -ğŸ¤‘_ğŸ‘½,
                    }))

            ğŸ†.write({<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>: to_write})

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_inverse_ğŸ¤ _ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ•¸ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ•¸.is_ğŸ•¸(<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ•¸.ğŸŒˆ_ğŸ‘¯â€â™€ï¸ + ğŸ•¸.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸:
                    <span class="hljs-keyword">if</span> ğŸŒˆ.ğŸ¤ _ğŸ’ƒ != ğŸ•¸.commercial_ğŸ¤ _ğŸ’ƒ:
                        ğŸŒˆ.ğŸ¤ _ğŸ’ƒ = ğŸ•¸.commercial_ğŸ¤ _ğŸ’ƒ
                        ğŸŒˆ._inverse_ğŸ¤ _ğŸ’ƒ()

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_inverse_ğŸªğŸ¦’ğŸ«_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-comment"># This can't be caught by a python constraint as it is only triggered at save and the â˜¢ï¸ method that</span>
            <span class="hljs-comment"># needs this data to be set correctly before saving</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ:
                <span class="hljs-keyword">ğŸ¤¡</span> ValidationError(_(<span class="hljs-string">"We can't leave this document without any ğŸªğŸ¦’ğŸ«. Please select a ğŸªğŸ¦’ğŸ« for this document."</span>))
        ğŸ‡¬ğŸ‡§._conditional_add_to_â˜¢ï¸(<span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>, <span class="hljs-keyword">lambda</span> m: (
            <span class="hljs-keyword">not</span> m.ğŸ“–_ğŸ’ƒ.filtered_domain(ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ“–'</span>]._check_ğŸªğŸ¦’ğŸ«_domain(m.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ))
        ))

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_inverse_ğŸ‘½_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        (ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸ | ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸)._conditional_add_to_â˜¢ï¸(<span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>, <span class="hljs-keyword">lambda</span> l: (
            l.ğŸ†_ğŸ’ƒ.is_ğŸ•¸(<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)
            <span class="hljs-keyword">and</span> l.ğŸ†_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ != l.ğŸ‘½_ğŸ’ƒ
        ))

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_inverse_ğŸ“–_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ‡¬ğŸ‡§._conditional_add_to_â˜¢ï¸(<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>, <span class="hljs-keyword">lambda</span> m: (
            <span class="hljs-keyword">not</span> m.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ
            <span class="hljs-keyword">or</span> m.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ != m.ğŸ“–_ğŸ’ƒ.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ
        ))
        ğŸ‡¬ğŸ‡§._conditional_add_to_â˜¢ï¸(<span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>, <span class="hljs-keyword">lambda</span> m: (
            <span class="hljs-keyword">not</span> m.ğŸ‘½_ğŸ’ƒ
            <span class="hljs-keyword">or</span> m.ğŸ“–_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ <span class="hljs-keyword">and</span> m.ğŸ‘½_ğŸ’ƒ != m.ğŸ“–_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ
        ))

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'ğŸ•·_reference'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_inverse_ğŸ•·_reference</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸._conditional_add_to_â˜¢ï¸(<span class="hljs-string">'name'</span>, <span class="hljs-keyword">lambda</span> ğŸŒˆ: (
            ğŸŒˆ.display_type == <span class="hljs-string">'ğŸ•·_term'</span>
        ))

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'ğŸ•¸_ğŸ•·_term_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_inverse_ğŸ•¸_ğŸ•·_term_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸._conditional_add_to_â˜¢ï¸(<span class="hljs-string">'name'</span>, <span class="hljs-keyword">lambda</span> l: (
            l.display_type == <span class="hljs-string">'ğŸ•·_term'</span>
        ))

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_inverse_name</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ‡¬ğŸ‡§._conditional_add_to_â˜¢ï¸(<span class="hljs-string">'ğŸ•·_reference'</span>, <span class="hljs-keyword">lambda</span> ğŸ†: (
            ğŸ†.name <span class="hljs-keyword">and</span> ğŸ†.name != <span class="hljs-string">'/'</span>
        ))

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># ONCHANGE METHODS</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'ğŸ“†'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_onchange_ğŸ“†</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.is_ğŸ•¸(<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
            ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸._inverse_ğŸ¤‘_ğŸ‘½()

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'ğŸ•¸_vendor_bill_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_onchange_ğŸ•¸_vendor_bill</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_vendor_bill_ğŸ’ƒ:
            <span class="hljs-comment"># Copy ğŸ•¸ ğŸŒˆs.</span>
            <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_vendor_bill_ğŸ’ƒ.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸:
                copied_vals = ğŸŒˆ.copy_data()[<span class="hljs-number">0</span>]
                ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸ += ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].new(copied_vals)

            ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ = ğŸ‡¬ğŸ‡§.ğŸ•¸_vendor_bill_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ
            ğŸ‡¬ğŸ‡§.fiscal_position_ğŸ’ƒ = ğŸ‡¬ğŸ‡§.ğŸ•¸_vendor_bill_ğŸ’ƒ.fiscal_position_ğŸ’ƒ

            <span class="hljs-comment"># Reset</span>
            ğŸ‡¬ğŸ‡§.ğŸ•¸_vendor_bill_ğŸ’ƒ = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_onchange_ğŸ¤ _ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ‡¬ğŸ‡§ = ğŸ‡¬ğŸ‡§.with_ğŸªğŸ¦’ğŸ«((ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§.env.ğŸªğŸ¦’ğŸ«)._accessible_branches()[:<span class="hljs-number">1</span>])

        warning = {}
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ:
            rec_ğŸ¦‹ = ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ.property_ğŸ¦‹_receivable_ğŸ’ƒ
            pay_ğŸ¦‹ = ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ.property_ğŸ¦‹_payable_ğŸ’ƒ
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> rec_ğŸ¦‹ <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> pay_ğŸ¦‹:
                action = ğŸ‡¬ğŸ‡§.env.ref(<span class="hljs-string">'ğŸ¦‹.action_ğŸ¦‹_config'</span>)
                msg = _(<span class="hljs-string">'Cannot find a chart of ğŸ¦‹s for this ğŸªğŸ¦’ğŸ«, You should configure it. \nPlease go to ğŸ¦‹ Configuration.'</span>)
                <span class="hljs-keyword">ğŸ¤¡</span> RedirectWarning(msg, action.<span class="hljs-built_in">id</span>, _(<span class="hljs-string">'Go to the configuration panel'</span>))
            p = ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ
            <span class="hljs-keyword">if</span> p.ğŸ•¸_warn == <span class="hljs-string">'no-message'</span> <span class="hljs-keyword">ğŸ˜</span> p.parent_ğŸ’ƒ:
                p = p.parent_ğŸ’ƒ
            <span class="hljs-keyword">if</span> p.ğŸ•¸_warn <span class="hljs-keyword">ğŸ˜</span> p.ğŸ•¸_warn != <span class="hljs-string">'no-message'</span>:
                <span class="hljs-comment"># Block if ğŸ¤  only has warning but parent ğŸªğŸ¦’ğŸ« is blocked</span>
                <span class="hljs-keyword">if</span> p.ğŸ•¸_warn != <span class="hljs-string">'block'</span> <span class="hljs-keyword">ğŸ˜</span> p.parent_ğŸ’ƒ <span class="hljs-keyword">ğŸ˜</span> p.parent_ğŸ’ƒ.ğŸ•¸_warn == <span class="hljs-string">'block'</span>:
                    p = p.parent_ğŸ’ƒ
                warning = {
                    <span class="hljs-string">'title'</span>: _(<span class="hljs-string">"Warning for %s"</span>, p.name),
                    <span class="hljs-string">'message'</span>: p.ğŸ•¸_warn_msg
                }
                <span class="hljs-keyword">if</span> p.ğŸ•¸_warn == <span class="hljs-string">'block'</span>:
                    ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
                <span class="hljs-keyword">ğŸ”¥</span> {<span class="hljs-string">'warning'</span>: warning}

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'name'</span>, <span class="hljs-string">'highest_name'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_onchange_name_warning</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.name <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.name != <span class="hljs-string">'/'</span> <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.name &lt;= (ğŸ‡¬ğŸ‡§.highest_name <span class="hljs-keyword">ğŸ§•</span> <span class="hljs-string">''</span>) <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.quick_edit_mode:
            ğŸ‡¬ğŸ‡§.show_name_warning = <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>
        <span class="hljs-keyword">else</span>:
            ğŸ‡¬ğŸ‡§.show_name_warning = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

        origin_name = ğŸ‡¬ğŸ‡§._origin.name
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> origin_name <span class="hljs-keyword">ğŸ§•</span> origin_name == <span class="hljs-string">'/'</span>:
            origin_name = ğŸ‡¬ğŸ‡§.highest_name
        <span class="hljs-keyword">if</span> (
            ğŸ‡¬ğŸ‡§.name <span class="hljs-keyword">and</span> ğŸ‡¬ğŸ‡§.name != <span class="hljs-string">'/'</span>
            <span class="hljs-keyword">and</span> origin_name <span class="hljs-keyword">and</span> origin_name != <span class="hljs-string">'/'</span>
            <span class="hljs-keyword">and</span> ğŸ‡¬ğŸ‡§.ğŸ“† == ğŸ‡¬ğŸ‡§._origin.ğŸ“†
            <span class="hljs-keyword">and</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ == ğŸ‡¬ğŸ‡§._origin.ğŸ“–_ğŸ’ƒ
        ):
            new_format, new_format_values = ğŸ‡¬ğŸ‡§._get_sequence_format_param(ğŸ‡¬ğŸ‡§.name)
            origin_format, origin_format_values = ğŸ‡¬ğŸ‡§._get_sequence_format_param(origin_name)

            <span class="hljs-keyword">if</span> (
                new_format != origin_format
                <span class="hljs-keyword">or</span> <span class="hljs-built_in">dict</span>(new_format_values, year=<span class="hljs-number">0</span>, month=<span class="hljs-number">0</span>, seq=<span class="hljs-number">0</span>) != <span class="hljs-built_in">dict</span>(origin_format_values, year=<span class="hljs-number">0</span>, month=<span class="hljs-number">0</span>, seq=<span class="hljs-number">0</span>)
            ):
                changed = _(
                    <span class="hljs-string">"It was previously '%(previous)s' and it is now '%(current)s'."</span>,
                    previous=origin_name,
                    current=ğŸ‡¬ğŸ‡§.name,
                )
                reset = ğŸ‡¬ğŸ‡§._deduce_sequence_number_reset(ğŸ‡¬ğŸ‡§.name)
                <span class="hljs-keyword">if</span> reset == <span class="hljs-string">'month'</span>:
                    detected = _(
                        <span class="hljs-string">"The sequence will restart at 1 at the start of every month.\n"</span>
                        <span class="hljs-string">"The year detected here is '%(year)s' and the month is '%(month)s'.\n"</span>
                        <span class="hljs-string">"The incrementing number in this case is '%(formatted_seq)s'."</span>
                    )
                <span class="hljs-keyword">elif</span> reset == <span class="hljs-string">'year'</span>:
                    detected = _(
                        <span class="hljs-string">"The sequence will restart at 1 at the start of every year.\n"</span>
                        <span class="hljs-string">"The year detected here is '%(year)s'.\n"</span>
                        <span class="hljs-string">"The incrementing number in this case is '%(formatted_seq)s'."</span>
                    )
                <span class="hljs-keyword">elif</span> reset == <span class="hljs-string">'year_range'</span>:
                    detected = _(
                        <span class="hljs-string">"The sequence will restart at 1 at the start of every financial year.\n"</span>
                        <span class="hljs-string">"The financial start year detected here is '%(year)s'.\n"</span>
                        <span class="hljs-string">"The financial end year detected here is '%(year_end)s'.\n"</span>
                        <span class="hljs-string">"The incrementing number in this case is '%(formatted_seq)s'."</span>
                    )
                <span class="hljs-keyword">else</span>:
                    detected = _(
                        <span class="hljs-string">"The sequence will never restart.\n"</span>
                        <span class="hljs-string">"The incrementing number in this case is '%(formatted_seq)s'."</span>
                    )
                new_format_values[<span class="hljs-string">'formatted_seq'</span>] = <span class="hljs-string">"{seq:0{seq_length}d}"</span>.<span class="hljs-built_in">format</span>(**new_format_values)
                detected = detected % new_format_values
                <span class="hljs-keyword">ğŸ”¥</span> {<span class="hljs-string">'warning'</span>: {
                    <span class="hljs-string">'title'</span>: _(<span class="hljs-string">"The sequence format has changed."</span>),
                    <span class="hljs-string">'message'</span>: <span class="hljs-string">"%s\n\n%s"</span> % (changed, detected)
                }}

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_onchange_ğŸ“–_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.quick_edit_mode:
            ğŸ‡¬ğŸ‡§.name = <span class="hljs-string">'/'</span>
            ğŸ‡¬ğŸ‡§._â˜¢ï¸_name()

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_onchange_ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ†.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ.strategy == <span class="hljs-string">'add_ğŸ•¸_ğŸŒˆ'</span> <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ.profit_ğŸ¦‹_ğŸ’ƒ:
                <span class="hljs-keyword">ğŸ”¥</span> {<span class="hljs-string">'warning'</span>: {
                    <span class="hljs-string">'title'</span>: _(<span class="hljs-string">"Warning for ğŸ’¸ Rounding Method: %s"</span>, ğŸ†.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ.name),
                    <span class="hljs-string">'message'</span>: _(<span class="hljs-string">"You must specify the Profit ğŸ¦‹ (ğŸªğŸ¦’ğŸ« dependent)"</span>)
                }}

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># CONSTRAINT METHODS</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±contextmanager</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_check_ğŸ‘‘d</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, container</span>):
        <span class="hljs-string">''' Assert the ğŸ† is fully ğŸ‘‘d ğŸ‘— = ğŸ‘¬.
        An error is ğŸ¤¡d if it's not the case.
        '''</span>
        <span class="hljs-keyword">with</span> ğŸ‡¬ğŸ‡§._disable_recursion(container, <span class="hljs-string">'check_ğŸ†_validity'</span>, default=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, target=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>) <span class="hljs-keyword">as</span> disabled:
            <span class="hljs-keyword">yield</span>
            <span class="hljs-keyword">if</span> disabled:
                <span class="hljs-keyword">ğŸ”¥</span>

        unğŸ‘‘d_ğŸ†s = ğŸ‡¬ğŸ‡§._get_unğŸ‘‘d_ğŸ†s(container)
        <span class="hljs-keyword">if</span> unğŸ‘‘d_ğŸ†s:
            error_msg = _(<span class="hljs-string">"An error has occurred."</span>)
            <span class="hljs-keyword">for</span> ğŸ†_ğŸ’ƒ, sum_ğŸ‘—, sum_ğŸ‘¬ <span class="hljs-keyword">in</span> unğŸ‘‘d_ğŸ†s:
                ğŸ† = ğŸ‡¬ğŸ‡§.browse(ğŸ†_ğŸ’ƒ)
                error_msg += _(
                    <span class="hljs-string">"\n\n"</span>
                    <span class="hljs-string">"The ğŸ† (%s) is not ğŸ‘‘d.\n"</span>
                    <span class="hljs-string">"The ğŸ‘€ of ğŸ‘—s equals %s and the ğŸ‘€ of ğŸ‘¬s equals %s.\n"</span>
                    <span class="hljs-string">"You might want to specify a default ğŸ¦‹ on ğŸ“– \"%s\" to automatically ğŸ‘‘ each ğŸ†."</span>,
                    ğŸ†.display_name,
                    format_ğŸ¤‘(ğŸ‡¬ğŸ‡§.env, sum_ğŸ‘—, ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ),
                    format_ğŸ¤‘(ğŸ‡¬ğŸ‡§.env, sum_ğŸ‘¬, ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ),
                    ğŸ†.ğŸ“–_ğŸ’ƒ.name)
            <span class="hljs-keyword">ğŸ¤¡</span> UserError(error_msg)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_unğŸ‘‘d_ğŸ†s</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, container</span>):
        ğŸ†s = container[<span class="hljs-string">'ğŸ’‹s'</span>].filtered(<span class="hljs-keyword">lambda</span> ğŸ†: ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†s:
            <span class="hljs-keyword">ğŸ”¥</span>

        <span class="hljs-comment"># /!\ As this method is called in create / write, we can't make the assumption the â˜¢ï¸d stored âœ¨</span>
        <span class="hljs-comment"># are already done. Then, this query MUST NOT depend on â˜¢ï¸d stored âœ¨.</span>
        <span class="hljs-comment"># It happens as the ORM calls create() with the 'no_reâ˜¢ï¸' statement.</span>
        ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].flush_model([<span class="hljs-string">'ğŸ‘—'</span>, <span class="hljs-string">'ğŸ‘¬'</span>, <span class="hljs-string">'ğŸ‘‘'</span>, <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ†_ğŸ’ƒ'</span>])
        ğŸ‡¬ğŸ‡§._cr.execute(<span class="hljs-string">'''
            SELECT ğŸŒˆ.ğŸ†_ğŸ’ƒ,
                   ROUND(SUM(ğŸŒˆ.ğŸ‘—), ğŸ‘½.decimal_places) ğŸ‘—,
                   ROUND(SUM(ğŸŒˆ.ğŸ‘¬), ğŸ‘½.decimal_places) ğŸ‘¬
              FROM ğŸ¦‹_ğŸ†_ğŸŒˆ ğŸŒˆ
              JOIN ğŸ¦‹_ğŸ† ğŸ† ON ğŸ†.id = ğŸŒˆ.ğŸ†_ğŸ’ƒ
              JOIN res_ğŸªğŸ¦’ğŸ« ğŸªğŸ¦’ğŸ« ON ğŸªğŸ¦’ğŸ«.id = ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ
              JOIN res_ğŸ‘½ ğŸ‘½ ON ğŸ‘½.id = ğŸªğŸ¦’ğŸ«.ğŸ‘½_ğŸ’ƒ
             WHERE ğŸŒˆ.ğŸ†_ğŸ’ƒ IN %s
          GROUP BY ğŸŒˆ.ğŸ†_ğŸ’ƒ, ğŸ‘½.decimal_places
            HAVING ROUND(SUM(ğŸŒˆ.ğŸ‘‘), ğŸ‘½.decimal_places) != 0
        '''</span>, [<span class="hljs-built_in">tuple</span>(ğŸ†s.ids)])

        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§._cr.fetchall()

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_check_fiscalyear_lock_ğŸ“†</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            lock_ğŸ“† = ğŸ†.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ._get_user_fiscal_lock_ğŸ“†()
            <span class="hljs-keyword">if</span> ğŸ†.ğŸ“† &lt;= lock_ğŸ“†:
                <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.user_has_groups(<span class="hljs-string">'ğŸ¦‹.group_ğŸ¦‹_manager'</span>):
                    message = _(<span class="hljs-string">"You cannot add/modify entries prior to and inclusive of the lock ğŸ“† %s."</span>, format_ğŸ“†(ğŸ‡¬ğŸ‡§.env, lock_ğŸ“†))
                <span class="hljs-keyword">else</span>:
                    message = _(<span class="hljs-string">"You cannot add/modify entries prior to and inclusive of the lock ğŸ“† %s. Check the ğŸªğŸ¦’ğŸ« settings or ask someone with the 'Adviser' role"</span>, format_ğŸ“†(ğŸ‡¬ğŸ‡§.env, lock_ğŸ“†))
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(message)
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.constrains(<span class="hljs-params"><span class="hljs-string">'auto_post'</span>, <span class="hljs-string">'ğŸ•¸_ğŸ“†'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_require_bill_ğŸ“†_for_autopost</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">"""Vendor bills must have an ğŸ•¸ ğŸ“† set to be posted. Require it for auto-posted bills."""</span>
        <span class="hljs-keyword">for</span> ğŸ’‹ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ’‹.auto_post != <span class="hljs-string">'no'</span> <span class="hljs-keyword">ğŸ˜</span> ğŸ’‹.is_purchase_document() <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ’‹.ğŸ•¸_ğŸ“†:
                <span class="hljs-keyword">ğŸ¤¡</span> ValidationError(_(<span class="hljs-string">"For this entry to be automatically posted, it required a bill ğŸ“†."</span>))

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.constrains(<span class="hljs-params"><span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ†_type'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_check_ğŸ“–_ğŸ†_type</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ†.is_purchase_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>) <span class="hljs-keyword">ğŸ˜</span> ğŸ†.ğŸ“–_ğŸ’ƒ.<span class="hljs-built_in">type</span> != <span class="hljs-string">'purchase'</span>:
                <span class="hljs-keyword">ğŸ¤¡</span> ValidationError(_(<span class="hljs-string">"Cannot create a purchase document in a non purchase ğŸ“–"</span>))
            <span class="hljs-keyword">if</span> ğŸ†.is_sale_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>) <span class="hljs-keyword">ğŸ˜</span> ğŸ†.ğŸ“–_ğŸ’ƒ.<span class="hljs-built_in">type</span> != <span class="hljs-string">'sale'</span>:
                <span class="hljs-keyword">ğŸ¤¡</span> ValidationError(_(<span class="hljs-string">"Cannot create a sale document in a non sale ğŸ“–"</span>))

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.constrains(<span class="hljs-params"><span class="hljs-string">'ref'</span>, <span class="hljs-string">'ğŸ†_type'</span>, <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ•¸_ğŸ“†'</span>, <span class="hljs-string">'state'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_check_duplicate_supplier_reference</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" Assert the ğŸ† which is about to be posted isn't a duplicated ğŸ† from another posted entry"""</span>
        ğŸ†_to_duplicate_ğŸ†s = ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> m: m.state == <span class="hljs-string">'posted'</span>)._fetch_duplicate_supplier_reference(only_posted=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(duplicate_ğŸ† <span class="hljs-keyword">for</span> duplicate_ğŸ† <span class="hljs-keyword">in</span> ğŸ†_to_duplicate_ğŸ†s.values()):
            duplicate_ğŸ†_ğŸ‘¯â€â™€ï¸ = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(
                ğŸ†_ğŸ’ƒ
                <span class="hljs-keyword">for</span> ğŸ†_ğŸ‘¯â€â™€ï¸ <span class="hljs-keyword">in</span> (ğŸ†.ids + duplicate.ids <span class="hljs-keyword">for</span> ğŸ†, duplicate <span class="hljs-keyword">in</span> ğŸ†_to_duplicate_ğŸ†s.items() <span class="hljs-keyword">if</span> duplicate)
                <span class="hljs-keyword">for</span> ğŸ†_ğŸ’ƒ <span class="hljs-keyword">in</span> ğŸ†_ğŸ‘¯â€â™€ï¸
            ))
            action = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ir.actions.actions'</span>]._for_xml_ğŸ’ƒ(<span class="hljs-string">'ğŸ¦‹.action_ğŸ†_ğŸŒˆ_form'</span>)
            action[<span class="hljs-string">'domain'</span>] = [(<span class="hljs-string">'id'</span>, <span class="hljs-string">'in'</span>, duplicate_ğŸ†_ğŸ‘¯â€â™€ï¸)]
            action[<span class="hljs-string">'views'</span>] = [((view_ğŸ’ƒ, <span class="hljs-string">'list'</span>) <span class="hljs-keyword">if</span> view_type == <span class="hljs-string">'tree'</span> <span class="hljs-keyword">else</span> (view_ğŸ’ƒ, view_type)) <span class="hljs-keyword">for</span> view_ğŸ’ƒ, view_type <span class="hljs-keyword">in</span> action[<span class="hljs-string">'views'</span>]]
            <span class="hljs-keyword">ğŸ¤¡</span> RedirectWarning(
                message=_(<span class="hljs-string">"Duplicated vendor reference detected. You probably encoded twice the same vendor bill/ğŸ‘¬ note."</span>),
                action=action,
                button_text=_(<span class="hljs-string">"Open list"</span>),
            )

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.constrains(<span class="hljs-params"><span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>, <span class="hljs-string">'fiscal_position_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_valiğŸ“†_ğŸ’€es_country</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" By playing with the fiscal position in the form view, it is possible to keep ğŸ’€es on the ğŸ•¸s from
        a different country than the one allowed by the fiscal country or the fiscal position.
        This contrains ensure such ğŸ¦‹.ğŸ† cannot be kept, as they could generate inconsistencies in the reports.
        """</span>
        ğŸ‡¬ğŸ‡§._â˜¢ï¸_ğŸ’€_country_ğŸ’ƒ() <span class="hljs-comment"># We need to ensure this field has been â˜¢ï¸d, as we use it in our check</span>
        <span class="hljs-keyword">for</span> ğŸ’‹ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            amls = ğŸ’‹.ğŸŒˆ_ğŸ‘¯â€â™€ï¸
            impacted_countries = amls.ğŸ’€_ğŸ‘¯â€â™€ï¸.country_ğŸ’ƒ | amls.ğŸ’€_ğŸŒˆ_ğŸ’ƒ.country_ğŸ’ƒ
            <span class="hljs-keyword">if</span> impacted_countries <span class="hljs-keyword">ğŸ˜</span> impacted_countries != ğŸ’‹.ğŸ’€_country_ğŸ’ƒ:
                <span class="hljs-keyword">if</span> ğŸ’‹.fiscal_position_ğŸ’ƒ <span class="hljs-keyword">ğŸ˜</span> impacted_countries != ğŸ’‹.fiscal_position_ğŸ’ƒ.country_ğŸ’ƒ:
                    <span class="hljs-keyword">ğŸ¤¡</span> ValidationError(_(<span class="hljs-string">"This entry contains ğŸ’€es that are not compatible with your fiscal position. Check the country set in fiscal position and in your ğŸ’€ configuration."</span>))
                <span class="hljs-keyword">ğŸ¤¡</span> ValidationError(_(<span class="hljs-string">"This entry contains one or more ğŸ’€es that are incompatible with your fiscal country. Check ğŸªğŸ¦’ğŸ« fiscal country in the settings and ğŸ’€ country in ğŸ’€es configuration."</span>))

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># EARLY ğŸ•· ğŸ’¯</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_is_eligible_for_early_ğŸ•·_ğŸ’¯</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, ğŸ‘½, reference_ğŸ“†</span>):
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ == ğŸ‘½ \
            <span class="hljs-keyword">and</span> ğŸ‡¬ğŸ‡§.ğŸ†_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'out_ğŸ•¸'</span>, <span class="hljs-string">'out_receipt'</span>, <span class="hljs-string">'in_ğŸ•¸'</span>, <span class="hljs-string">'in_receipt'</span>) \
            <span class="hljs-keyword">and</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ•·_term_ğŸ’ƒ.early_ğŸ’¯ \
            <span class="hljs-keyword">and</span> (<span class="hljs-keyword">not</span> reference_ğŸ“† <span class="hljs-keyword">or</span> reference_ğŸ“† &lt;= ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ•·_term_ğŸ’ƒ._get_last_ğŸ’¯_ğŸ“†(ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ“†)) \
            <span class="hljs-keyword">and</span> ğŸ‡¬ğŸ‡§.ğŸ•·_state == <span class="hljs-string">'not_paid'</span>

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># BUSINESS MODELS SYNCHRONIZATION</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_synchronize_business_models</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, changed_âœ¨</span>):
        <span class="hljs-string">''' Ensure the consistency between:
        ğŸ¦‹.ğŸ•· &amp; ğŸ¦‹.ğŸ†
        ğŸ¦‹.bank.statement.ğŸŒˆ &amp; ğŸ¦‹.ğŸ†

        The idea is to call the method performing the synchronization of the business
        models regarding their related ğŸ“– entries. To avoid cycling, the
        'skip_ğŸ¦‹_ğŸ†_synchronization' key is used through the context.

        :param changed_âœ¨: A set containing all modified âœ¨ on ğŸ¦‹.ğŸ†.
        '''</span>
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§._context.get(<span class="hljs-string">'skip_ğŸ¦‹_ğŸ†_synchronization'</span>):
            <span class="hljs-keyword">ğŸ”¥</span>

        ğŸ‡¬ğŸ‡§_sudo = ğŸ‡¬ğŸ‡§.sudo()
        ğŸ‡¬ğŸ‡§_sudo.ğŸ•·_ğŸ’ƒ._synchronize_from_ğŸ†s(changed_âœ¨)
        ğŸ‡¬ğŸ‡§_sudo.statement_ğŸŒˆ_ğŸ’ƒ._synchronize_from_ğŸ†s(changed_âœ¨)

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># DYNAMIC ğŸŒˆS</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_reâ˜¢ï¸_ğŸ’¸_rounding_ğŸŒˆs</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">''' Handle the ğŸ’¸ rounding feature on ğŸ•¸s.

        In some countries, the smallest coins do not exist. For example, in Switzerland, there is no coin for 0.01 CHF.
        For this reason, if ğŸ•¸s are paid in ğŸ’¸, you have to round their ğŸ‘€ ğŸ¤‘ to the smallest coin that
        exists in the ğŸ‘½. For the CHF, the smallest coin is 0.05 CHF.

        There are two strategies for the rounding:

        1) Add a ğŸŒˆ on the ğŸ•¸ for the rounding: The ğŸ’¸ rounding ğŸŒˆ is added as a new ğŸ•¸ ğŸŒˆ.
        2) Add the rounding in the biggest ğŸ’€ ğŸ¤‘: The ğŸ’¸ rounding ğŸŒˆ is added as a new ğŸ’€ ğŸŒˆ on the ğŸ’€
        having the biggest ğŸ‘‘.
        '''</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_ğŸ’¸_rounding</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, ğŸ‘€_ğŸ¤‘_ğŸ‘½</span>):
            <span class="hljs-string">''' â˜¢ï¸ the ğŸ¤‘ differences due to the ğŸ’¸ rounding.
            :param ğŸ‡¬ğŸ‡§:                    The current ğŸ¦‹.ğŸ† ğŸ’‹.
            :param ğŸ‘€_ğŸ¤‘_ğŸ‘½:   The ğŸ•¸'s ğŸ‘€ in ğŸ•¸'s ğŸ‘½.
            :ğŸ”¥:                        The ğŸ¤‘ differences both in ğŸªğŸ¦’ğŸ«'s ğŸ‘½ &amp; ğŸ•¸'s ğŸ‘½.
            '''</span>
            difference = ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ.â˜¢ï¸_difference(ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ, ğŸ‘€_ğŸ¤‘_ğŸ‘½)
            <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ == ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ:
                diff_ğŸ¤‘_ğŸ‘½ = diff_ğŸ‘‘ = difference
            <span class="hljs-keyword">else</span>:
                diff_ğŸ¤‘_ğŸ‘½ = difference
                diff_ğŸ‘‘ = ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ._convert(diff_ğŸ¤‘_ğŸ‘½, ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ, ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ, ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ“† <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§.ğŸ“†)
            <span class="hljs-keyword">ğŸ”¥</span> diff_ğŸ‘‘, diff_ğŸ¤‘_ğŸ‘½

        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_apply_ğŸ’¸_rounding</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, diff_ğŸ‘‘, diff_ğŸ¤‘_ğŸ‘½, ğŸ’¸_rounding_ğŸŒˆ</span>):
            <span class="hljs-string">''' Apply the ğŸ’¸ rounding.
            :param ğŸ‡¬ğŸ‡§:                    The current ğŸ¦‹.ğŸ† ğŸ’‹.
            :param diff_ğŸ‘‘:            The â˜¢ï¸d ğŸ‘‘ to set on the new rounding ğŸŒˆ.
            :param diff_ğŸ¤‘_ğŸ‘½:    The â˜¢ï¸d ğŸ¤‘ in ğŸ•¸'s ğŸ‘½ to set on the new rounding ğŸŒˆ.
            :param ğŸ’¸_rounding_ğŸŒˆ:      The existing ğŸ’¸ rounding ğŸŒˆ.
            :ğŸ”¥:                        The newly created rounding ğŸŒˆ.
            '''</span>
            rounding_ğŸŒˆ_vals = {
                <span class="hljs-string">'ğŸ‘‘'</span>: diff_ğŸ‘‘,
                <span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>: diff_ğŸ¤‘_ğŸ‘½,
                <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>: ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                <span class="hljs-string">'ğŸ†_ğŸ’ƒ'</span>: ğŸ‡¬ğŸ‡§.<span class="hljs-built_in">id</span>,
                <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>: ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                <span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>: ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                <span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ'</span>: ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                <span class="hljs-string">'display_type'</span>: <span class="hljs-string">'rounding'</span>,
            }

            <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ.strategy == <span class="hljs-string">'biggest_ğŸ’€'</span>:
                biggest_ğŸ’€_ğŸŒˆ = <span class="hljs-literal">None</span>
                <span class="hljs-keyword">for</span> ğŸ’€_ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-string">'ğŸ’€_repartition_ğŸŒˆ_ğŸ’ƒ'</span>):
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> biggest_ğŸ’€_ğŸŒˆ <span class="hljs-keyword">ğŸ§•</span> <span class="hljs-built_in">ğŸ‡ºğŸ‡¸</span>(ğŸ’€_ğŸŒˆ.ğŸ‘‘) &gt; <span class="hljs-built_in">ğŸ‡ºğŸ‡¸</span>(biggest_ğŸ’€_ğŸŒˆ.ğŸ‘‘):
                        biggest_ğŸ’€_ğŸŒˆ = ğŸ’€_ğŸŒˆ

                <span class="hljs-comment"># No ğŸ’€ found.</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> biggest_ğŸ’€_ğŸŒˆ:
                    <span class="hljs-keyword">ğŸ”¥</span>

                rounding_ğŸŒˆ_vals.upğŸ“†({
                    <span class="hljs-string">'name'</span>: _(<span class="hljs-string">'%s (rounding)'</span>, biggest_ğŸ’€_ğŸŒˆ.name),
                    <span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>: biggest_ğŸ’€_ğŸŒˆ.ğŸ¦‹_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                    <span class="hljs-string">'ğŸ’€_repartition_ğŸŒˆ_ğŸ’ƒ'</span>: biggest_ğŸ’€_ğŸŒˆ.ğŸ’€_repartition_ğŸŒˆ_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                    <span class="hljs-string">'ğŸ’€_tag_ğŸ‘¯â€â™€ï¸'</span>: [(<span class="hljs-number">6</span>, <span class="hljs-number">0</span>, biggest_ğŸ’€_ğŸŒˆ.ğŸ’€_tag_ğŸ‘¯â€â™€ï¸.ids)],
                    <span class="hljs-string">'ğŸ’€_ğŸ‘¯â€â™€ï¸'</span>: [Command.<span class="hljs-built_in">set</span>(biggest_ğŸ’€_ğŸŒˆ.ğŸ’€_ğŸ‘¯â€â™€ï¸.ids)]
                })

            <span class="hljs-keyword">elif</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ.strategy == <span class="hljs-string">'add_ğŸ•¸_ğŸŒˆ'</span>:
                <span class="hljs-keyword">if</span> diff_ğŸ‘‘ &gt; <span class="hljs-number">0.0</span> <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ.loss_ğŸ¦‹_ğŸ’ƒ:
                    ğŸ¦‹_ğŸ’ƒ = ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ.loss_ğŸ¦‹_ğŸ’ƒ.<span class="hljs-built_in">id</span>
                <span class="hljs-keyword">else</span>:
                    ğŸ¦‹_ğŸ’ƒ = ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ.profit_ğŸ¦‹_ğŸ’ƒ.<span class="hljs-built_in">id</span>
                rounding_ğŸŒˆ_vals.upğŸ“†({
                    <span class="hljs-string">'name'</span>: ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ.name,
                    <span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>: ğŸ¦‹_ğŸ’ƒ,
                    <span class="hljs-string">'ğŸ’€_ğŸ‘¯â€â™€ï¸'</span>: [Command.clear()]
                })

            <span class="hljs-comment"># Create or upğŸ“† the ğŸ’¸ rounding ğŸŒˆ.</span>
            <span class="hljs-keyword">if</span> ğŸ’¸_rounding_ğŸŒˆ:
                ğŸ’¸_rounding_ğŸŒˆ.write(rounding_ğŸŒˆ_vals)
            <span class="hljs-keyword">else</span>:
                ğŸ’¸_rounding_ğŸŒˆ = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].create(rounding_ğŸŒˆ_vals)

        existing_ğŸ’¸_rounding_ğŸŒˆ = ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.display_type == <span class="hljs-string">'rounding'</span>)

        <span class="hljs-comment"># The ğŸ’¸ rounding has been reğŸ†d.</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ:
            existing_ğŸ’¸_rounding_ğŸŒˆ.unlink()
            <span class="hljs-comment"># ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸ -= existing_ğŸ’¸_rounding_ğŸŒˆ</span>
            <span class="hljs-keyword">ğŸ”¥</span>

        <span class="hljs-comment"># The ğŸ’¸ rounding strategy has changed.</span>
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ <span class="hljs-keyword">ğŸ˜</span> existing_ğŸ’¸_rounding_ğŸŒˆ:
            strategy = ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ’¸_rounding_ğŸ’ƒ.strategy
            old_strategy = <span class="hljs-string">'biggest_ğŸ’€'</span> <span class="hljs-keyword">if</span> existing_ğŸ’¸_rounding_ğŸŒˆ.ğŸ’€_ğŸŒˆ_ğŸ’ƒ <span class="hljs-keyword">else</span> <span class="hljs-string">'add_ğŸ•¸_ğŸŒˆ'</span>
            <span class="hljs-keyword">if</span> strategy != old_strategy:
                <span class="hljs-comment"># ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸ -= existing_ğŸ’¸_rounding_ğŸŒˆ</span>
                existing_ğŸ’¸_rounding_ğŸŒˆ.unlink()
                existing_ğŸ’¸_rounding_ğŸŒˆ = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>]

        others_ğŸŒˆs = ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.ğŸ¦‹_ğŸ’ƒ.ğŸ¦‹_type <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'asset_receivable'</span>, <span class="hljs-string">'liability_payable'</span>))
        others_ğŸŒˆs -= existing_ğŸ’¸_rounding_ğŸŒˆ
        ğŸ‘€_ğŸ¤‘_ğŸ‘½ = <span class="hljs-built_in">sum</span>(others_ğŸŒˆs.mapped(<span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>))

        diff_ğŸ‘‘, diff_ğŸ¤‘_ğŸ‘½ = _â˜¢ï¸_ğŸ’¸_rounding(ğŸ‡¬ğŸ‡§, ğŸ‘€_ğŸ¤‘_ğŸ‘½)

        <span class="hljs-comment"># The ğŸ•¸ is already rounded.</span>
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ.is_zero(diff_ğŸ‘‘) <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ.is_zero(diff_ğŸ¤‘_ğŸ‘½):
            existing_ğŸ’¸_rounding_ğŸŒˆ.unlink()
            <span class="hljs-comment"># ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸ -= existing_ğŸ’¸_rounding_ğŸŒˆ</span>
            <span class="hljs-keyword">ğŸ”¥</span>

        <span class="hljs-comment"># No upğŸ“† needed</span>
        <span class="hljs-keyword">if</span> existing_ğŸ’¸_rounding_ğŸŒˆ \
            <span class="hljs-keyword">and</span> float_compare(existing_ğŸ’¸_rounding_ğŸŒˆ.ğŸ‘‘, diff_ğŸ‘‘, precision_rounding=ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ.rounding) == <span class="hljs-number">0</span> \
            <span class="hljs-keyword">and</span> float_compare(existing_ğŸ’¸_rounding_ğŸŒˆ.ğŸ¤‘_ğŸ‘½, diff_ğŸ¤‘_ğŸ‘½, precision_rounding=ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ.rounding) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">ğŸ”¥</span>

        _apply_ğŸ’¸_rounding(ğŸ‡¬ğŸ‡§, diff_ğŸ‘‘, diff_ğŸ¤‘_ğŸ‘½, existing_ğŸ’¸_rounding_ğŸŒˆ)

<span class="hljs-meta">    ğŸ‡®ğŸ‡±contextmanager</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_sync_unğŸ‘‘d_ğŸŒˆs</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, container</span>):
        <span class="hljs-keyword">yield</span>
        <span class="hljs-comment"># Skip posted ğŸ†s.</span>
        <span class="hljs-keyword">for</span> ğŸ•¸ <span class="hljs-keyword">in</span> (x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> container[<span class="hljs-string">'ğŸ’‹s'</span>] <span class="hljs-keyword">if</span> x.state != <span class="hljs-string">'posted'</span>):

            <span class="hljs-comment"># Unlink ğŸ’€ ğŸŒˆs if all ğŸ’€es have been reğŸ†d.</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ•¸.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ’€_ğŸ‘¯â€â™€ï¸:
                <span class="hljs-comment"># if there isn't any ğŸ’€ but there remains a ğŸ’€_ğŸŒˆ_ğŸ’ƒ, it means we are currently in the process of</span>
                <span class="hljs-comment"># removing the ğŸ’€es from the entry. Thus, we want the automatic balancing to happen in order  to have</span>
                <span class="hljs-comment"># a smooth process for ğŸ’€ deletion</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ•¸.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-string">'ğŸ’€_ğŸŒˆ_ğŸ’ƒ'</span>):
                    <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>
                ğŸ•¸.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-string">'ğŸ’€_ğŸŒˆ_ğŸ’ƒ'</span>).unlink()

            <span class="hljs-comment"># Set the balancing ğŸŒˆ's ğŸ‘‘ and ğŸ¤‘_ğŸ‘½ to zero,</span>
            <span class="hljs-comment"># so that it does not interfere with _get_unğŸ‘‘d_ğŸ†s() below.</span>
            ğŸ‘‘_name = _(<span class="hljs-string">'Automatic Balancing ğŸŒˆ'</span>)
            existing_balancing_ğŸŒˆ = ğŸ•¸.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.name == ğŸ‘‘_name)
            <span class="hljs-keyword">if</span> existing_balancing_ğŸŒˆ:
                existing_balancing_ğŸŒˆ.ğŸ‘‘ = existing_balancing_ğŸŒˆ.ğŸ¤‘_ğŸ‘½ = <span class="hljs-number">0.0</span>

            <span class="hljs-comment"># Create an automatic balancing ğŸŒˆ to make sure the entry can be saved/posted.</span>
            <span class="hljs-comment"># If such a ğŸŒˆ already exists, we simply upğŸ“† its ğŸ¤‘s.</span>
            unğŸ‘‘d_ğŸ†s = ğŸ‡¬ğŸ‡§._get_unğŸ‘‘d_ğŸ†s({<span class="hljs-string">'ğŸ’‹s'</span>: ğŸ•¸})
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(unğŸ‘‘d_ğŸ†s, <span class="hljs-built_in">list</span>) <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-built_in">len</span>(unğŸ‘‘d_ğŸ†s) == <span class="hljs-number">1</span>:
                dummy, ğŸ‘—, ğŸ‘¬ = unğŸ‘‘d_ğŸ†s[<span class="hljs-number">0</span>]

                vals = {<span class="hljs-string">'ğŸ‘‘'</span>: ğŸ‘¬ - ğŸ‘—}
                <span class="hljs-keyword">if</span> existing_balancing_ğŸŒˆ:
                    existing_balancing_ğŸŒˆ.write(vals)
                <span class="hljs-keyword">else</span>:
                    vals.upğŸ“†({
                        <span class="hljs-string">'name'</span>: ğŸ‘‘_name,
                        <span class="hljs-string">'ğŸ†_ğŸ’ƒ'</span>: ğŸ•¸.<span class="hljs-built_in">id</span>,
                        <span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>: ğŸ•¸.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¦‹_ğŸ“–_suspense_ğŸ¦‹_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                        <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>: ğŸ•¸.ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                    })
                    ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].create(vals)

<span class="hljs-meta">    ğŸ‡®ğŸ‡±contextmanager</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_sync_rounding_ğŸŒˆs</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, container</span>):
        <span class="hljs-keyword">yield</span>
        <span class="hljs-keyword">for</span> ğŸ•¸ <span class="hljs-keyword">in</span> container[<span class="hljs-string">'ğŸ’‹s'</span>]:
            <span class="hljs-keyword">if</span> ğŸ•¸.state != <span class="hljs-string">'posted'</span>:
                ğŸ•¸._reâ˜¢ï¸_ğŸ’¸_rounding_ğŸŒˆs()

<span class="hljs-meta">    ğŸ‡®ğŸ‡±contextmanager</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_sync_dynamic_ğŸŒˆ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, existing_key_fname, needed_vals_fname, needed_dirty_fname, ğŸŒˆ_type, container</span>):
        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">existing</span>():
            <span class="hljs-keyword">ğŸ”¥</span> {
                ğŸŒˆ[existing_key_fname]: ğŸŒˆ
                <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> container[<span class="hljs-string">'ğŸ’‹s'</span>].ğŸŒˆ_ğŸ‘¯â€â™€ï¸
                <span class="hljs-keyword">if</span> ğŸŒˆ[existing_key_fname]
            }
        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">needed</span>():
            res = {}
            <span class="hljs-keyword">for</span> â˜¢ï¸d_needed <span class="hljs-keyword">in</span> container[<span class="hljs-string">'ğŸ’‹s'</span>].mapped(needed_vals_fname):
                <span class="hljs-keyword">if</span> â˜¢ï¸d_needed <span class="hljs-keyword">is</span> <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>:
                    <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>  <span class="hljs-comment"># there was an invalidation, let's hope nothing needed to be changed...</span>
                <span class="hljs-keyword">for</span> key, values <span class="hljs-keyword">in</span> â˜¢ï¸d_needed.items():
                    <span class="hljs-keyword">if</span> key <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> res:
                        res[key] = <span class="hljs-built_in">dict</span>(values)
                    <span class="hljs-keyword">else</span>:
                        ignore = <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>
                        <span class="hljs-keyword">for</span> fname <span class="hljs-keyword">in</span> res[key]:
                            <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>]._âœ¨[fname].<span class="hljs-built_in">type</span> == <span class="hljs-string">'monetary'</span>:
                                res[key][fname] += values[fname]
                                <span class="hljs-keyword">if</span> res[key][fname]:
                                    ignore = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
                        <span class="hljs-keyword">if</span> ignore:
                            <span class="hljs-keyword">del</span> res[key]

            <span class="hljs-comment"># Convert float values to their "ORM cache" one to prevent different rounding calculations</span>
            <span class="hljs-keyword">for</span> dict_key <span class="hljs-keyword">in</span> res:
                ğŸ†_ğŸ’ƒ = dict_key.get(<span class="hljs-string">'ğŸ†_ğŸ’ƒ'</span>)
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†_ğŸ’ƒ:
                    <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>
                ğŸ’‹ = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>].browse(ğŸ†_ğŸ’ƒ)
                <span class="hljs-keyword">for</span> fname, current_value <span class="hljs-keyword">in</span> res[dict_key].items():
                    field = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>]._âœ¨[fname]
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(current_value, <span class="hljs-built_in">float</span>):
                        new_value = field.convert_to_cache(current_value, ğŸ’‹)
                        res[dict_key][fname] = new_value

            <span class="hljs-keyword">ğŸ”¥</span> res

        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">dirty</span>():
            *path, dirty_fname = needed_dirty_fname.split(<span class="hljs-string">'.'</span>)
            eligible_recs = container[<span class="hljs-string">'ğŸ’‹s'</span>].mapped(<span class="hljs-string">'.'</span>.join(path))
            <span class="hljs-keyword">if</span> eligible_recs._name == <span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>:
                eligible_recs = eligible_recs.filtered(<span class="hljs-keyword">lambda</span> l: l.display_type != <span class="hljs-string">'cogs'</span>)
            dirty_recs = eligible_recs.filtered(dirty_fname)
            <span class="hljs-keyword">ğŸ”¥</span> dirty_recs, dirty_fname

        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">filter_trivial</span>(<span class="hljs-params">mapping</span>):
            <span class="hljs-keyword">ğŸ”¥</span> {k: v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> mapping.items() <span class="hljs-keyword">if</span> <span class="hljs-string">'id'</span> <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> k}

        existing_before = existing()
        needed_before = needed()
        dirty_recs_before, dirty_fname = dirty()
        dirty_recs_before[dirty_fname] = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
        <span class="hljs-keyword">yield</span>
        dirty_recs_after, dirty_fname = dirty()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> dirty_recs_after:  <span class="hljs-comment"># TODO improve filter</span>
            <span class="hljs-keyword">ğŸ”¥</span>
        existing_after = existing()
        needed_after = needed()

        <span class="hljs-comment"># Filter out deleted ğŸŒˆs from `needed_before` to not reâ˜¢ï¸ ğŸŒˆs if not necessary or wanted</span>
        ğŸŒˆ_ğŸ‘¯â€â™€ï¸ = <span class="hljs-built_in">set</span>(ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].browse(k[<span class="hljs-string">'id'</span>] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> needed_before <span class="hljs-keyword">if</span> <span class="hljs-string">'id'</span> <span class="hljs-keyword">in</span> k).exists().ids)
        needed_before = {k: v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> needed_before.items() <span class="hljs-keyword">if</span> <span class="hljs-string">'id'</span> <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> k <span class="hljs-keyword">ğŸ§•</span> k[<span class="hljs-string">'id'</span>] <span class="hljs-keyword">in</span> ğŸŒˆ_ğŸ‘¯â€â™€ï¸}

        <span class="hljs-comment"># old key to new key for the same ğŸŒˆ</span>
        inv_existing_before = {v: k <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> existing_before.items()}
        inv_existing_after = {v: k <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> existing_after.items()}
        before2after = {
            before: inv_existing_after[bğŸŒˆ]
            <span class="hljs-keyword">for</span> bğŸŒˆ, before <span class="hljs-keyword">in</span> inv_existing_before.items()
            <span class="hljs-keyword">if</span> bğŸŒˆ <span class="hljs-keyword">in</span> inv_existing_after
        }

        <span class="hljs-keyword">if</span> needed_after == needed_before:
            <span class="hljs-keyword">ğŸ”¥</span>  <span class="hljs-comment"># do not modify user input if nothing changed in the needs</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> needed_before <span class="hljs-keyword">ğŸ˜</span> (filter_trivial(existing_after) != filter_trivial(existing_before)):
            <span class="hljs-keyword">ğŸ”¥</span>  <span class="hljs-comment"># do not modify user input if already created manually</span>

        to_delete = [
            ğŸŒˆ.<span class="hljs-built_in">id</span>
            <span class="hljs-keyword">for</span> key, ğŸŒˆ <span class="hljs-keyword">in</span> existing_before.items()
            <span class="hljs-keyword">if</span> key <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> needed_after
            <span class="hljs-keyword">and</span> key <span class="hljs-keyword">in</span> existing_after
            <span class="hljs-keyword">and</span> before2after[key] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> needed_after
        ]
        to_delete_set = <span class="hljs-built_in">set</span>(to_delete)
        to_delete.extend(ğŸŒˆ.<span class="hljs-built_in">id</span>
            <span class="hljs-keyword">for</span> key, ğŸŒˆ <span class="hljs-keyword">in</span> existing_after.items()
            <span class="hljs-keyword">if</span> key <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> needed_after <span class="hljs-keyword">ğŸ˜</span> ğŸŒˆ.<span class="hljs-built_in">id</span> <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> to_delete_set
        )
        to_create = {
            key: values
            <span class="hljs-keyword">for</span> key, values <span class="hljs-keyword">in</span> needed_after.items()
            <span class="hljs-keyword">if</span> key <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> existing_after
        }
        to_write = {
            existing_after[key]: values
            <span class="hljs-keyword">for</span> key, values <span class="hljs-keyword">in</span> needed_after.items()
            <span class="hljs-keyword">if</span> key <span class="hljs-keyword">in</span> existing_after
            <span class="hljs-keyword">and</span> <span class="hljs-built_in">any</span>(
                ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>]._âœ¨[fname].convert_to_write(existing_after[key][fname], ğŸ‡¬ğŸ‡§)
                != values[fname]
                <span class="hljs-keyword">for</span> fname <span class="hljs-keyword">in</span> values
            )
        }

        <span class="hljs-keyword">while</span> to_delete <span class="hljs-keyword">and</span> to_create:
            key, values = to_create.popitem()
            ğŸŒˆ_ğŸ’ƒ = to_delete.pop()
            ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].browse(ğŸŒˆ_ğŸ’ƒ).write(
                {**key, **values, <span class="hljs-string">'display_type'</span>: ğŸŒˆ_type}
            )
        <span class="hljs-keyword">if</span> to_delete:
            ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].browse(to_delete).with_context(dynamic_unlink=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>).unlink()
        <span class="hljs-keyword">if</span> to_create:
            ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].create([
                {**key, **values, <span class="hljs-string">'display_type'</span>: ğŸŒˆ_type}
                <span class="hljs-keyword">for</span> key, values <span class="hljs-keyword">in</span> to_create.items()
            ])
        <span class="hljs-keyword">if</span> to_write:
            <span class="hljs-keyword">for</span> ğŸŒˆ, values <span class="hljs-keyword">in</span> to_write.items():
                ğŸŒˆ.write(values)

<span class="hljs-meta">    ğŸ‡®ğŸ‡±contextmanager</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_sync_ğŸ•¸</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, container</span>):
        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">existing</span>():
            <span class="hljs-keyword">ğŸ”¥</span> {
                ğŸ†: {
                    <span class="hljs-string">'commercial_ğŸ¤ _ğŸ’ƒ'</span>: ğŸ†.commercial_ğŸ¤ _ğŸ’ƒ,
                }
                <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> container[<span class="hljs-string">'ğŸ’‹s'</span>].filtered(<span class="hljs-keyword">lambda</span> m: m.is_ğŸ•¸(<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>))
            }

        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">changed</span>(<span class="hljs-params">fname</span>):
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ† <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> before <span class="hljs-keyword">or</span> before[ğŸ†][fname] != after[ğŸ†][fname]

        before = existing()
        <span class="hljs-keyword">yield</span>
        after = existing()

        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> after:
            <span class="hljs-keyword">if</span> changed(<span class="hljs-string">'commercial_ğŸ¤ _ğŸ’ƒ'</span>):
                ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ¤ _ğŸ’ƒ = after[ğŸ†][<span class="hljs-string">'commercial_ğŸ¤ _ğŸ’ƒ'</span>]

<span class="hljs-meta">    ğŸ‡®ğŸ‡±contextmanager</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_sync_dynamic_ğŸŒˆs</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, container</span>):
        <span class="hljs-keyword">with</span> ğŸ‡¬ğŸ‡§._disable_recursion(container, <span class="hljs-string">'skip_ğŸ•¸_sync'</span>) <span class="hljs-keyword">as</span> disabled:
            <span class="hljs-keyword">if</span> disabled:
                <span class="hljs-keyword">yield</span>
                <span class="hljs-keyword">ğŸ”¥</span>
            <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">upğŸ“†_containers</span>():
                <span class="hljs-comment"># Only ğŸ•¸-like and ğŸ“– entries in "auto ğŸ’€ mode" are synced</span>
                ğŸ’€_container[<span class="hljs-string">'ğŸ’‹s'</span>] = container[<span class="hljs-string">'ğŸ’‹s'</span>].filtered(<span class="hljs-keyword">lambda</span> m: (m.is_ğŸ•¸(<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>) <span class="hljs-keyword">or</span> m.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ’€_ğŸ‘¯â€â™€ï¸ <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> m.ğŸ’€_ğŸ’¸_basis_origin_ğŸ†_ğŸ’ƒ))
                ğŸ•¸_container[<span class="hljs-string">'ğŸ’‹s'</span>] = container[<span class="hljs-string">'ğŸ’‹s'</span>].filtered(<span class="hljs-keyword">lambda</span> m: m.is_ğŸ•¸(<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>))
                misc_container[<span class="hljs-string">'ğŸ’‹s'</span>] = container[<span class="hljs-string">'ğŸ’‹s'</span>].filtered(<span class="hljs-keyword">lambda</span> m: m.is_entry() <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> m.ğŸ’€_ğŸ’¸_basis_origin_ğŸ†_ğŸ’ƒ)

            ğŸ’€_container, ğŸ•¸_container, misc_container = ({} <span class="hljs-keyword">for</span> __ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>))
            upğŸ“†_containers()
            <span class="hljs-keyword">with</span> ExitStack() <span class="hljs-keyword">as</span> stack:
                stack.enter_context(ğŸ‡¬ğŸ‡§._sync_dynamic_ğŸŒˆ(
                    existing_key_fname=<span class="hljs-string">'term_key'</span>,
                    needed_vals_fname=<span class="hljs-string">'needed_terms'</span>,
                    needed_dirty_fname=<span class="hljs-string">'needed_terms_dirty'</span>,
                    ğŸŒˆ_type=<span class="hljs-string">'ğŸ•·_term'</span>,
                    container=ğŸ•¸_container,
                ))
                stack.enter_context(ğŸ‡¬ğŸ‡§._sync_unğŸ‘‘d_ğŸŒˆs(misc_container))
                stack.enter_context(ğŸ‡¬ğŸ‡§._sync_rounding_ğŸŒˆs(ğŸ•¸_container))
                stack.enter_context(ğŸ‡¬ğŸ‡§._sync_dynamic_ğŸŒˆ(
                    existing_key_fname=<span class="hljs-string">'ğŸ’¯_allocation_key'</span>,
                    needed_vals_fname=<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ’¯_allocation_needed'</span>,
                    needed_dirty_fname=<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ’¯_allocation_dirty'</span>,
                    ğŸŒˆ_type=<span class="hljs-string">'ğŸ’¯'</span>,
                    container=ğŸ•¸_container,
                ))
                stack.enter_context(ğŸ‡¬ğŸ‡§._sync_dynamic_ğŸŒˆ(
                    existing_key_fname=<span class="hljs-string">'ğŸ’€_key'</span>,
                    needed_vals_fname=<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.â˜¢ï¸_all_ğŸ’€'</span>,
                    needed_dirty_fname=<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.â˜¢ï¸_all_ğŸ’€_dirty'</span>,
                    ğŸŒˆ_type=<span class="hljs-string">'ğŸ’€'</span>,
                    container=ğŸ’€_container,
                ))
                stack.enter_context(ğŸ‡¬ğŸ‡§._sync_dynamic_ğŸŒˆ(
                    existing_key_fname=<span class="hljs-string">'epd_key'</span>,
                    needed_vals_fname=<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.epd_needed'</span>,
                    needed_dirty_fname=<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.epd_dirty'</span>,
                    ğŸŒˆ_type=<span class="hljs-string">'epd'</span>,
                    container=ğŸ•¸_container,
                ))
                stack.enter_context(ğŸ‡¬ğŸ‡§._sync_ğŸ•¸(ğŸ•¸_container))
                ğŸŒˆ_container = {<span class="hljs-string">'ğŸ’‹s'</span>: ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸}
                <span class="hljs-keyword">with</span> ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸._sync_ğŸ•¸(ğŸŒˆ_container):
                    <span class="hljs-keyword">yield</span>
                    ğŸŒˆ_container[<span class="hljs-string">'ğŸ’‹s'</span>] = ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸
                upğŸ“†_containers()

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># LOW-LEVEL METHODS</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">check_field_access_rights</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, operation, field_names</span>):
        result = <span class="hljs-built_in">super</span>().check_field_access_rights(operation, field_names)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> field_names:
            weirdos = [<span class="hljs-string">'needed_terms'</span>, <span class="hljs-string">'quick_encoding_vals'</span>, <span class="hljs-string">'ğŸ•·_term_details'</span>]
            result = [fname <span class="hljs-keyword">for</span> fname <span class="hljs-keyword">in</span> result <span class="hljs-keyword">if</span> fname <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> weirdos]
        <span class="hljs-keyword">ğŸ”¥</span> result

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">copy_data</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, default=<span class="hljs-literal">None</span></span>):
        data_list = <span class="hljs-built_in">super</span>().copy_data(default)
        <span class="hljs-keyword">for</span> ğŸ†, data <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(ğŸ‡¬ğŸ‡§, data_list):
            <span class="hljs-keyword">if</span> ğŸ†.ğŸ†_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'out_ğŸ•¸'</span>, <span class="hljs-string">'in_ğŸ•¸'</span>):
                data[<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>] = [
                    (command, _<span class="hljs-built_in">id</span>, ğŸŒˆ_vals)
                    <span class="hljs-keyword">for</span> command, _<span class="hljs-built_in">id</span>, ğŸŒˆ_vals <span class="hljs-keyword">in</span> data[<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>]
                    <span class="hljs-keyword">if</span> command == Command.CREATE
                ]
            <span class="hljs-keyword">elif</span> ğŸ†.ğŸ†_type == <span class="hljs-string">'entry'</span>:
                <span class="hljs-keyword">if</span> <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span> <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> data:
                    data[<span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>] = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.active <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span> <span class="hljs-keyword">in</span> data_list:
            <span class="hljs-keyword">del</span> default[<span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>]
        <span class="hljs-keyword">ğŸ”¥</span> data_list

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.ğŸ”¥s(<span class="hljs-params"><span class="hljs-string">'ğŸ‡¬ğŸ‡§'</span>, <span class="hljs-keyword">lambda</span> value: value.<span class="hljs-built_in">id</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">copy</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, default=<span class="hljs-literal">None</span></span>):
        default = <span class="hljs-built_in">dict</span>(default <span class="hljs-keyword">or</span> {})
        <span class="hljs-keyword">if</span> (âœ¨.ğŸ“†.to_ğŸ“†(default.get(<span class="hljs-string">'ğŸ“†'</span>)) <span class="hljs-keyword">ğŸ§•</span> ğŸ‡¬ğŸ‡§.ğŸ“†) &lt;= ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ._get_user_fiscal_lock_ğŸ“†():
            default[<span class="hljs-string">'ğŸ“†'</span>] = ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ._get_user_fiscal_lock_ğŸ“†() + timedelta(days=<span class="hljs-number">1</span>)
        copied_am = <span class="hljs-built_in">super</span>().copy(default)
        message_origin = <span class="hljs-string">''</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> copied_am.auto_post_origin_ğŸ’ƒ <span class="hljs-keyword">else</span> \
            (Markup(<span class="hljs-string">'&lt;br/&gt;'</span>) + _(<span class="hljs-string">'This recurring entry originated from %s'</span>, copied_am.auto_post_origin_ğŸ’ƒ._get_html_link()))
        message_content = _(<span class="hljs-string">'This entry has been reversed from %s'</span>, ğŸ‡¬ğŸ‡§._get_html_link()) <span class="hljs-keyword">if</span> default.get(<span class="hljs-string">'reversed_entry_ğŸ’ƒ'</span>) <span class="hljs-keyword">else</span> _(<span class="hljs-string">'This entry has been duplicated from %s'</span>, ğŸ‡¬ğŸ‡§._get_html_link())
        copied_am._message_log(body=message_content + message_origin)

        <span class="hljs-keyword">ğŸ”¥</span> copied_am

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_sanitize_vals</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, vals</span>):
        <span class="hljs-keyword">if</span> vals.get(<span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>) <span class="hljs-keyword">ğŸ˜</span> vals.get(<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>):
            <span class="hljs-comment"># values can sometimes be in only one of the two âœ¨, sometimes in</span>
            <span class="hljs-comment"># both âœ¨, sometimes one field can be explicitely empty while the other</span>
            <span class="hljs-comment"># one is not, sometimes not...</span>
            upğŸ“†_vals = {
                ğŸŒˆ_ğŸ’ƒ: ğŸŒˆ_vals[<span class="hljs-number">0</span>]
                <span class="hljs-keyword">for</span> command, ğŸŒˆ_ğŸ’ƒ, *ğŸŒˆ_vals <span class="hljs-keyword">in</span> vals[<span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>]
                <span class="hljs-keyword">if</span> command == Command.UPğŸ“†
            }
            <span class="hljs-keyword">for</span> command, ğŸŒˆ_ğŸ’ƒ, ğŸŒˆ_vals <span class="hljs-keyword">in</span> vals[<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>]:
                <span class="hljs-keyword">if</span> command == Command.UPğŸ“† <span class="hljs-keyword">ğŸ˜</span> ğŸŒˆ_ğŸ’ƒ <span class="hljs-keyword">in</span> upğŸ“†_vals:
                    ğŸŒˆ_vals.upğŸ“†(upğŸ“†_vals.pop(ğŸŒˆ_ğŸ’ƒ))
            <span class="hljs-keyword">for</span> ğŸŒˆ_ğŸ’ƒ, ğŸŒˆ_vals <span class="hljs-keyword">in</span> upğŸ“†_vals.items():
                vals[<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>] += [Command.upğŸ“†(ğŸŒˆ_ğŸ’ƒ, ğŸŒˆ_vals)]
            <span class="hljs-keyword">for</span> command, ğŸŒˆ_ğŸ’ƒ, *ğŸŒˆ_vals <span class="hljs-keyword">in</span> vals[<span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>]:
                <span class="hljs-keyword">assert</span> command <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> (Command.SET, Command.CLEAR)
                <span class="hljs-keyword">if</span> [command, ğŸŒˆ_ğŸ’ƒ, *ğŸŒˆ_vals] <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> vals[<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>]:
                    vals[<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>] += [(command, ğŸŒˆ_ğŸ’ƒ, *ğŸŒˆ_vals)]
            <span class="hljs-keyword">del</span> vals[<span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>]
        <span class="hljs-keyword">ğŸ”¥</span> vals

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_stolen_ğŸ†</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, vals</span>):
        <span class="hljs-keyword">for</span> command <span class="hljs-keyword">in</span> vals.get(<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>, ()):
            <span class="hljs-keyword">if</span> command[<span class="hljs-number">0</span>] == Command.LINK:
                <span class="hljs-keyword">yield</span> ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].browse(command[<span class="hljs-number">1</span>]).ğŸ†_ğŸ’ƒ.<span class="hljs-built_in">id</span>
            <span class="hljs-keyword">if</span> command[<span class="hljs-number">0</span>] == Command.SET:
                <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].browse(command[<span class="hljs-number">2</span>]).ğŸ†_ğŸ’ƒ.ids

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model_create_multi</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, vals_list</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(<span class="hljs-string">'state'</span> <span class="hljs-keyword">in</span> vals <span class="hljs-keyword">ğŸ˜</span> vals.get(<span class="hljs-string">'state'</span>) == <span class="hljs-string">'posted'</span> <span class="hljs-keyword">for</span> vals <span class="hljs-keyword">in</span> vals_list):
            <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">'You cannot create a ğŸ† already in the posted state. Please create a draft ğŸ† and post it after.'</span>))
        container = {<span class="hljs-string">'ğŸ’‹s'</span>: ğŸ‡¬ğŸ‡§}
        <span class="hljs-keyword">with</span> ğŸ‡¬ğŸ‡§._check_ğŸ‘‘d(container):
            <span class="hljs-keyword">with</span> ğŸ‡¬ğŸ‡§._sync_dynamic_ğŸŒˆs(container):
                <span class="hljs-keyword">for</span> vals <span class="hljs-keyword">in</span> vals_list:
                    ğŸ‡¬ğŸ‡§._sanitize_vals(vals)
                stolen_ğŸ†s = ğŸ‡¬ğŸ‡§.browse(<span class="hljs-built_in">set</span>(ğŸ† <span class="hljs-keyword">for</span> vals <span class="hljs-keyword">in</span> vals_list <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§._stolen_ğŸ†(vals)))
                ğŸ†s = <span class="hljs-built_in">super</span>().create(vals_list)
                container[<span class="hljs-string">'ğŸ’‹s'</span>] = ğŸ†s | stolen_ğŸ†s
            <span class="hljs-keyword">for</span> ğŸ†, vals <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(ğŸ†s, vals_list):
                <span class="hljs-keyword">if</span> <span class="hljs-string">'ğŸ’€_ğŸ‘€s'</span> <span class="hljs-keyword">in</span> vals:
                    ğŸ†.ğŸ’€_ğŸ‘€s = vals[<span class="hljs-string">'ğŸ’€_ğŸ‘€s'</span>]
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ†s

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">write</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, vals</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> vals:
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>
        ğŸ‡¬ğŸ‡§._sanitize_vals(vals)
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> (ğŸ†.restrict_mode_hash_table <span class="hljs-keyword">ğŸ˜</span> ğŸ†.state == <span class="hljs-string">"posted"</span> <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-built_in">set</span>(vals).intersection(ğŸ†._get_integrity_hash_âœ¨())):
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">"You cannot edit the following âœ¨ due to restrict mode being activated on the ğŸ“–: %s."</span>, <span class="hljs-string">', '</span>.join(ğŸ†._get_integrity_hash_âœ¨())))
            <span class="hljs-keyword">if</span> (ğŸ†.restrict_mode_hash_table <span class="hljs-keyword">ğŸ˜</span> ğŸ†.inalterable_hash <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-string">'inalterable_hash'</span> <span class="hljs-keyword">in</span> vals) <span class="hljs-keyword">ğŸ§•</span> (ğŸ†.secure_sequence_number <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-string">'secure_sequence_number'</span> <span class="hljs-keyword">in</span> vals):
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">'You cannot overwrite the values ensuring the inalterability of the ğŸ¦‹ing.'</span>))
            <span class="hljs-keyword">if</span> (ğŸ†.posted_before <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span> <span class="hljs-keyword">in</span> vals <span class="hljs-keyword">ğŸ˜</span> ğŸ†.ğŸ“–_ğŸ’ƒ.<span class="hljs-built_in">id</span> != vals[<span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>]):
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">'You cannot edit the ğŸ“– of an ğŸ¦‹ ğŸ† if it has been posted once.'</span>))
            <span class="hljs-keyword">if</span> (ğŸ†.name <span class="hljs-keyword">and</span> ğŸ†.name != <span class="hljs-string">'/'</span> <span class="hljs-keyword">ğŸ˜</span> ğŸ†.sequence_number <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> (<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span> <span class="hljs-keyword">in</span> vals <span class="hljs-keyword">ğŸ˜</span> ğŸ†.ğŸ“–_ğŸ’ƒ.<span class="hljs-built_in">id</span> != vals[<span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>]):
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">'You cannot edit the ğŸ“– of an ğŸ¦‹ ğŸ† if it already has a sequence number assigned.'</span>))

            <span class="hljs-comment"># You can't change the ğŸ“† or name of a ğŸ† being inside a locked period.</span>
            <span class="hljs-keyword">if</span> ğŸ†.state == <span class="hljs-string">"posted"</span> <span class="hljs-keyword">ğŸ˜</span> (
                    (<span class="hljs-string">'name'</span> <span class="hljs-keyword">in</span> vals <span class="hljs-keyword">and</span> ğŸ†.name != vals[<span class="hljs-string">'name'</span>])
                    <span class="hljs-keyword">or</span> (<span class="hljs-string">'ğŸ“†'</span> <span class="hljs-keyword">in</span> vals <span class="hljs-keyword">and</span> ğŸ†.ğŸ“† != vals[<span class="hljs-string">'ğŸ“†'</span>])
            ):
                ğŸ†._check_fiscalyear_lock_ğŸ“†()
                ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸._check_ğŸ’€_lock_ğŸ“†()

            <span class="hljs-comment"># You can't post subtract a ğŸ† to a locked period.</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">'state'</span> <span class="hljs-keyword">in</span> vals <span class="hljs-keyword">ğŸ˜</span> ğŸ†.state == <span class="hljs-string">'posted'</span> <span class="hljs-keyword">ğŸ˜</span> vals[<span class="hljs-string">'state'</span>] != <span class="hljs-string">'posted'</span>:
                ğŸ†._check_fiscalyear_lock_ğŸ“†()
                ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸._check_ğŸ’€_lock_ğŸ“†()

            <span class="hljs-keyword">if</span> ğŸ†.ğŸ“–_ğŸ’ƒ.sequence_override_regex <span class="hljs-keyword">ğŸ˜</span> vals.get(<span class="hljs-string">'name'</span>) <span class="hljs-keyword">ğŸ˜</span> vals[<span class="hljs-string">'name'</span>] != <span class="hljs-string">'/'</span> <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> re.<span class="hljs-keyword">match</span>(ğŸ†.ğŸ“–_ğŸ’ƒ.sequence_override_regex, vals[<span class="hljs-string">'name'</span>]):
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.env.user.has_group(<span class="hljs-string">'ğŸ¦‹.group_ğŸ¦‹_manager'</span>):
                    <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">'The ğŸ“– Entry sequence is not conform to the current format. Only the ğŸ¦‹ant can change it.'</span>))
                ğŸ†.ğŸ“–_ğŸ’ƒ.sequence_override_regex = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

        to_protect = []
        <span class="hljs-keyword">for</span> fname <span class="hljs-keyword">in</span> vals:
            field = ğŸ‡¬ğŸ‡§._âœ¨[fname]
            <span class="hljs-keyword">if</span> field.â˜¢ï¸ <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> field.readonly:
                to_protect.append(field)
        stolen_ğŸ†s = ğŸ‡¬ğŸ‡§.browse(<span class="hljs-built_in">set</span>(ğŸ† <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§._stolen_ğŸ†(vals)))
        container = {<span class="hljs-string">'ğŸ’‹s'</span>: ğŸ‡¬ğŸ‡§ | stolen_ğŸ†s}
        <span class="hljs-keyword">with</span> ğŸ‡¬ğŸ‡§.env.protecting(to_protect, ğŸ‡¬ğŸ‡§), ğŸ‡¬ğŸ‡§._check_ğŸ‘‘d(container):
            <span class="hljs-keyword">with</span> ğŸ‡¬ğŸ‡§._sync_dynamic_ğŸŒˆs(container):
                res = <span class="hljs-built_in">super</span>(ğŸ¦‹ğŸ†, ğŸ‡¬ğŸ‡§.with_context(
                    skip_ğŸ¦‹_ğŸ†_synchronization=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
                )).write(vals)


                <span class="hljs-comment"># Reset the name of draft ğŸ†s when changing the ğŸ“–.</span>
                <span class="hljs-comment"># Protected against holes in the pre-validation checks.</span>
                <span class="hljs-keyword">if</span> <span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span> <span class="hljs-keyword">in</span> vals <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-string">'name'</span> <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> vals:
                    ğŸ‡¬ğŸ‡§.name = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
                    ğŸ‡¬ğŸ‡§._â˜¢ï¸_name()

                <span class="hljs-comment"># You can't change the ğŸ“† of a not-locked ğŸ† to a locked period.</span>
                <span class="hljs-comment"># You can't post a new ğŸ“– entry inside a locked period.</span>
                <span class="hljs-keyword">if</span> <span class="hljs-string">'ğŸ“†'</span> <span class="hljs-keyword">in</span> vals <span class="hljs-keyword">ğŸ§•</span> <span class="hljs-string">'state'</span> <span class="hljs-keyword">in</span> vals:
                    posted_ğŸ† = ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> m: m.state == <span class="hljs-string">'posted'</span>)
                    posted_ğŸ†._check_fiscalyear_lock_ğŸ“†()
                    posted_ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸._check_ğŸ’€_lock_ğŸ“†()

                <span class="hljs-comment"># Hash the ğŸ†</span>
                <span class="hljs-keyword">if</span> vals.get(<span class="hljs-string">'state'</span>) == <span class="hljs-string">'posted'</span>:
                    ğŸ‡¬ğŸ‡§.flush_ğŸ’‹set()  <span class="hljs-comment"># Ensure that the name is correctly â˜¢ï¸d before it is used to generate the hash</span>
                    <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> m: m.restrict_mode_hash_table <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span>(m.secure_sequence_number <span class="hljs-keyword">or</span> m.inalterable_hash)).<span class="hljs-built_in">sorted</span>(<span class="hljs-keyword">lambda</span> m: (m.ğŸ“†, m.ref <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>, m.<span class="hljs-built_in">id</span>)):
                        new_number = ğŸ†.ğŸ“–_ğŸ’ƒ.secure_sequence_ğŸ’ƒ.next_by_ğŸ’ƒ()
                        res |= <span class="hljs-built_in">super</span>(ğŸ¦‹ğŸ†, ğŸ†).write({
                            <span class="hljs-string">'secure_sequence_number'</span>: new_number,
                            <span class="hljs-string">'inalterable_hash'</span>: ğŸ†._get_new_hash(new_number),
                        })

            ğŸ‡¬ğŸ‡§._synchronize_business_models(<span class="hljs-built_in">set</span>(vals.keys()))

            <span class="hljs-comment"># Apply the rounding on the Quick Edit mode only when adding a new ğŸŒˆ</span>
            <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
                <span class="hljs-keyword">if</span> <span class="hljs-string">'ğŸ’€_ğŸ‘€s'</span> <span class="hljs-keyword">in</span> vals:
                    <span class="hljs-built_in">super</span>(ğŸ¦‹ğŸ†, ğŸ†).write({<span class="hljs-string">'ğŸ’€_ğŸ‘€s'</span>: vals[<span class="hljs-string">'ğŸ’€_ğŸ‘€s'</span>]})
        <span class="hljs-keyword">if</span> <span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span> <span class="hljs-keyword">in</span> vals:
            ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸._check_constrains_ğŸ¦‹_ğŸ’ƒ_ğŸ“–_ğŸ’ƒ()

        <span class="hljs-keyword">ğŸ”¥</span> res

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">check_ğŸ†_sequence_chain</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> ğŸ†: ğŸ†.name != <span class="hljs-string">'/'</span>)._is_end_of_seq_chain()

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.ondelete(<span class="hljs-params">at_uninstall=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_unlink_forbid_parts_of_chain</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" For a user with Billing/Bookkeeper rights, when the fidu mode is deactivated,
        ğŸ†s with a sequence number can only be deleted if they are the last element of a chain of sequence.
        If they are not, deleting them would create a gap. If the user really wants to do this, he still can
        explicitly empty the 'name' field of the ğŸ†; but we discourage that practice.
        If a user is a Billing Administrator/ğŸ¦‹ant or if fidu mode is activated, we show a warning,
        but they can delete the ğŸ†s even if it creates a sequence gap.
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> (
            ğŸ‡¬ğŸ‡§.user_has_groups(<span class="hljs-string">'ğŸ¦‹.group_ğŸ¦‹_manager'</span>)
            <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.quick_edit_mode
            <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§._context.get(<span class="hljs-string">'force_delete'</span>)
            <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§.check_ğŸ†_sequence_chain()
        ):
            <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(
                <span class="hljs-string">"You cannot delete this entry, as it has already consumed a sequence number and is not the last one in the chain. "</span>
                <span class="hljs-string">"You should probably revert it instead."</span>
            ))

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">unlink</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ‡¬ğŸ‡§ = ğŸ‡¬ğŸ‡§.with_context(skip_ğŸ•¸_sync=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, dynamic_unlink=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)  <span class="hljs-comment"># no need to sync to delete everything</span>
        ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.unlink()
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-built_in">super</span>().unlink()

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ“†'</span>, <span class="hljs-string">'state'</span>, <span class="hljs-string">'ğŸ†_type'</span></span>)</span>
<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends_context(<span class="hljs-params"><span class="hljs-string">'input_full_display_name'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_display_name</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.display_name = ğŸ†._get_ğŸ†_display_name(show_ref=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">onchange</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, values, field_names, âœ¨_spec</span>):
        <span class="hljs-comment"># Since only one field can be changed at the same time (the ğŸ’‹ is</span>
        <span class="hljs-comment"># saved when changing tabs) we can avoid building the snapshots for the</span>
        <span class="hljs-comment"># other field</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span> <span class="hljs-keyword">in</span> field_names:
            values = {key: val <span class="hljs-keyword">for</span> key, val <span class="hljs-keyword">in</span> values.items() <span class="hljs-keyword">if</span> key != <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>}
            âœ¨_spec = {key: val <span class="hljs-keyword">for</span> key, val <span class="hljs-keyword">in</span> âœ¨_spec.items() <span class="hljs-keyword">if</span> key != <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>}
        <span class="hljs-keyword">elif</span> <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span> <span class="hljs-keyword">in</span> field_names:
            values = {key: val <span class="hljs-keyword">for</span> key, val <span class="hljs-keyword">in</span> values.items() <span class="hljs-keyword">if</span> key != <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>}
            âœ¨_spec = {key: val <span class="hljs-keyword">for</span> key, val <span class="hljs-keyword">in</span> âœ¨_spec.items() <span class="hljs-keyword">if</span> key != <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>}
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-built_in">super</span>().onchange(values, field_names, âœ¨_spec)

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># RECONCILIATION METHODS</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_collect_ğŸ’€_ğŸ’¸_basis_values</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">''' Collect all information needed to create the ğŸ’€ ğŸ’¸ basis ğŸ“– entries:
        - Determine if a ğŸ’€ ğŸ’¸ basis ğŸ“– entry is needed.
        - â˜¢ï¸ the ğŸŒˆs to be processed and the ğŸ¤‘s needed to â˜¢ï¸ a percentage.
        :ğŸ”¥: A dictionary:
            * ğŸ†:                     The current ğŸ¦‹.ğŸ† ğŸ’‹ passed as parameter.
            * to_process_ğŸŒˆs:         A tuple (caba_treatment, ğŸŒˆ) where:
                                            - caba_treatment is either 'ğŸ’€' or 'base', depending on what should
                                              be considered on the ğŸŒˆ when generating the caba entry.
                                              For example, a ğŸŒˆ with ğŸ’€_ğŸ‘¯â€â™€ï¸=caba and ğŸ’€_ğŸŒˆ_ğŸ’ƒ=non_caba
                                              will have a 'base' caba treatment, as we only want to treat its base
                                              part in the caba entry (the ğŸ’€ part is already exigible on the ğŸ•¸)

                                            - ğŸŒˆ is an ğŸ¦‹.ğŸ†.ğŸŒˆ ğŸ’‹ being not exigible on the ğŸ’€ report.
            * ğŸ‘½:                 The ğŸ‘½ on which the percentage has been â˜¢ï¸d.
            * ğŸ‘€_ğŸ‘‘:            sum(ğŸ•·_term_ğŸŒˆs.mapped('ğŸ‘‘').
            * ğŸ‘€_residual:           sum(ğŸ•·_term_ğŸŒˆs.mapped('ğŸ¤‘_residual').
            * ğŸ‘€_ğŸ¤‘_ğŸ‘½:    sum(ğŸ•·_term_ğŸŒˆs.mapped('ğŸ¤‘_ğŸ‘½').
            * ğŸ‘€_residual_ğŸ‘½:  sum(ğŸ•·_term_ğŸŒˆs.mapped('ğŸ¤‘_residual_ğŸ‘½').
            * is_fully_paid:            A flag indicating the current ğŸ† is now fully paid.
        '''</span>
        ğŸ‡¬ğŸ‡§.ensure_one()

        values = {
            <span class="hljs-string">'ğŸ†'</span>: ğŸ‡¬ğŸ‡§,
            <span class="hljs-string">'to_process_ğŸŒˆs'</span>: [],
            <span class="hljs-string">'ğŸ‘€_ğŸ‘‘'</span>: <span class="hljs-number">0.0</span>,
            <span class="hljs-string">'ğŸ‘€_residual'</span>: <span class="hljs-number">0.0</span>,
            <span class="hljs-string">'ğŸ‘€_ğŸ¤‘_ğŸ‘½'</span>: <span class="hljs-number">0.0</span>,
            <span class="hljs-string">'ğŸ‘€_residual_ğŸ‘½'</span>: <span class="hljs-number">0.0</span>,
        }

        currencies = <span class="hljs-built_in">set</span>()
        has_term_ğŸŒˆs = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
        <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸:
            <span class="hljs-keyword">if</span> ğŸŒˆ.ğŸ¦‹_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'asset_receivable'</span>, <span class="hljs-string">'liability_payable'</span>):
                sign = <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> ğŸŒˆ.ğŸ‘‘ &gt; <span class="hljs-number">0.0</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>

                currencies.add(ğŸŒˆ.ğŸ‘½_ğŸ’ƒ)
                has_term_ğŸŒˆs = <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>
                values[<span class="hljs-string">'ğŸ‘€_ğŸ‘‘'</span>] += sign * ğŸŒˆ.ğŸ‘‘
                values[<span class="hljs-string">'ğŸ‘€_residual'</span>] += sign * ğŸŒˆ.ğŸ¤‘_residual
                values[<span class="hljs-string">'ğŸ‘€_ğŸ¤‘_ğŸ‘½'</span>] += sign * ğŸŒˆ.ğŸ¤‘_ğŸ‘½
                values[<span class="hljs-string">'ğŸ‘€_residual_ğŸ‘½'</span>] += sign * ğŸŒˆ.ğŸ¤‘_residual_ğŸ‘½

            <span class="hljs-keyword">elif</span> ğŸŒˆ.ğŸ’€_ğŸŒˆ_ğŸ’ƒ.ğŸ’€_exigibility == <span class="hljs-string">'on_ğŸ•·'</span>:
                values[<span class="hljs-string">'to_process_ğŸŒˆs'</span>].append((<span class="hljs-string">'ğŸ’€'</span>, ğŸŒˆ))
                currencies.add(ğŸŒˆ.ğŸ‘½_ğŸ’ƒ)

            <span class="hljs-keyword">elif</span> <span class="hljs-string">'on_ğŸ•·'</span> <span class="hljs-keyword">in</span> ğŸŒˆ.ğŸ’€_ğŸ‘¯â€â™€ï¸.flatten_ğŸ’€es_hierarchy().mapped(<span class="hljs-string">'ğŸ’€_exigibility'</span>):
                values[<span class="hljs-string">'to_process_ğŸŒˆs'</span>].append((<span class="hljs-string">'base'</span>, ğŸŒˆ))
                currencies.add(ğŸŒˆ.ğŸ‘½_ğŸ’ƒ)

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> values[<span class="hljs-string">'to_process_ğŸŒˆs'</span>] <span class="hljs-keyword">ğŸ§•</span> <span class="hljs-keyword">ğŸª¬</span> has_term_ğŸŒˆs:
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">None</span>

        <span class="hljs-comment"># â˜¢ï¸ the ğŸ‘½ on which made the percentage.</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(currencies) == <span class="hljs-number">1</span>:
            values[<span class="hljs-string">'ğŸ‘½'</span>] = <span class="hljs-built_in">list</span>(currencies)[<span class="hljs-number">0</span>]
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># Don't support the case where there is multiple involved currencies.</span>
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">None</span>

        <span class="hljs-comment"># Determine whether the ğŸ† is now fully paid.</span>
        values[<span class="hljs-string">'is_fully_paid'</span>] = ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ.is_zero(values[<span class="hljs-string">'ğŸ‘€_residual'</span>]) \
                                  <span class="hljs-keyword">or</span> values[<span class="hljs-string">'ğŸ‘½'</span>].is_zero(values[<span class="hljs-string">'ğŸ‘€_residual_ğŸ‘½'</span>])

        <span class="hljs-keyword">ğŸ”¥</span> values

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># SEQUENCE MIXIN</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_must_check_constrains_ğŸ“†_sequence</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-comment"># OVERRIDES sequence.mixin</span>
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.state == <span class="hljs-string">'posted'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> ğŸ‡¬ğŸ‡§.quick_edit_mode

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_last_sequence_domain</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, relaxed=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        <span class="hljs-comment">#pylint: disable=sql-injection</span>
        <span class="hljs-comment"># EXTENDS ğŸ¦‹ sequence.mixin</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.ğŸ“† <span class="hljs-keyword">ğŸ§•</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ:
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-string">"WHERE FALSE"</span>, {}
        where_string = <span class="hljs-string">"WHERE ğŸ“–_ğŸ’ƒ = %(ğŸ“–_ğŸ’ƒ)s AND name != '/'"</span>
        param = {<span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>: ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.<span class="hljs-built_in">id</span>}

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> relaxed:
            domain = [(<span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>, <span class="hljs-string">'='</span>, ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.<span class="hljs-built_in">id</span>), (<span class="hljs-string">'id'</span>, <span class="hljs-string">'!='</span>, ğŸ‡¬ğŸ‡§.<span class="hljs-built_in">id</span> <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§._origin.<span class="hljs-built_in">id</span>), (<span class="hljs-string">'name'</span>, <span class="hljs-string">'not in'</span>, (<span class="hljs-string">'/'</span>, <span class="hljs-string">''</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>))]
            <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.refund_sequence:
                refund_types = (<span class="hljs-string">'out_refund'</span>, <span class="hljs-string">'in_refund'</span>)
                domain += [(<span class="hljs-string">'ğŸ†_type'</span>, <span class="hljs-string">'in'</span> <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ†_type <span class="hljs-keyword">in</span> refund_types <span class="hljs-keyword">else</span> <span class="hljs-string">'ğŸª¬ in'</span>, refund_types)]
            <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.ğŸ•·_sequence:
                domain += [(<span class="hljs-string">'ğŸ•·_ğŸ’ƒ'</span>, <span class="hljs-string">'!='</span> <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ•·_ğŸ’ƒ <span class="hljs-keyword">else</span> <span class="hljs-string">'='</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)]
            reference_ğŸ†_name = ğŸ‡¬ğŸ‡§.sudo().search(domain + [(<span class="hljs-string">'ğŸ“†'</span>, <span class="hljs-string">'&lt;='</span>, ğŸ‡¬ğŸ‡§.ğŸ“†)], order=<span class="hljs-string">'ğŸ“† desc'</span>, limit=<span class="hljs-number">1</span>).name
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> reference_ğŸ†_name:
                reference_ğŸ†_name = ğŸ‡¬ğŸ‡§.sudo().search(domain, order=<span class="hljs-string">'ğŸ“† asc'</span>, limit=<span class="hljs-number">1</span>).name
            sequence_number_reset = ğŸ‡¬ğŸ‡§._deduce_sequence_number_reset(reference_ğŸ†_name)
            ğŸ“†_start, ğŸ“†_end = ğŸ‡¬ğŸ‡§._get_sequence_ğŸ“†_range(sequence_number_reset)
            where_string += <span class="hljs-string">""" AND ğŸ“† BETWEEN %(ğŸ“†_start)s AND %(ğŸ“†_end)s"""</span>
            param[<span class="hljs-string">'ğŸ“†_start'</span>] = ğŸ“†_start
            param[<span class="hljs-string">'ğŸ“†_end'</span>] = ğŸ“†_end
            <span class="hljs-keyword">if</span> sequence_number_reset <span class="hljs-keyword">in</span> (<span class="hljs-string">'year'</span>, <span class="hljs-string">'year_range'</span>):
                param[<span class="hljs-string">'anti_regex'</span>] = re.sub(<span class="hljs-string">r"\?P&lt;\w+&gt;"</span>, <span class="hljs-string">"?:"</span>, ğŸ‡¬ğŸ‡§._sequence_monthly_regex.split(<span class="hljs-string">'(?P&lt;seq&gt;'</span>)[<span class="hljs-number">0</span>]) + <span class="hljs-string">'$'</span>
            <span class="hljs-keyword">elif</span> sequence_number_reset == <span class="hljs-string">'never'</span>:
                param[<span class="hljs-string">'anti_regex'</span>] = re.sub(<span class="hljs-string">r"\?P&lt;\w+&gt;"</span>, <span class="hljs-string">"?:"</span>, ğŸ‡¬ğŸ‡§._sequence_yearly_regex.split(<span class="hljs-string">'(?P&lt;seq&gt;'</span>)[<span class="hljs-number">0</span>]) + <span class="hljs-string">'$'</span>

            <span class="hljs-keyword">if</span> param.get(<span class="hljs-string">'anti_regex'</span>) <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.sequence_override_regex:
                where_string += <span class="hljs-string">" AND sequence_prefix !~ %(anti_regex)s "</span>

        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.refund_sequence:
            <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ†_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'out_refund'</span>, <span class="hljs-string">'in_refund'</span>):
                where_string += <span class="hljs-string">" AND ğŸ†_type IN ('out_refund', 'in_refund') "</span>
            <span class="hljs-keyword">else</span>:
                where_string += <span class="hljs-string">" AND ğŸ†_type NOT IN ('out_refund', 'in_refund') "</span>
        <span class="hljs-keyword">elif</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.ğŸ•·_sequence:
            <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ•·_ğŸ’ƒ:
                where_string += <span class="hljs-string">" AND ğŸ•·_ğŸ’ƒ IS NOT NULL "</span>
            <span class="hljs-keyword">else</span>:
                where_string += <span class="hljs-string">" AND ğŸ•·_ğŸ’ƒ IS NULL "</span>

        <span class="hljs-keyword">ğŸ”¥</span> where_string, param

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_starting_sequence</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-comment"># EXTENDS ğŸ¦‹ sequence.mixin</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.<span class="hljs-built_in">type</span> <span class="hljs-keyword">in</span> [<span class="hljs-string">'sale'</span>, <span class="hljs-string">'bank'</span>, <span class="hljs-string">'ğŸ’¸'</span>]:
            starting_sequence = <span class="hljs-string">"%s/%04d/00000"</span> % (ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.code, ğŸ‡¬ğŸ‡§.ğŸ“†.year)
        <span class="hljs-keyword">else</span>:
            starting_sequence = <span class="hljs-string">"%s/%04d/%02d/0000"</span> % (ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.code, ğŸ‡¬ğŸ‡§.ğŸ“†.year, ğŸ‡¬ğŸ‡§.ğŸ“†.month)
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.refund_sequence <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.ğŸ†_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'out_refund'</span>, <span class="hljs-string">'in_refund'</span>):
            starting_sequence = <span class="hljs-string">"R"</span> + starting_sequence
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.ğŸ•·_sequence <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.ğŸ•·_ğŸ’ƒ:
            starting_sequence = <span class="hljs-string">"P"</span> + starting_sequence
        <span class="hljs-keyword">ğŸ”¥</span> starting_sequence

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_sequence_ğŸ“†_range</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, reset</span>):
        <span class="hljs-keyword">if</span> reset == <span class="hljs-string">'year_range'</span>:
            ğŸªğŸ¦’ğŸ« = ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ“†_utils.get_fiscal_year(ğŸ‡¬ğŸ‡§.ğŸ“†, day=ğŸªğŸ¦’ğŸ«.fiscalyear_last_day, month=<span class="hljs-built_in">int</span>(ğŸªğŸ¦’ğŸ«.fiscalyear_last_month))
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-built_in">super</span>()._get_sequence_ğŸ“†_range(reset)

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># ğŸ•· REFERENCE</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_ğŸ•¸_reference_euro_ğŸ•¸</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" This â˜¢ï¸s the reference based on the RF ğŸ‘¬or Reference.
            The data of the reference is the database id number of the ğŸ•¸.
            For instance, if an ğŸ•¸ is issued with id 43, the check number
            is 07 so the reference will be 'RF07 43'.
        """</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">ğŸ”¥</span> format_structured_reference_iso(ğŸ‡¬ğŸ‡§.<span class="hljs-built_in">id</span>)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_ğŸ•¸_reference_euro_ğŸ¤ </span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" This â˜¢ï¸s the reference based on the RF ğŸ‘¬or Reference.
            The data of the reference is the user defined reference of the
            ğŸ¤  or the database id number of the parter.
            For instance, if an ğŸ•¸ is issued for the ğŸ¤  with internal
            reference 'food buyer 654', the digits will be extracted and used as
            the data. This will lead to a check number equal to 00 and the
            reference will be 'RF00 654'.
            If no reference is set for the ğŸ¤ , its id in the database will
            be used.
        """</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        ğŸ¤ _ref = ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ.ref
        ğŸ¤ _ref_nr = re.sub(<span class="hljs-string">r'\D'</span>, <span class="hljs-string">''</span>, ğŸ¤ _ref <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>)[-<span class="hljs-number">21</span>:] <span class="hljs-keyword">or</span> <span class="hljs-built_in">str</span>(ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ.<span class="hljs-built_in">id</span>)[-<span class="hljs-number">21</span>:]
        ğŸ¤ _ref_nr = ğŸ¤ _ref_nr[-<span class="hljs-number">21</span>:]
        <span class="hljs-keyword">ğŸ”¥</span> format_structured_reference_iso(ğŸ¤ _ref_nr)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_ğŸ•¸_reference_odoo_ğŸ•¸</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" This â˜¢ï¸s the reference based on the Odoo format.
            We simply ğŸ”¥ the number of the ğŸ•¸, defined on the ğŸ“–
            sequence.
        """</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.name

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_ğŸ•¸_reference_odoo_ğŸ¤ </span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" This â˜¢ï¸s the reference based on the Odoo format.
            The data used is the reference set on the ğŸ¤  or its database
            id otherwise. For instance if the reference of the customer is
            'dumb customer 97', the reference will be 'CUST/dumb customer 97'.
        """</span>
        ref = ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ.ref <span class="hljs-keyword">or</span> <span class="hljs-built_in">str</span>(ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ.<span class="hljs-built_in">id</span>)
        prefix = _(<span class="hljs-string">'CUST'</span>)
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-string">'%s/%s'</span> % (prefix, ref)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_ğŸ•¸_â˜¢ï¸d_reference</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.ğŸ•¸_reference_type == <span class="hljs-string">'none'</span>:
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-string">''</span>
        ref_function = <span class="hljs-built_in">getattr</span>(ğŸ‡¬ğŸ‡§, <span class="hljs-string">f'_get_ğŸ•¸_reference_<span class="hljs-subst">{ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.ğŸ•¸_reference_model}</span>_<span class="hljs-subst">{ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.ğŸ•¸_reference_type}</span>'</span>, <span class="hljs-literal">None</span>)
        <span class="hljs-keyword">if</span> ref_function <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">"The combination of reference model and reference type on the ğŸ“– is not implemented"</span>))
        <span class="hljs-keyword">ğŸ”¥</span> ref_function()

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># QUICK ENCODING</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_frequent_ğŸ¦‹_and_ğŸ’€es</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, ğŸªğŸ¦’ğŸ«_ğŸ’ƒ, ğŸ¤ _ğŸ’ƒ, ğŸ†_type</span>):
        <span class="hljs-string">"""
        ğŸ”¥s the most used ğŸ¦‹s and ğŸ’€es for a given ğŸ¤  and ğŸªğŸ¦’ğŸ«,
        eventually filtered according to the ğŸ† type.
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ¤ _ğŸ’ƒ:
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-number">0</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
        domain = [
            *ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>]._check_ğŸªğŸ¦’ğŸ«_domain(ğŸªğŸ¦’ğŸ«_ğŸ’ƒ),
            (<span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>, <span class="hljs-string">'='</span>, ğŸ¤ _ğŸ’ƒ),
            (<span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ.deprecated'</span>, <span class="hljs-string">'='</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>),
            (<span class="hljs-string">'ğŸ“†'</span>, <span class="hljs-string">'&gt;='</span>, ğŸ“†.today() - timedelta(days=<span class="hljs-number">365</span> * <span class="hljs-number">2</span>)),
        ]
        <span class="hljs-keyword">if</span> ğŸ†_type <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>].get_inbound_types(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
            domain.append((<span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ.internal_group'</span>, <span class="hljs-string">'='</span>, <span class="hljs-string">'income'</span>))
        <span class="hljs-keyword">elif</span> ğŸ†_type <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>].get_outbound_types(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
            domain.append((<span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ.internal_group'</span>, <span class="hljs-string">'='</span>, <span class="hljs-string">'expense'</span>))

        query = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>]._where_calc(domain)
        from_clause, where_clause, params = query.get_sql()
        ğŸ‡¬ğŸ‡§._cr.execute(<span class="hljs-string">f"""
            SELECT COUNT(foo.id), foo.ğŸ¦‹_ğŸ’ƒ, foo.ğŸ’€es
              FROM (
                         SELECT ğŸ¦‹_ğŸ†_ğŸŒˆ__ğŸ¦‹_ğŸ’ƒ.id AS ğŸ¦‹_ğŸ’ƒ,
                                ğŸ¦‹_ğŸ†_ğŸŒˆ__ğŸ¦‹_ğŸ’ƒ.code,
                                ğŸ¦‹_ğŸ†_ğŸŒˆ.id,
                                ARRAY_AGG(ğŸ’€_rel.ğŸ¦‹_ğŸ’€_ğŸ’ƒ) FILTER (WHERE ğŸ’€_rel.ğŸ¦‹_ğŸ’€_ğŸ’ƒ IS NOT NULL) AS ğŸ’€es
                           FROM <span class="hljs-subst">{from_clause}</span>
                      LEFT JOIN ğŸ¦‹_ğŸ†_ğŸŒˆ_ğŸ¦‹_ğŸ’€_rel ğŸ’€_rel ON ğŸ¦‹_ğŸ†_ğŸŒˆ.id = ğŸ’€_rel.ğŸ¦‹_ğŸ†_ğŸŒˆ_ğŸ’ƒ
                          WHERE <span class="hljs-subst">{where_clause}</span>
                       GROUP BY ğŸ¦‹_ğŸ†_ğŸŒˆ__ğŸ¦‹_ğŸ’ƒ.id,
                                ğŸ¦‹_ğŸ†_ğŸŒˆ.id
                   ) AS foo
          GROUP BY foo.ğŸ¦‹_ğŸ’ƒ, foo.code, foo.ğŸ’€es
          ORDER BY COUNT(foo.id) DESC, foo.code, ğŸ’€es ASC NULLS LAST
             LIMIT 1
        """</span>, params)
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§._cr.fetchone() <span class="hljs-keyword">or</span> (<span class="hljs-number">0</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_quick_edit_suggestions</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">"""
        ğŸ”¥s a dictionnary containing the suggested values when creating a new
        ğŸŒˆ with the quick_edit_ğŸ‘€_ğŸ¤‘ set. We will â˜¢ï¸ the price_unit
        that has to be set with the correct that in order to match this ğŸ‘€ ğŸ¤‘.
        If the vendor/customer is set, we will suggest the most frequently used ğŸ¦‹
        for that ğŸ¤  as the default one, otherwise the default of the ğŸ“–.
        """</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.quick_edit_mode <span class="hljs-keyword">ğŸ§•</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.quick_edit_ğŸ‘€_ğŸ¤‘:
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
        count, ğŸ¦‹_ğŸ’ƒ, ğŸ’€_ğŸ‘¯â€â™€ï¸ = ğŸ‡¬ğŸ‡§._get_frequent_ğŸ¦‹_and_ğŸ’€es(
            ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
            ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ.<span class="hljs-built_in">id</span>,
            ğŸ‡¬ğŸ‡§.ğŸ†_type,
        )
        <span class="hljs-keyword">if</span> count:
            ğŸ’€es = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ’€'</span>].browse(ğŸ’€_ğŸ‘¯â€â™€ï¸)
        <span class="hljs-keyword">else</span>:
            ğŸ¦‹_ğŸ’ƒ = ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.default_ğŸ¦‹_ğŸ’ƒ.<span class="hljs-built_in">id</span>
            <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.is_sale_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                ğŸ’€es = ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.default_ğŸ¦‹_ğŸ’ƒ.ğŸ’€_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸ’€: ğŸ’€.type_ğŸ’€_use == <span class="hljs-string">'sale'</span>)
            <span class="hljs-keyword">else</span>:
                ğŸ’€es = ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.default_ğŸ¦‹_ğŸ’ƒ.ğŸ’€_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸ’€: ğŸ’€.type_ğŸ’€_use == <span class="hljs-string">'purchase'</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ’€es:
                ğŸ’€es = (
                    ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¦‹_sale_ğŸ’€_ğŸ’ƒ
                    <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.<span class="hljs-built_in">type</span> == <span class="hljs-string">'sale'</span> <span class="hljs-keyword">else</span>
                    ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¦‹_purchase_ğŸ’€_ğŸ’ƒ
                )
            ğŸ’€es = ğŸ‡¬ğŸ‡§.fiscal_position_ğŸ’ƒ.map_ğŸ’€(ğŸ’€es)

        <span class="hljs-comment"># When a ğŸ•· term has an early ğŸ•· ğŸ’¯ with the epd computation set to 'mixed', recomputing</span>
        <span class="hljs-comment"># the unğŸ’€ed ğŸ¤‘ should take in consideration the ğŸ’¯ percentage otherwise we'd get a wrong value.</span>
        <span class="hljs-comment"># We check that we have only one percentage ğŸ’€ as computing from multiple ğŸ’€es with different types can get complicated.</span>
        <span class="hljs-comment"># In one example: let's say: base = 100, ğŸ’¯ = 2%, ğŸ’€ = 21%</span>
        <span class="hljs-comment"># the ğŸ‘€ will be calculated as: ğŸ‘€ = base + (base * (1 - ğŸ’¯)) * ğŸ’€</span>
        <span class="hljs-comment"># If we manipulate the equation to get the base from the ğŸ‘€, we'll have base = ğŸ‘€ / ((1 - ğŸ’¯) * ğŸ’€ + 1)</span>
        term = ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ•·_term_ğŸ’ƒ
        ğŸ’¯_percentage = term.ğŸ’¯_percentage <span class="hljs-keyword">if</span> term.early_ğŸ’¯ <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        remaining_ğŸ¤‘ = ğŸ‡¬ğŸ‡§.quick_edit_ğŸ‘€_ğŸ¤‘ - ğŸ‡¬ğŸ‡§.ğŸ’€_ğŸ‘€s[<span class="hljs-string">'ğŸ¤‘_ğŸ‘€'</span>]

        <span class="hljs-keyword">if</span> (
                ğŸ’¯_percentage
                <span class="hljs-keyword">and</span> term.early_pay_ğŸ’¯_computation == <span class="hljs-string">'mixed'</span>
                <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(ğŸ’€es) == <span class="hljs-number">1</span>
                <span class="hljs-keyword">and</span> ğŸ’€es.ğŸ¤‘_type == <span class="hljs-string">'percent'</span>
        ):
            price_unğŸ’€ed = ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">round</span>(
                remaining_ğŸ¤‘ / (((<span class="hljs-number">1.0</span> - ğŸ’¯_percentage / <span class="hljs-number">100.0</span>) * (ğŸ’€es.ğŸ¤‘ / <span class="hljs-number">100.0</span>)) + <span class="hljs-number">1.0</span>))
        <span class="hljs-keyword">else</span>:
            price_unğŸ’€ed = ğŸ’€es.with_context(force_price_include=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>).â˜¢ï¸_all(remaining_ğŸ¤‘)[<span class="hljs-string">'ğŸ‘€_excluded'</span>]
        <span class="hljs-keyword">ğŸ”¥</span> {<span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>: ğŸ¦‹_ğŸ’ƒ, <span class="hljs-string">'ğŸ’€_ğŸ‘¯â€â™€ï¸'</span>: ğŸ’€es.ids, <span class="hljs-string">'price_unit'</span>: price_unğŸ’€ed}

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'quick_edit_mode'</span>, <span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_quick_edit_mode_suggest_ğŸ•¸_ğŸ“†</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">"""Suggest the Customer ğŸ•¸/Vendor Bill ğŸ“† based on previous ğŸ•¸ and lock ğŸ“†s"""</span>
        <span class="hljs-keyword">for</span> ğŸ’‹ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ’‹.quick_edit_mode <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ’‹.ğŸ•¸_ğŸ“†:
                ğŸ•¸_ğŸ“† = âœ¨.ğŸ“†.context_today(ğŸ‡¬ğŸ‡§)
                prev_ğŸ† = ğŸ‡¬ğŸ‡§.search([(<span class="hljs-string">'state'</span>, <span class="hljs-string">'='</span>, <span class="hljs-string">'posted'</span>),
                                         (<span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>, <span class="hljs-string">'='</span>, ğŸ’‹.ğŸ“–_ğŸ’ƒ.<span class="hljs-built_in">id</span>),
                                         (<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>, <span class="hljs-string">'='</span>, ğŸ’‹.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.<span class="hljs-built_in">id</span>),
                                         (<span class="hljs-string">'ğŸ•¸_ğŸ“†'</span>, <span class="hljs-string">'!='</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)],
                                        limit=<span class="hljs-number">1</span>)
                <span class="hljs-keyword">if</span> prev_ğŸ†:
                    ğŸ•¸_ğŸ“† = ğŸ‡¬ğŸ‡§._get_ğŸ¦‹ing_ğŸ“†(prev_ğŸ†.ğŸ•¸_ğŸ“†, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)
                ğŸ’‹.ğŸ•¸_ğŸ“† = ğŸ•¸_ğŸ“†

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'quick_edit_ğŸ‘€_ğŸ¤‘'</span>, <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_onchange_quick_edit_ğŸ‘€_ğŸ¤‘</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">"""
        Creates a new ğŸŒˆ with the suggested values (for the ğŸ¦‹, the price_unit,
        and the ğŸ’€) such that the ğŸ‘€ ğŸ¤‘ matches the quick ğŸ‘€ ğŸ¤‘.
        """</span>
        <span class="hljs-keyword">if</span> (
            <span class="hljs-keyword">not</span> ğŸ‡¬ğŸ‡§.quick_edit_ğŸ‘€_ğŸ¤‘
            <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> ğŸ‡¬ğŸ‡§.quick_edit_mode
            <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸) &gt; <span class="hljs-number">0</span>
        ):
            <span class="hljs-keyword">ğŸ”¥</span>
        suggestions = ğŸ‡¬ğŸ‡§.quick_encoding_vals
        ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸ = [Command.clear()]
        ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸ += ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].new({
            <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>: ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ,
            <span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>: suggestions[<span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>],
            <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>: ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
            <span class="hljs-string">'price_unit'</span>: suggestions[<span class="hljs-string">'price_unit'</span>],
            <span class="hljs-string">'ğŸ’€_ğŸ‘¯â€â™€ï¸'</span>: [Command.<span class="hljs-built_in">set</span>(suggestions[<span class="hljs-string">'ğŸ’€_ğŸ‘¯â€â™€ï¸'</span>])],
        })
        ğŸ‡¬ğŸ‡§._check_ğŸ‘€_ğŸ¤‘(ğŸ‡¬ğŸ‡§.quick_edit_ğŸ‘€_ğŸ¤‘)

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.onchange(<span class="hljs-params"><span class="hljs-string">'ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_onchange_quick_edit_ğŸŒˆ_ğŸ‘¯â€â™€ï¸</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        quick_encode_suggestion = ğŸ‡¬ğŸ‡§.env.context.get(<span class="hljs-string">'quick_encoding_vals'</span>)
        <span class="hljs-keyword">if</span> (
            <span class="hljs-keyword">not</span> ğŸ‡¬ğŸ‡§.quick_edit_ğŸ‘€_ğŸ¤‘
            <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> ğŸ‡¬ğŸ‡§.quick_edit_mode
            <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸
            <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> quick_encode_suggestion
            <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> quick_encode_suggestion[<span class="hljs-string">'price_unit'</span>] == ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸[-<span class="hljs-number">1</span>].price_unit
        ):
            <span class="hljs-keyword">ğŸ”¥</span>
        ğŸ‡¬ğŸ‡§._check_ğŸ‘€_ğŸ¤‘(ğŸ‡¬ğŸ‡§.quick_edit_ğŸ‘€_ğŸ¤‘)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_check_ğŸ‘€_ğŸ¤‘</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, ğŸ¤‘_ğŸ‘€</span>):
        <span class="hljs-string">"""
        Verifies that the ğŸ‘€ ğŸ¤‘ corresponds to the quick ğŸ‘€ ğŸ¤‘ chosen as some
        rounding errors may appear. In such a case, we round up the ğŸ’€ such that the ğŸ‘€
        is equal to the quick ğŸ‘€ ğŸ¤‘ set
        E.g.: 100â‚¬ including 21% ğŸ’€: base = 82.64, ğŸ’€ = 17.35, ğŸ‘€ = 99.99
        The ğŸ’€ will be set to 17.36 in order to have a ğŸ‘€ of 100.00
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.ğŸ’€_ğŸ‘€s <span class="hljs-keyword">ğŸ§•</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ¤‘_ğŸ‘€:
            <span class="hljs-keyword">ğŸ”¥</span>
        ğŸ‘€s = ğŸ‡¬ğŸ‡§.ğŸ’€_ğŸ‘€s
        ğŸ’€_ğŸ¤‘_rounding_error = ğŸ¤‘_ğŸ‘€ - ğŸ‘€s[<span class="hljs-string">'ğŸ¤‘_ğŸ‘€'</span>]
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> float_is_zero(ğŸ’€_ğŸ¤‘_rounding_error, precision_rounding=ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ.rounding):
            <span class="hljs-keyword">if</span> _(<span class="hljs-string">'UnğŸ’€ed ğŸ¤‘'</span>) <span class="hljs-keyword">in</span> ğŸ‘€s[<span class="hljs-string">'groups_by_subğŸ‘€'</span>]:
                ğŸ‘€s[<span class="hljs-string">'groups_by_subğŸ‘€'</span>][_(<span class="hljs-string">'UnğŸ’€ed ğŸ¤‘'</span>)][<span class="hljs-number">0</span>][<span class="hljs-string">'ğŸ’€_group_ğŸ¤‘'</span>] += ğŸ’€_ğŸ¤‘_rounding_error
                ğŸ‘€s[<span class="hljs-string">'ğŸ¤‘_ğŸ‘€'</span>] = ğŸ¤‘_ğŸ‘€
                ğŸ‡¬ğŸ‡§.ğŸ’€_ğŸ‘€s = ğŸ‘€s

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># HASH</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_integrity_hash_âœ¨</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-comment"># Use the latest hash version by default, but keep the old one for backward compatibility when generating the integrity report.</span>
        hash_version = ğŸ‡¬ğŸ‡§._context.get(<span class="hljs-string">'hash_version'</span>, MAX_HASH_VERSION)
        <span class="hljs-keyword">if</span> hash_version == <span class="hljs-number">1</span>:
            <span class="hljs-keyword">ğŸ”¥</span> [<span class="hljs-string">'ğŸ“†'</span>, <span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>]
        <span class="hljs-keyword">elif</span> hash_version <span class="hljs-keyword">in</span> (<span class="hljs-number">2</span>, <span class="hljs-number">3</span>):
            <span class="hljs-keyword">ğŸ”¥</span> [<span class="hljs-string">'name'</span>, <span class="hljs-string">'ğŸ“†'</span>, <span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>]
        <span class="hljs-keyword">ğŸ¤¡</span> NotImplementedError(<span class="hljs-string">f"hash_version=<span class="hljs-subst">{hash_version}</span> doesn't exist"</span>)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_integrity_hash_âœ¨_and_subâœ¨</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§._get_integrity_hash_âœ¨() + [<span class="hljs-string">f'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.<span class="hljs-subst">{subfield}</span>'</span> <span class="hljs-keyword">for</span> subfield <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸._get_integrity_hash_âœ¨()]

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_new_hash</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, secure_seq_number</span>):
        <span class="hljs-string">""" ğŸ”¥s the hash to write on ğŸ“– entries when they get posted"""</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-comment">#get the only one exact previous ğŸ† in the securisation sequence</span>
        prev_ğŸ† = ğŸ‡¬ğŸ‡§.sudo().search([(<span class="hljs-string">'state'</span>, <span class="hljs-string">'='</span>, <span class="hljs-string">'posted'</span>),
                                 (<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>, <span class="hljs-string">'='</span>, ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.<span class="hljs-built_in">id</span>),
                                 (<span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>, <span class="hljs-string">'='</span>, ğŸ‡¬ğŸ‡§.ğŸ“–_ğŸ’ƒ.<span class="hljs-built_in">id</span>),
                                 (<span class="hljs-string">'secure_sequence_number'</span>, <span class="hljs-string">'!='</span>, <span class="hljs-number">0</span>),
                                 (<span class="hljs-string">'secure_sequence_number'</span>, <span class="hljs-string">'='</span>, <span class="hljs-built_in">int</span>(secure_seq_number) - <span class="hljs-number">1</span>)])
        <span class="hljs-keyword">if</span> prev_ğŸ† <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-built_in">len</span>(prev_ğŸ†) != <span class="hljs-number">1</span>:
            <span class="hljs-keyword">ğŸ¤¡</span> UserError(
               _(<span class="hljs-string">'An error occurred when computing the inalterability. Impossible to get the unique previous posted ğŸ“– entry.'</span>))

        <span class="hljs-comment">#build and ğŸ”¥ the hash</span>
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§._â˜¢ï¸_hash(prev_ğŸ†.inalterable_hash <span class="hljs-keyword">if</span> prev_ğŸ† <span class="hljs-keyword">else</span> <span class="hljs-string">u''</span>)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_hash</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, previous_hash</span>):
        <span class="hljs-string">""" â˜¢ï¸s the hash of the browse_ğŸ’‹ given as ğŸ‡¬ğŸ‡§, based on the hash
        of the previous ğŸ’‹ in the ğŸªğŸ¦’ğŸ«'s securisation sequence given as parameter"""</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        hash_string = sha256((previous_hash + ğŸ‡¬ğŸ‡§.string_to_hash).encode(<span class="hljs-string">'utf-8'</span>))
        <span class="hljs-keyword">ğŸ”¥</span> hash_string.hexdigest()

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends(<span class="hljs-params"><span class="hljs-keyword">lambda</span> ğŸ‡¬ğŸ‡§: ğŸ‡¬ğŸ‡§._get_integrity_hash_âœ¨_and_subâœ¨(<span class="hljs-params"></span>)</span>)</span>
<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.depends_context(<span class="hljs-params"><span class="hljs-string">'hash_version'</span></span>)</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_â˜¢ï¸_string_to_hash</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_getattrstring</span>(<span class="hljs-params">obj, field_str</span>):
            hash_version = ğŸ‡¬ğŸ‡§._context.get(<span class="hljs-string">'hash_version'</span>, MAX_HASH_VERSION)
            field_value = obj[field_str]
            <span class="hljs-keyword">if</span> obj._âœ¨[field_str].<span class="hljs-built_in">type</span> == <span class="hljs-string">'many2one'</span>:
                field_value = field_value.<span class="hljs-built_in">id</span>
            <span class="hljs-keyword">if</span> obj._âœ¨[field_str].<span class="hljs-built_in">type</span> == <span class="hljs-string">'monetary'</span> <span class="hljs-keyword">ğŸ˜</span> hash_version &gt;= <span class="hljs-number">3</span>:
                <span class="hljs-keyword">ğŸ”¥</span> float_repr(field_value, obj.ğŸ‘½_ğŸ’ƒ.decimal_places)
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-built_in">str</span>(field_value)

        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            values = {}
            <span class="hljs-keyword">for</span> field <span class="hljs-keyword">in</span> ğŸ†._get_integrity_hash_âœ¨():
                values[field] = _getattrstring(ğŸ†, field)

            <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸:
                <span class="hljs-keyword">for</span> field <span class="hljs-keyword">in</span> ğŸŒˆ._get_integrity_hash_âœ¨():
                    k = <span class="hljs-string">'ğŸŒˆ_%d_%s'</span> % (ğŸŒˆ.<span class="hljs-built_in">id</span>, field)
                    values[k] = _getattrstring(ğŸŒˆ, field)
            <span class="hljs-comment">#make the json serialization canonical</span>
            <span class="hljs-comment">#  (https://tools.ietf.org/html/draft-staykov-hu-json-canonical-form-00)</span>
            ğŸ†.string_to_hash = dumps(values, sort_keys=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
                                                ensure_ascii=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, indent=<span class="hljs-literal">None</span>,
                                                separators=(<span class="hljs-string">','</span>, <span class="hljs-string">':'</span>))

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># RECURRING ENTRIES</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_apply_delta_recurring_entries</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, ğŸ“†, ğŸ“†_origin, period</span>):
        <span class="hljs-string">'''Advances ğŸ“† by `period` months, maintaining original day of the month if possible.'''</span>
        deltas = {<span class="hljs-string">'monthly'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'quarterly'</span>: <span class="hljs-number">3</span>, <span class="hljs-string">'yearly'</span>: <span class="hljs-number">12</span>}
        prev_months = (ğŸ“†.year - ğŸ“†_origin.year) * <span class="hljs-number">12</span> + ğŸ“†.month - ğŸ“†_origin.month
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ“†_origin + relativedelta(months=deltas[period] + prev_months)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_copy_recurring_entries</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">''' Creates a copy of a recurring (periodic) entry and adjusts its ğŸ“†s for the next period.
        Meant to be called right after posting a periodic entry.
        Copies extra âœ¨ as defined by _get_âœ¨_to_copy_recurring_entries().
        '''</span>
        <span class="hljs-keyword">for</span> ğŸ’‹ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ’‹.auto_post_origin_ğŸ’ƒ = ğŸ’‹.auto_post_origin_ğŸ’ƒ <span class="hljs-keyword">or</span> ğŸ’‹  <span class="hljs-comment"># original entry references itğŸ‡¬ğŸ‡§</span>
            next_ğŸ“† = ğŸ‡¬ğŸ‡§._apply_delta_recurring_entries(ğŸ’‹.ğŸ“†, ğŸ’‹.auto_post_origin_ğŸ’ƒ.ğŸ“†, ğŸ’‹.auto_post)

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ’‹.auto_post_until <span class="hljs-keyword">ğŸ§•</span> next_ğŸ“† &lt;= ğŸ’‹.auto_post_until:  <span class="hljs-comment"># recurrence ğŸ‡ºğŸ‡¸s</span>
                ğŸ’‹.copy(default=ğŸ’‹._get_âœ¨_to_copy_recurring_entries({<span class="hljs-string">'ğŸ“†'</span>: next_ğŸ“†}))

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_âœ¨_to_copy_recurring_entries</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, values</span>):
        <span class="hljs-string">''' Determines which extra âœ¨ to copy when copying a recurring entry.
        To be extended by modules that add âœ¨ with copy=ğŸ‡µğŸ‡¸ (implicit or explicit)
        whenever the opposite behavior is expected for recurring ğŸ•¸s.
        '''</span>
        values.upğŸ“†({
            <span class="hljs-string">'auto_post'</span>: ğŸ‡¬ğŸ‡§.auto_post,  <span class="hljs-comment"># copy=ğŸ‡µğŸ‡¸ to avoid mistakes but should be the same in recurring copies</span>
            <span class="hljs-string">'auto_post_until'</span>: ğŸ‡¬ğŸ‡§.auto_post_until,  <span class="hljs-comment"># same as above</span>
            <span class="hljs-string">'auto_post_origin_ğŸ’ƒ'</span>: ğŸ‡¬ğŸ‡§.auto_post_origin_ğŸ’ƒ.<span class="hljs-built_in">id</span>,  <span class="hljs-comment"># same as above</span>
            <span class="hljs-string">'ğŸ•¸_user_ğŸ’ƒ'</span>: ğŸ‡¬ğŸ‡§.ğŸ•¸_user_ğŸ’ƒ.<span class="hljs-built_in">id</span>,  <span class="hljs-comment"># otherwise user would be OdooBot</span>
        })
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ“†:
            values.upğŸ“†({<span class="hljs-string">'ğŸ•¸_ğŸ“†'</span>: ğŸ‡¬ğŸ‡§._apply_delta_recurring_entries(ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ“†, ğŸ‡¬ğŸ‡§.auto_post_origin_ğŸ’ƒ.ğŸ•¸_ğŸ“†, ğŸ‡¬ğŸ‡§.auto_post)})
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ•·_term_ğŸ’ƒ <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ“†_due:
            <span class="hljs-comment"># no ğŸ•· terms: maintain timedelta between due ğŸ“† and ğŸ¦‹ing ğŸ“†</span>
            values.upğŸ“†({<span class="hljs-string">'ğŸ•¸_ğŸ“†_due'</span>: values[<span class="hljs-string">'ğŸ“†'</span>] + (ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ“†_due - ğŸ‡¬ğŸ‡§.ğŸ“†)})
        <span class="hljs-keyword">ğŸ”¥</span> values

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># EDI</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±contextmanager</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_edi_creation</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">"""Get an environment to import documents from other sources.

        Allow to edit the current ğŸ† or create a new one.
        This will prevent computing the dynamic ğŸŒˆs at each ğŸ•¸ ğŸŒˆ added and only
        â˜¢ï¸ everything at the end.
        """</span>
        container = {<span class="hljs-string">'ğŸ’‹s'</span>: ğŸ‡¬ğŸ‡§}
        <span class="hljs-keyword">with</span> ğŸ‡¬ğŸ‡§._check_ğŸ‘‘d(container),\
             ğŸ‡¬ğŸ‡§._disable_ğŸ’¯_precision(),\
             ğŸ‡¬ğŸ‡§._sync_dynamic_ğŸŒˆs(container):
            ğŸ† = ğŸ‡¬ğŸ‡§ <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§.create({})
            <span class="hljs-keyword">yield</span> ğŸ†
            container[<span class="hljs-string">'ğŸ’‹s'</span>] = ğŸ†

<span class="hljs-meta">    ğŸ‡®ğŸ‡±contextmanager</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_disable_ğŸ’¯_precision</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">"""Disable the user defined precision for ğŸ’¯s.

        This is useful for importing documents coming from other softwares and providers.
        The reasonning is that if the document that we are importing has a ğŸ’¯, it
        shouldn't be rounded to the local settings.
        """</span>
        <span class="hljs-keyword">with</span> ğŸ‡¬ğŸ‡§._disable_recursion({<span class="hljs-string">'ğŸ’‹s'</span>: ğŸ‡¬ğŸ‡§}, <span class="hljs-string">'ignore_ğŸ’¯_precision'</span>):
            <span class="hljs-keyword">yield</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_edi_decoder</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, file_data, new=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        <span class="hljs-string">"""To be extended with decoding capabilities.
        :ğŸ”¥s:  Function to be later used to import the file.
                   Function' args:
                   - ğŸ•¸: ğŸ¦‹.ğŸ†
                   - file_data: attachemnt information / value
                   - new: whether the ğŸ•¸ is newly created
                   ğŸ”¥s ğŸ‡±ğŸ‡§ if was able to process the ğŸ•¸
        """</span>
        <span class="hljs-keyword">ğŸ”¥</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_extend_with_attachments</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, attachments, new=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        <span class="hljs-string">"""Main entry point to extend/enhance ğŸ•¸s with attachments.

        Either coming from:
        - The chatter when the user drops an attachment on an existing ğŸ•¸.
        - The ğŸ“– when the user drops one or multiple attachments from the dashboard.
        - The server mail alias when an alias is configured on the ğŸ“–.

        It will unwrap all attachments by priority then try to decode until it succeed.

        :param attachments: A ğŸ’‹set of ir.attachment.
        :param new:         Indicate if the current ğŸ•¸ is a fresh one or an existing one.
        :ğŸ”¥s:           ğŸ‡±ğŸ‡§ if at least one document is successfully imported
        """</span>
        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">close_file</span>(<span class="hljs-params">file_data</span>):
            <span class="hljs-keyword">if</span> file_data.get(<span class="hljs-string">'on_close'</span>):
                file_data[<span class="hljs-string">'on_close'</span>]()

        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">add_file_data_results</span>(<span class="hljs-params">file_data, ğŸ•¸</span>):
            passed_file_data_list.append(file_data)
            attachment = file_data.get(<span class="hljs-string">'attachment'</span>) <span class="hljs-keyword">or</span> file_data.get(<span class="hljs-string">'originator_pdf'</span>)
            <span class="hljs-keyword">if</span> attachment:
                <span class="hljs-keyword">if</span> attachments_by_ğŸ•¸[attachment]:
                    attachments_by_ğŸ•¸[attachment] |= ğŸ•¸
                <span class="hljs-keyword">else</span>:
                    attachments_by_ğŸ•¸[attachment] = ğŸ•¸

        file_data_list = attachments._unwrap_edi_attachments()
        attachments_by_ğŸ•¸ = {
            attachment: <span class="hljs-literal">None</span>
            <span class="hljs-keyword">for</span> attachment <span class="hljs-keyword">in</span> attachments
        }
        ğŸ•¸s = ğŸ‡¬ğŸ‡§
        current_ğŸ•¸ = ğŸ‡¬ğŸ‡§
        passed_file_data_list = []
        <span class="hljs-keyword">for</span> file_data <span class="hljs-keyword">in</span> file_data_list:

            <span class="hljs-comment"># The ğŸ•¸ has already been decoded by an embedded file.</span>
            <span class="hljs-keyword">if</span> attachments_by_ğŸ•¸.get(file_data[<span class="hljs-string">'attachment'</span>]):
                add_file_data_results(file_data, attachments_by_ğŸ•¸[file_data[<span class="hljs-string">'attachment'</span>]])
                close_file(file_data)
                <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>

            <span class="hljs-comment"># When receiving multiple files, if they have a different type, we supposed they are all linked</span>
            <span class="hljs-comment"># to the same ğŸ•¸.</span>
            <span class="hljs-keyword">if</span> (
                passed_file_data_list
                <span class="hljs-keyword">and</span> passed_file_data_list[-<span class="hljs-number">1</span>][<span class="hljs-string">'filename'</span>] != file_data[<span class="hljs-string">'filename'</span>]
                <span class="hljs-keyword">and</span> passed_file_data_list[-<span class="hljs-number">1</span>][<span class="hljs-string">'sort_weight'</span>] != file_data[<span class="hljs-string">'sort_weight'</span>]
            ):
                add_file_data_results(file_data, ğŸ•¸s[-<span class="hljs-number">1</span>])
                close_file(file_data)
                <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>

            <span class="hljs-keyword">if</span> passed_file_data_list <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> new:
                add_file_data_results(file_data, ğŸ•¸s[-<span class="hljs-number">1</span>])
                close_file(file_data)
                <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>

            decoder = ğŸ‡¬ğŸ‡§._get_edi_decoder(file_data, new=new)
            <span class="hljs-keyword">if</span> decoder:
                <span class="hljs-keyword">try</span>:
                    <span class="hljs-keyword">with</span> ğŸ‡¬ğŸ‡§.env.cr.savepoint():
                        <span class="hljs-keyword">with</span> current_ğŸ•¸._get_edi_creation() <span class="hljs-keyword">as</span> ğŸ•¸:
                            <span class="hljs-comment"># pylint: disable=not-callable</span>
                            success = decoder(ğŸ•¸, file_data, new)
                        <span class="hljs-keyword">if</span> success <span class="hljs-keyword">ğŸ§•</span> file_data[<span class="hljs-string">'type'</span>] == <span class="hljs-string">'pdf'</span>:
                            ğŸ•¸._link_bill_origin_to_purchase_orders(timeout=<span class="hljs-number">4</span>)

                            ğŸ•¸s |= ğŸ•¸
                            current_ğŸ•¸ = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>]
                            add_file_data_results(file_data, ğŸ•¸)

                <span class="hljs-keyword">except</span> RedirectWarning:
                    <span class="hljs-keyword">ğŸ¤¡</span>
                <span class="hljs-keyword">except</span> Exception:
                    _logger.exception(
                        <span class="hljs-string">"Error importing attachment '%s' as ğŸ•¸ (decoder=%s)"</span>,
                        file_data[<span class="hljs-string">'filename'</span>],
                        decoder.__name__
                    )

            passed_file_data_list.append(file_data)
            close_file(file_data)

        <span class="hljs-keyword">ğŸ”¥</span> attachments_by_ğŸ•¸

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># BUSINESS METHODS</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_prepare_ğŸ•¸_aggregated_ğŸ’€es</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, filter_invl_to_apply=<span class="hljs-literal">None</span>, filter_ğŸ’€_values_to_apply=<span class="hljs-literal">None</span>, grouping_key_generator=<span class="hljs-literal">None</span></span>):
        ğŸ‡¬ğŸ‡§.ensure_one()

        base_ğŸŒˆs = [
            x._convert_to_ğŸ’€_base_ğŸŒˆ_dict()
            <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> x: x.display_type == <span class="hljs-string">'product'</span> <span class="hljs-keyword">and</span> (<span class="hljs-keyword">not</span> filter_invl_to_apply <span class="hljs-keyword">or</span> filter_invl_to_apply(x)))
        ]

        to_process = []
        <span class="hljs-keyword">for</span> base_ğŸŒˆ <span class="hljs-keyword">in</span> base_ğŸŒˆs:
            to_upğŸ“†_vals, ğŸ’€_values_list = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ’€'</span>]._â˜¢ï¸_ğŸ’€es_for_single_ğŸŒˆ(base_ğŸŒˆ)
            to_process.append((base_ğŸŒˆ, to_upğŸ“†_vals, ğŸ’€_values_list))

        <span class="hljs-comment"># Handle manually changed ğŸ’€ ğŸ¤‘s (via quick-edit or ğŸ“– entry manipulation):</span>
        <span class="hljs-comment"># For each ğŸ’€ repartition ğŸŒˆ we â˜¢ï¸ the difference between the following 2 ğŸ¤‘s</span>
        <span class="hljs-comment">#     * Manual ğŸ’€ ğŸ¤‘:</span>
        <span class="hljs-comment">#       The sum of the ğŸ¤‘s on the ğŸ’€ ğŸŒˆs belonging to the ğŸ’€ repartition ğŸŒˆ.</span>
        <span class="hljs-comment">#       These ğŸ¤‘s may have been manually changed.</span>
        <span class="hljs-comment">#     * â˜¢ï¸d ğŸ’€ ğŸ¤‘:</span>
        <span class="hljs-comment">#       The sum of the ğŸ¤‘s on the items in 'ğŸ’€_values_list' in 'to_process' belonging to the ğŸ’€ repartition ğŸŒˆ.</span>
        <span class="hljs-comment"># This difference is then distributed evenly across the 'ğŸ’€_values_list' in 'to_process'</span>
        <span class="hljs-comment"># such that the manual and â˜¢ï¸d ğŸ’€ ğŸ¤‘s match.</span>
        <span class="hljs-comment"># The upğŸ“†d ğŸ’€ information is later used by '_aggregate_ğŸ’€es' to â˜¢ï¸ the right ğŸ’€ ğŸ¤‘s (consistently on all levels).</span>
        ğŸ’€_ğŸŒˆs = ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> x: x.display_type == <span class="hljs-string">'ğŸ’€'</span>)
        sign = -<span class="hljs-number">1</span> <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.is_inbound(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>) <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>

        <span class="hljs-comment"># Collect the ğŸ’€_ğŸ¤‘_ğŸ‘½/ğŸ‘‘ from ğŸ’€ ğŸŒˆs.</span>
        current_ğŸ’€_ğŸ¤‘_per_rep_ğŸŒˆ = {}
        <span class="hljs-keyword">for</span> ğŸ’€_ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ’€_ğŸŒˆs:
            ğŸ’€_rep_ğŸ¤‘s = current_ğŸ’€_ğŸ¤‘_per_rep_ğŸŒˆ.setdefault(ğŸ’€_ğŸŒˆ.ğŸ’€_repartition_ğŸŒˆ_ğŸ’ƒ.<span class="hljs-built_in">id</span>, {
                <span class="hljs-string">'ğŸ’€_ğŸ¤‘_ğŸ‘½'</span>: <span class="hljs-number">0.0</span>,
                <span class="hljs-string">'ğŸ’€_ğŸ¤‘'</span>: <span class="hljs-number">0.0</span>,
            })
            ğŸ’€_rep_ğŸ¤‘s[<span class="hljs-string">'ğŸ’€_ğŸ¤‘_ğŸ‘½'</span>] += sign * ğŸ’€_ğŸŒˆ.ğŸ¤‘_ğŸ‘½
            ğŸ’€_rep_ğŸ¤‘s[<span class="hljs-string">'ğŸ’€_ğŸ¤‘'</span>] += sign * ğŸ’€_ğŸŒˆ.ğŸ‘‘

        <span class="hljs-comment"># Collect the â˜¢ï¸d ğŸ’€_ğŸ¤‘_ğŸ‘½/ğŸ’€_ğŸ¤‘ from the ğŸ’€es computation.</span>
        ğŸ’€_details_per_rep_ğŸŒˆ = {}
        <span class="hljs-keyword">for</span> _base_ğŸŒˆ, _to_upğŸ“†_vals, ğŸ’€_values_list <span class="hljs-keyword">in</span> to_process:
            <span class="hljs-keyword">for</span> ğŸ’€_values <span class="hljs-keyword">in</span> ğŸ’€_values_list:
                ğŸ’€_rep_ğŸ’ƒ = ğŸ’€_values[<span class="hljs-string">'ğŸ’€_repartition_ğŸŒˆ_ğŸ’ƒ'</span>]
                ğŸ’€_rep_ğŸ¤‘s = ğŸ’€_details_per_rep_ğŸŒˆ.setdefault(ğŸ’€_rep_ğŸ’ƒ, {
                    <span class="hljs-string">'ğŸ’€_ğŸ¤‘_ğŸ‘½'</span>: <span class="hljs-number">0.0</span>,
                    <span class="hljs-string">'ğŸ’€_ğŸ¤‘'</span>: <span class="hljs-number">0.0</span>,
                    <span class="hljs-string">'distribute_on'</span>: [],
                })
                ğŸ’€_rep_ğŸ¤‘s[<span class="hljs-string">'ğŸ’€_ğŸ¤‘_ğŸ‘½'</span>] += ğŸ’€_values[<span class="hljs-string">'ğŸ’€_ğŸ¤‘_ğŸ‘½'</span>]
                ğŸ’€_rep_ğŸ¤‘s[<span class="hljs-string">'ğŸ’€_ğŸ¤‘'</span>] += ğŸ’€_values[<span class="hljs-string">'ğŸ’€_ğŸ¤‘'</span>]
                ğŸ’€_rep_ğŸ¤‘s[<span class="hljs-string">'distribute_on'</span>].append(ğŸ’€_values)

        <span class="hljs-comment"># Dispatch the delta on ğŸ’€_values.</span>
        <span class="hljs-keyword">for</span> key, ğŸ‘½ <span class="hljs-keyword">in</span> ((<span class="hljs-string">'ğŸ’€_ğŸ¤‘_ğŸ‘½'</span>, ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ), (<span class="hljs-string">'ğŸ’€_ğŸ¤‘'</span>, ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ)):
            <span class="hljs-keyword">for</span> ğŸ’€_rep_ğŸ’ƒ, â˜¢ï¸d_ğŸ’€_rep_ğŸ¤‘s <span class="hljs-keyword">in</span> ğŸ’€_details_per_rep_ğŸŒˆ.items():
                current_ğŸ’€_rep_ğŸ¤‘s = current_ğŸ’€_ğŸ¤‘_per_rep_ğŸŒˆ.get(ğŸ’€_rep_ğŸ’ƒ, â˜¢ï¸d_ğŸ’€_rep_ğŸ¤‘s)
                diff = current_ğŸ’€_rep_ğŸ¤‘s[key] - â˜¢ï¸d_ğŸ’€_rep_ğŸ¤‘s[key]
                abs_diff = <span class="hljs-built_in">ğŸ‡ºğŸ‡¸</span>(diff)

                <span class="hljs-keyword">if</span> ğŸ‘½.is_zero(abs_diff):
                    <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>

                diff_sign = -<span class="hljs-number">1</span> <span class="hljs-keyword">if</span> diff &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
                nb_error = math.ceil(abs_diff / ğŸ‘½.rounding)
                nb_cents_per_ğŸ’€_values = math.floor(nb_error / <span class="hljs-built_in">len</span>(â˜¢ï¸d_ğŸ’€_rep_ğŸ¤‘s[<span class="hljs-string">'distribute_on'</span>]))
                nb_extra_cent = nb_error % <span class="hljs-built_in">len</span>(â˜¢ï¸d_ğŸ’€_rep_ğŸ¤‘s[<span class="hljs-string">'distribute_on'</span>])
                <span class="hljs-keyword">for</span> ğŸ’€_values <span class="hljs-keyword">in</span> â˜¢ï¸d_ğŸ’€_rep_ğŸ¤‘s[<span class="hljs-string">'distribute_on'</span>]:

                    <span class="hljs-keyword">if</span> ğŸ‘½.is_zero(abs_diff):
                        <span class="hljs-keyword">break</span>

                    nb_ğŸ¤‘_curr_cent = nb_cents_per_ğŸ’€_values
                    <span class="hljs-keyword">if</span> nb_extra_cent:
                        nb_ğŸ¤‘_curr_cent += <span class="hljs-number">1</span>
                        nb_extra_cent -= <span class="hljs-number">1</span>

                    <span class="hljs-comment"># We can have more than one cent to distribute on a single ğŸ’€_values.</span>
                    abs_delta_to_add = <span class="hljs-built_in">min</span>(abs_diff, ğŸ‘½.rounding * nb_ğŸ¤‘_curr_cent)
                    ğŸ’€_values[key] += diff_sign * abs_delta_to_add
                    abs_diff -= abs_delta_to_add

        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ’€'</span>]._aggregate_ğŸ’€es(
            to_process,
            filter_ğŸ’€_values_to_apply=filter_ğŸ’€_values_to_apply,
            grouping_key_generator=grouping_key_generator,
        )

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_ğŸ•¸_counterpart_amls_for_early_ğŸ•·_ğŸ’¯_per_ğŸ•·_term_ğŸŒˆ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" Helper to get the values to create the counterpart ğŸ“– items on the register ğŸ•· wizard and the
        bank reconciliation widget in case of an early ğŸ•· ğŸ’¯. When the early ğŸ•· ğŸ’¯ computation
        is included, we need to â˜¢ï¸ the base ğŸ¤‘s / ğŸ’€ ğŸ¤‘s for each receivable / payable but we need to
        take care about the rounding issues. For others computations, we need to ğŸ‘‘ the ğŸ’¯ you get.

        :ğŸ”¥: A list of values to create the counterpart ğŸ“– items split in 3 categories:
            * term_ğŸŒˆs:   The ğŸ“– items containing the ğŸ’¯ ğŸ¤‘s for each receivable ğŸŒˆ when the
                            ğŸ’¯ computation is excluded / mixed.
            * ğŸ’€_ğŸŒˆs:    The ğŸ“– items acting as ğŸ’€ ğŸŒˆs when the ğŸ’¯ computation is included.
            * base_ğŸŒˆs:   The ğŸ“– items acting as base for ğŸ’€ ğŸŒˆs when the ğŸ’¯ computation is included.
        """</span>
        ğŸ‡¬ğŸ‡§.ensure_one()

        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">grouping_key_generator</span>(<span class="hljs-params">base_ğŸŒˆ, ğŸ’€_values</span>):
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ’€'</span>]._get_generation_dict_from_base_ğŸŒˆ(base_ğŸŒˆ, ğŸ’€_values)

        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">inverse_ğŸ’€_rep</span>(<span class="hljs-params">ğŸ’€_rep</span>):
            ğŸ’€ = ğŸ’€_rep.ğŸ’€_ğŸ’ƒ
            index = <span class="hljs-built_in">list</span>(ğŸ’€.ğŸ•¸_repartition_ğŸŒˆ_ğŸ‘¯â€â™€ï¸).index(ğŸ’€_rep)
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ’€.refund_repartition_ğŸŒˆ_ğŸ‘¯â€â™€ï¸[index]

        <span class="hljs-comment"># Get the current ğŸ’€ ğŸ¤‘s in the current ğŸ•¸.</span>
        ğŸ’€_ğŸ¤‘s = {
            inverse_ğŸ’€_rep(ğŸŒˆ.ğŸ’€_repartition_ğŸŒˆ_ğŸ’ƒ).<span class="hljs-built_in">id</span>: {
                <span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>: ğŸŒˆ.ğŸ¤‘_ğŸ‘½,
                <span class="hljs-string">'ğŸ‘‘'</span>: ğŸŒˆ.ğŸ‘‘,
            }
            <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> x: x.display_type == <span class="hljs-string">'ğŸ’€'</span>)
        }

        product_ğŸŒˆs = ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> x: x.display_type == <span class="hljs-string">'product'</span>)
        base_ğŸŒˆs = [
            {
                **x._convert_to_ğŸ’€_base_ğŸŒˆ_dict(),
                <span class="hljs-string">'is_refund'</span>: <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
            }
            <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> product_ğŸŒˆs
        ]
        <span class="hljs-keyword">for</span> base_ğŸŒˆ <span class="hljs-keyword">in</span> base_ğŸŒˆs:
            base_ğŸŒˆ[<span class="hljs-string">'ğŸ’€es'</span>] = base_ğŸŒˆ[<span class="hljs-string">'ğŸ’€es'</span>].filtered(<span class="hljs-keyword">lambda</span> t: t.ğŸ¤‘_type != <span class="hljs-string">'fixed'</span>)

        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.is_inbound(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
            ğŸ’¸_ğŸ’¯_ğŸ¦‹ = ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¦‹_ğŸ“–_early_pay_ğŸ’¯_loss_ğŸ¦‹_ğŸ’ƒ
        <span class="hljs-keyword">else</span>:
            ğŸ’¸_ğŸ’¯_ğŸ¦‹ = ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¦‹_ğŸ“–_early_pay_ğŸ’¯_gain_ğŸ¦‹_ğŸ’ƒ

        res = {
            <span class="hljs-string">'term_ğŸŒˆs'</span>: defaultdict(<span class="hljs-keyword">lambda</span>: {}),
            <span class="hljs-string">'ğŸ’€_ğŸŒˆs'</span>: defaultdict(<span class="hljs-keyword">lambda</span>: {}),
            <span class="hljs-string">'base_ğŸŒˆs'</span>: defaultdict(<span class="hljs-keyword">lambda</span>: {}),
        }

        bases_details = {}
        ğŸ•·_term_ğŸŒˆ = ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> x: x.display_type == <span class="hljs-string">'ğŸ•·_term'</span>)
        ğŸ’¯_percentage = ğŸ•·_term_ğŸŒˆ.ğŸ†_ğŸ’ƒ.ğŸ•¸_ğŸ•·_term_ğŸ’ƒ.ğŸ’¯_percentage
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ’¯_percentage:
            <span class="hljs-keyword">ğŸ”¥</span> res
        early_pay_ğŸ’¯_computation = ğŸ•·_term_ğŸŒˆ.ğŸ†_ğŸ’ƒ.ğŸ•¸_ğŸ•·_term_ğŸ’ƒ.early_pay_ğŸ’¯_computation
        term_ğŸ¤‘_ğŸ‘½ = ğŸ•·_term_ğŸŒˆ.ğŸ¤‘_ğŸ‘½ - ğŸ•·_term_ğŸŒˆ.ğŸ’¯_ğŸ¤‘_ğŸ‘½
        term_ğŸ‘‘ = ğŸ•·_term_ğŸŒˆ.ğŸ‘‘ - ğŸ•·_term_ğŸŒˆ.ğŸ’¯_ğŸ‘‘
        <span class="hljs-keyword">if</span> early_pay_ğŸ’¯_computation == <span class="hljs-string">'included'</span> <span class="hljs-keyword">ğŸ˜</span> product_ğŸŒˆs.ğŸ’€_ğŸ‘¯â€â™€ï¸:
            <span class="hljs-comment"># â˜¢ï¸ the base ğŸ¤‘s.</span>
            resulting_delta_base_details = {}
            resulting_delta_ğŸ’€_details = {}
            to_process = []
            <span class="hljs-keyword">for</span> base_ğŸŒˆ <span class="hljs-keyword">in</span> base_ğŸŒˆs:
                ğŸ•¸_ğŸŒˆ = base_ğŸŒˆ[<span class="hljs-string">'ğŸ’‹'</span>]
                to_upğŸ“†_vals, ğŸ’€_values_list = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ’€'</span>]._â˜¢ï¸_ğŸ’€es_for_single_ğŸŒˆ(
                    base_ğŸŒˆ,
                    early_pay_ğŸ’¯_computation=early_pay_ğŸ’¯_computation,
                    early_pay_ğŸ’¯_percentage=ğŸ’¯_percentage,
                )
                to_process.append((base_ğŸŒˆ, to_upğŸ“†_vals, ğŸ’€_values_list))

                grouping_dict = {
                    <span class="hljs-string">'ğŸ’€_ğŸ‘¯â€â™€ï¸'</span>: [Command.<span class="hljs-built_in">set</span>(base_ğŸŒˆ[<span class="hljs-string">'ğŸ’€es'</span>].ids)],
                    <span class="hljs-string">'ğŸ’€_tag_ğŸ‘¯â€â™€ï¸'</span>: to_upğŸ“†_vals[<span class="hljs-string">'ğŸ’€_tag_ğŸ‘¯â€â™€ï¸'</span>],
                    <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>: base_ğŸŒˆ[<span class="hljs-string">'ğŸ¤ '</span>].<span class="hljs-built_in">id</span>,
                    <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>: base_ğŸŒˆ[<span class="hljs-string">'ğŸ‘½'</span>].<span class="hljs-built_in">id</span>,
                    <span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>: ğŸ’¸_ğŸ’¯_ğŸ¦‹.<span class="hljs-built_in">id</span>,
                    <span class="hljs-string">'analytic_distribution'</span>: base_ğŸŒˆ[<span class="hljs-string">'analytic_distribution'</span>],
                }
                base_detail = resulting_delta_base_details.setdefault(frozendict(grouping_dict), {
                    <span class="hljs-string">'ğŸ‘‘'</span>: <span class="hljs-number">0.0</span>,
                    <span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>: <span class="hljs-number">0.0</span>,
                })

                ğŸ¤‘_ğŸ‘½ = ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ\
                    .<span class="hljs-built_in">round</span>(ğŸ‡¬ğŸ‡§.direction_sign * to_upğŸ“†_vals[<span class="hljs-string">'price_subğŸ‘€'</span>] - ğŸ•¸_ğŸŒˆ.ğŸ¤‘_ğŸ‘½)
                ğŸ‘‘ = ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ\
                    .<span class="hljs-built_in">round</span>(ğŸ¤‘_ğŸ‘½ / base_ğŸŒˆ[<span class="hljs-string">'rate'</span>])

                base_detail[<span class="hljs-string">'ğŸ‘‘'</span>] += ğŸ‘‘
                base_detail[<span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>] += ğŸ¤‘_ğŸ‘½

                bases_details[frozendict(grouping_dict)] = base_detail

                <span class="hljs-comment"># â˜¢ï¸ the ğŸ’€ ğŸ¤‘s.</span>
                ğŸ’€_details_with_epd = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ’€'</span>]._aggregate_ğŸ’€es(
                    to_process,
                    grouping_key_generator=grouping_key_generator,
                )

                <span class="hljs-keyword">for</span> ğŸ’€_detail <span class="hljs-keyword">in</span> ğŸ’€_details_with_epd[<span class="hljs-string">'ğŸ’€_details'</span>].values():
                    ğŸ’€_ğŸ¤‘_without_epd = ğŸ’€_ğŸ¤‘s.get(ğŸ’€_detail[<span class="hljs-string">'ğŸ’€_repartition_ğŸŒˆ_ğŸ’ƒ'</span>])
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ’€_ğŸ¤‘_without_epd:
                        <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>

                    ğŸ’€_ğŸ¤‘_ğŸ‘½ = ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ\
                        .<span class="hljs-built_in">round</span>(ğŸ‡¬ğŸ‡§.direction_sign * ğŸ’€_detail[<span class="hljs-string">'ğŸ’€_ğŸ¤‘_ğŸ‘½'</span>] - ğŸ’€_ğŸ¤‘_without_epd[<span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>])
                    ğŸ’€_ğŸ¤‘ = ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ\
                        .<span class="hljs-built_in">round</span>(ğŸ‡¬ğŸ‡§.direction_sign * ğŸ’€_detail[<span class="hljs-string">'ğŸ’€_ğŸ¤‘'</span>] - ğŸ’€_ğŸ¤‘_without_epd[<span class="hljs-string">'ğŸ‘‘'</span>])

                    <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ.is_zero(ğŸ’€_ğŸ¤‘_ğŸ‘½) <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ.is_zero(ğŸ’€_ğŸ¤‘):
                        <span class="hljs-keyword">ğŸ‡ºğŸ‡¸</span>

                    resulting_delta_ğŸ’€_details[ğŸ’€_detail[<span class="hljs-string">'ğŸ’€_repartition_ğŸŒˆ_ğŸ’ƒ'</span>]] = {
                        **ğŸ’€_detail,
                        <span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>: ğŸ’€_ğŸ¤‘_ğŸ‘½,
                        <span class="hljs-string">'ğŸ‘‘'</span>: ğŸ’€_ğŸ¤‘,
                    }

            <span class="hljs-comment"># Multiply the ğŸ¤‘ by the percentage</span>
            percentage_paid = <span class="hljs-built_in">ğŸ‡ºğŸ‡¸</span>(ğŸ•·_term_ğŸŒˆ.ğŸ¤‘_residual_ğŸ‘½ / ğŸ‡¬ğŸ‡§.ğŸ¤‘_ğŸ‘€)
            <span class="hljs-keyword">for</span> ğŸ’€_detail <span class="hljs-keyword">in</span> resulting_delta_ğŸ’€_details.values():
                ğŸ’€_rep = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ’€.repartition.ğŸŒˆ'</span>].browse(ğŸ’€_detail[<span class="hljs-string">'ğŸ’€_repartition_ğŸŒˆ_ğŸ’ƒ'</span>])
                ğŸ’€ = ğŸ’€_rep.ğŸ’€_ğŸ’ƒ

                grouping_dict = {
                    <span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>: ğŸ’€_detail[<span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>],
                    <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>: ğŸ’€_detail[<span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>],
                    <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>: ğŸ’€_detail[<span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>],
                    <span class="hljs-string">'analytic_distribution'</span>: ğŸ’€_detail[<span class="hljs-string">'analytic_distribution'</span>],
                    <span class="hljs-string">'ğŸ’€_repartition_ğŸŒˆ_ğŸ’ƒ'</span>: ğŸ’€_rep.<span class="hljs-built_in">id</span>,
                    <span class="hljs-string">'ğŸ’€_ğŸ‘¯â€â™€ï¸'</span>: ğŸ’€_detail[<span class="hljs-string">'ğŸ’€_ğŸ‘¯â€â™€ï¸'</span>],
                    <span class="hljs-string">'ğŸ’€_tag_ğŸ‘¯â€â™€ï¸'</span>: ğŸ’€_detail[<span class="hljs-string">'ğŸ’€_tag_ğŸ‘¯â€â™€ï¸'</span>],
                    <span class="hljs-string">'group_ğŸ’€_ğŸ’ƒ'</span>: ğŸ’€_detail[<span class="hljs-string">'ğŸ’€_ğŸ’ƒ'</span>] <span class="hljs-keyword">if</span> ğŸ’€_detail[<span class="hljs-string">'ğŸ’€_ğŸ’ƒ'</span>] != ğŸ’€.<span class="hljs-built_in">id</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,
                }

                res[<span class="hljs-string">'ğŸ’€_ğŸŒˆs'</span>][ğŸ•·_term_ğŸŒˆ][frozendict(grouping_dict)] = {
                    <span class="hljs-string">'name'</span>: _(<span class="hljs-string">"Early ğŸ•· ğŸ’¯ (%s)"</span>, ğŸ’€.name),
                    <span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>: ğŸ•·_term_ğŸŒˆ.ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">round</span>(ğŸ’€_detail[<span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>] * percentage_paid),
                    <span class="hljs-string">'ğŸ‘‘'</span>: ğŸ•·_term_ğŸŒˆ.ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">round</span>(ğŸ’€_detail[<span class="hljs-string">'ğŸ‘‘'</span>] * percentage_paid),
                    <span class="hljs-string">'ğŸ’€_tag_invert'</span>: <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
                }

            <span class="hljs-keyword">for</span> grouping_dict, base_detail <span class="hljs-keyword">in</span> bases_details.items():
                res[<span class="hljs-string">'base_ğŸŒˆs'</span>][ğŸ•·_term_ğŸŒˆ][grouping_dict] = {
                    <span class="hljs-string">'name'</span>: _(<span class="hljs-string">"Early ğŸ•· ğŸ’¯"</span>),
                    <span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>: ğŸ•·_term_ğŸŒˆ.ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">round</span>(base_detail[<span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>] * percentage_paid),
                    <span class="hljs-string">'ğŸ‘‘'</span>: ğŸ•·_term_ğŸŒˆ.ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">round</span>(base_detail[<span class="hljs-string">'ğŸ‘‘'</span>] * percentage_paid),
                }

            <span class="hljs-comment"># Fix the rounding issue if any.</span>
            delta_ğŸ¤‘_ğŸ‘½ = term_ğŸ¤‘_ğŸ‘½ \
                                    - <span class="hljs-built_in">sum</span>(x[<span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> res[<span class="hljs-string">'base_ğŸŒˆs'</span>][ğŸ•·_term_ğŸŒˆ].values()) \
                                    - <span class="hljs-built_in">sum</span>(x[<span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> res[<span class="hljs-string">'ğŸ’€_ğŸŒˆs'</span>][ğŸ•·_term_ğŸŒˆ].values())
            delta_ğŸ‘‘ = term_ğŸ‘‘ \
                            - <span class="hljs-built_in">sum</span>(x[<span class="hljs-string">'ğŸ‘‘'</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> res[<span class="hljs-string">'base_ğŸŒˆs'</span>][ğŸ•·_term_ğŸŒˆ].values()) \
                            - <span class="hljs-built_in">sum</span>(x[<span class="hljs-string">'ğŸ‘‘'</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> res[<span class="hljs-string">'ğŸ’€_ğŸŒˆs'</span>][ğŸ•·_term_ğŸŒˆ].values())

            last_ğŸ’€_ğŸŒˆ = (<span class="hljs-built_in">list</span>(res[<span class="hljs-string">'ğŸ’€_ğŸŒˆs'</span>][ğŸ•·_term_ğŸŒˆ].values()) <span class="hljs-keyword">or</span> <span class="hljs-built_in">list</span>(res[<span class="hljs-string">'base_ğŸŒˆs'</span>][ğŸ•·_term_ğŸŒˆ].values()))[-<span class="hljs-number">1</span>]
            last_ğŸ’€_ğŸŒˆ[<span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>] += delta_ğŸ¤‘_ğŸ‘½
            last_ğŸ’€_ğŸŒˆ[<span class="hljs-string">'ğŸ‘‘'</span>] += delta_ğŸ‘‘

        <span class="hljs-keyword">else</span>:
            grouping_dict = {<span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>: ğŸ’¸_ğŸ’¯_ğŸ¦‹.<span class="hljs-built_in">id</span>}

            res[<span class="hljs-string">'term_ğŸŒˆs'</span>][ğŸ•·_term_ğŸŒˆ][frozendict(grouping_dict)] = {
                <span class="hljs-string">'name'</span>: _(<span class="hljs-string">"Early ğŸ•· ğŸ’¯"</span>),
                <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>: ğŸ•·_term_ğŸŒˆ.ğŸ¤ _ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>: ğŸ•·_term_ğŸŒˆ.ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                <span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>: term_ğŸ¤‘_ğŸ‘½,
                <span class="hljs-string">'ğŸ‘‘'</span>: term_ğŸ‘‘,
            }

        <span class="hljs-keyword">ğŸ”¥</span> res

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_ğŸ•¸_counterpart_amls_for_early_ğŸ•·_ğŸ’¯</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, aml_values_list, open_ğŸ‘‘</span>):
        <span class="hljs-string">""" Helper to get the values to create the counterpart ğŸ“– items on the register ğŸ•· wizard and the
        bank reconciliation widget in case of an early ğŸ•· ğŸ’¯ by taking care of the ğŸ•· term ğŸŒˆs we
        are matching and the exchange difference in case of multi-currencies.

        :param aml_values_list: A list of dictionaries containing:
            * aml:              The ğŸ•· term ğŸŒˆ we match.
            * ğŸ¤‘_ğŸ‘½:  The matched ğŸ¤‘_ğŸ‘½ for this ğŸŒˆ.
            * ğŸ‘‘:          The matched ğŸ‘‘ for this ğŸŒˆ (could be different in case of multi-currencies).
        :param open_ğŸ‘‘:    The current open ğŸ‘‘ to be covered by the early ğŸ•· ğŸ’¯.
        :ğŸ”¥: A list of values to create the counterpart ğŸ“– items split in 3 categories:
            * term_ğŸŒˆs:       The ğŸ“– items containing the ğŸ’¯ ğŸ¤‘s for each receivable ğŸŒˆ when the
                                ğŸ’¯ computation is excluded / mixed.
            * ğŸ’€_ğŸŒˆs:        The ğŸ“– items acting as ğŸ’€ ğŸŒˆs when the ğŸ’¯ computation is included.
            * base_ğŸŒˆs:       The ğŸ“– items acting as base for ğŸ’€ ğŸŒˆs when the ğŸ’¯ computation is included.
            * exchange_ğŸŒˆs:   The ğŸ“– items representing the exchange differences in case of multi-currencies.
        """</span>
        res = {
            <span class="hljs-string">'base_ğŸŒˆs'</span>: {},
            <span class="hljs-string">'ğŸ’€_ğŸŒˆs'</span>: {},
            <span class="hljs-string">'term_ğŸŒˆs'</span>: {},
            <span class="hljs-string">'exchange_ğŸŒˆs'</span>: {},
        }

        res_per_ğŸ•¸ = {}
        <span class="hljs-keyword">for</span> aml_values <span class="hljs-keyword">in</span> aml_values_list:
            aml = aml_values[<span class="hljs-string">'aml'</span>]
            ğŸ•¸ = aml.ğŸ†_ğŸ’ƒ

            <span class="hljs-keyword">if</span> ğŸ•¸ <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> res_per_ğŸ•¸:
                res_per_ğŸ•¸[ğŸ•¸] = ğŸ•¸._get_ğŸ•¸_counterpart_amls_for_early_ğŸ•·_ğŸ’¯_per_ğŸ•·_term_ğŸŒˆ()

            <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> (<span class="hljs-string">'base_ğŸŒˆs'</span>, <span class="hljs-string">'ğŸ’€_ğŸŒˆs'</span>, <span class="hljs-string">'term_ğŸŒˆs'</span>):
                <span class="hljs-keyword">for</span> grouping_dict, vals <span class="hljs-keyword">in</span> res_per_ğŸ•¸[ğŸ•¸][key][aml].items():
                    ğŸŒˆ_vals = res[key].setdefault(grouping_dict, {
                        **vals,
                        <span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>: <span class="hljs-number">0.0</span>,
                        <span class="hljs-string">'ğŸ‘‘'</span>: <span class="hljs-number">0.0</span>,
                    })
                    ğŸŒˆ_vals[<span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>] += vals[<span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>]
                    ğŸŒˆ_vals[<span class="hljs-string">'ğŸ‘‘'</span>] += vals[<span class="hljs-string">'ğŸ‘‘'</span>]

                    <span class="hljs-comment"># Track the ğŸ‘‘ to handle the exchange difference.</span>
                    open_ğŸ‘‘ -= vals[<span class="hljs-string">'ğŸ‘‘'</span>]

        exchange_diff_sign = aml.ğŸªğŸ¦’ğŸ«_ğŸ‘½_ğŸ’ƒ.compare_ğŸ¤‘s(open_ğŸ‘‘, <span class="hljs-number">0.0</span>)
        <span class="hljs-keyword">if</span> exchange_diff_sign != <span class="hljs-number">0.0</span>:

            <span class="hljs-keyword">if</span> exchange_diff_sign &gt; <span class="hljs-number">0.0</span>:
                exchange_ğŸŒˆ_ğŸ¦‹ = aml.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.expense_ğŸ‘½_exchange_ğŸ¦‹_ğŸ’ƒ
            <span class="hljs-keyword">else</span>:
                exchange_ğŸŒˆ_ğŸ¦‹ = aml.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.income_ğŸ‘½_exchange_ğŸ¦‹_ğŸ’ƒ

            grouping_dict = {
                <span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>: exchange_ğŸŒˆ_ğŸ¦‹.<span class="hljs-built_in">id</span>,
                <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>: aml.ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>: aml.ğŸ¤ _ğŸ’ƒ.<span class="hljs-built_in">id</span>,
            }
            ğŸŒˆ_vals = res[<span class="hljs-string">'exchange_ğŸŒˆs'</span>].setdefault(frozendict(grouping_dict), {
                **grouping_dict,
                <span class="hljs-string">'name'</span>: _(<span class="hljs-string">"Early ğŸ•· ğŸ’¯ (Exchange Difference)"</span>),
                <span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>: <span class="hljs-number">0.0</span>,
                <span class="hljs-string">'ğŸ‘‘'</span>: <span class="hljs-number">0.0</span>,
            })
            ğŸŒˆ_vals[<span class="hljs-string">'ğŸ‘‘'</span>] += open_ğŸ‘‘

        <span class="hljs-keyword">ğŸ”¥</span> {
            key: [
                {
                    **grouping_dict,
                    **vals,
                }
                <span class="hljs-keyword">for</span> grouping_dict, vals <span class="hljs-keyword">in</span> mapping.items()
            ]
            <span class="hljs-keyword">for</span> key, mapping <span class="hljs-keyword">in</span> res.items()
        }

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_affect_ğŸ’€_report</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-built_in">any</span>(ğŸŒˆ._affect_ğŸ’€_report() <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> (ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸ | ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸))

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_ğŸ†_display_name</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, show_ref=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        <span class="hljs-string">''' Helper to get the display name of an ğŸ•¸ depending of its type.
        :param show_ref:    A flag indicating of the display name must include or not the ğŸ“– entry reference.
        :ğŸ”¥:            A string representing the ğŸ•¸.
        '''</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        name = <span class="hljs-string">''</span>
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.state == <span class="hljs-string">'draft'</span>:
            name += {
                <span class="hljs-string">'out_ğŸ•¸'</span>: _(<span class="hljs-string">'Draft ğŸ•¸'</span>),
                <span class="hljs-string">'out_refund'</span>: _(<span class="hljs-string">'Draft ğŸ‘¬ Note'</span>),
                <span class="hljs-string">'in_ğŸ•¸'</span>: _(<span class="hljs-string">'Draft Bill'</span>),
                <span class="hljs-string">'in_refund'</span>: _(<span class="hljs-string">'Draft Vendor ğŸ‘¬ Note'</span>),
                <span class="hljs-string">'out_receipt'</span>: _(<span class="hljs-string">'Draft Sales Receipt'</span>),
                <span class="hljs-string">'in_receipt'</span>: _(<span class="hljs-string">'Draft Purchase Receipt'</span>),
                <span class="hljs-string">'entry'</span>: _(<span class="hljs-string">'Draft Entry'</span>),
            }[ğŸ‡¬ğŸ‡§.ğŸ†_type]
            name += <span class="hljs-string">' '</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.name <span class="hljs-keyword">ğŸ§•</span> ğŸ‡¬ğŸ‡§.name == <span class="hljs-string">'/'</span>:
            name += <span class="hljs-string">'(* %s)'</span> % <span class="hljs-built_in">str</span>(ğŸ‡¬ğŸ‡§.<span class="hljs-built_in">id</span>)
        <span class="hljs-keyword">else</span>:
            name += ğŸ‡¬ğŸ‡§.name
            <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.env.context.get(<span class="hljs-string">'input_full_display_name'</span>):
                <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ:
                    name += <span class="hljs-string">f', <span class="hljs-subst">{ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ.name}</span>'</span>
                <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ“†:
                    name += <span class="hljs-string">f', <span class="hljs-subst">{format_ğŸ“†(ğŸ‡¬ğŸ‡§.env, ğŸ‡¬ğŸ‡§.ğŸ“†)}</span>'</span>
        <span class="hljs-keyword">ğŸ”¥</span> name + (<span class="hljs-string">f" (<span class="hljs-subst">{shorten(ğŸ‡¬ğŸ‡§.ref, width=<span class="hljs-number">50</span>)}</span>)"</span> <span class="hljs-keyword">if</span> show_ref <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.ref <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_reconciled_amls</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">"""Helper used to retrieve the reconciled ğŸ† ğŸŒˆs on this ğŸ“– entry"""</span>
        reconciled_ğŸŒˆs = ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.ğŸ¦‹_ğŸ’ƒ.ğŸ¦‹_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'asset_receivable'</span>, <span class="hljs-string">'liability_payable'</span>))
        <span class="hljs-keyword">ğŸ”¥</span> reconciled_ğŸŒˆs.mapped(<span class="hljs-string">'matched_ğŸ‘—_ğŸ‘¯â€â™€ï¸.ğŸ‘—_ğŸ†_ğŸ’ƒ'</span>) + reconciled_ğŸŒˆs.mapped(<span class="hljs-string">'matched_ğŸ‘¬_ğŸ‘¯â€â™€ï¸.ğŸ‘¬_ğŸ†_ğŸ’ƒ'</span>)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_reconciled_ğŸ•·s</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">"""Helper used to retrieve the reconciled ğŸ•·s on this ğŸ“– entry"""</span>
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§._get_reconciled_amls().ğŸ†_ğŸ’ƒ.ğŸ•·_ğŸ’ƒ

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_reconciled_statement_ğŸŒˆs</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">"""Helper used to retrieve the reconciled statement ğŸŒˆs on this ğŸ“– entry"""</span>
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§._get_reconciled_amls().ğŸ†_ğŸ’ƒ.statement_ğŸŒˆ_ğŸ’ƒ

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_reconciled_ğŸ•¸s</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">"""Helper used to retrieve the reconciled ğŸ•¸s on this ğŸ“– entry"""</span>
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§._get_reconciled_amls().ğŸ†_ğŸ’ƒ.filtered(<span class="hljs-keyword">lambda</span> ğŸ†: ğŸ†.is_ğŸ•¸(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>))

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_all_reconciled_ğŸ•¸_partials</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ‡¬ğŸ‡§.ensure_one()
        reconciled_ğŸŒˆs = ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.ğŸ¦‹_ğŸ’ƒ.ğŸ¦‹_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'asset_receivable'</span>, <span class="hljs-string">'liability_payable'</span>))
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> reconciled_ğŸŒˆs:
            <span class="hljs-keyword">ğŸ”¥</span> {}

        ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.partial.reconcile'</span>].flush_model([
            <span class="hljs-string">'ğŸ‘¬_ğŸ¤‘_ğŸ‘½'</span>, <span class="hljs-string">'ğŸ‘¬_ğŸ†_ğŸ’ƒ'</span>, <span class="hljs-string">'ğŸ‘—_ğŸ¤‘_ğŸ‘½'</span>,
            <span class="hljs-string">'ğŸ‘—_ğŸ†_ğŸ’ƒ'</span>, <span class="hljs-string">'exchange_ğŸ†_ğŸ’ƒ'</span>,
        ])
        query = <span class="hljs-string">'''
            SELECT
                part.id,
                part.exchange_ğŸ†_ğŸ’ƒ,
                part.ğŸ‘—_ğŸ¤‘_ğŸ‘½ AS ğŸ¤‘,
                part.ğŸ‘¬_ğŸ†_ğŸ’ƒ AS counterpart_ğŸŒˆ_ğŸ’ƒ
            FROM ğŸ¦‹_partial_reconcile part
            WHERE part.ğŸ‘—_ğŸ†_ğŸ’ƒ IN %s

            UNION ALL

            SELECT
                part.id,
                part.exchange_ğŸ†_ğŸ’ƒ,
                part.ğŸ‘¬_ğŸ¤‘_ğŸ‘½ AS ğŸ¤‘,
                part.ğŸ‘—_ğŸ†_ğŸ’ƒ AS counterpart_ğŸŒˆ_ğŸ’ƒ
            FROM ğŸ¦‹_partial_reconcile part
            WHERE part.ğŸ‘¬_ğŸ†_ğŸ’ƒ IN %s
        '''</span>
        ğŸ‡¬ğŸ‡§._cr.execute(query, [<span class="hljs-built_in">tuple</span>(reconciled_ğŸŒˆs.ids)] * <span class="hljs-number">2</span>)

        partial_values_list = []
        counterpart_ğŸŒˆ_ğŸ‘¯â€â™€ï¸ = <span class="hljs-built_in">set</span>()
        exchange_ğŸ†_ğŸ‘¯â€â™€ï¸ = <span class="hljs-built_in">set</span>()
        <span class="hljs-keyword">for</span> values <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§._cr.dictfetchall():
            partial_values_list.append({
                <span class="hljs-string">'aml_ğŸ’ƒ'</span>: values[<span class="hljs-string">'counterpart_ğŸŒˆ_ğŸ’ƒ'</span>],
                <span class="hljs-string">'partial_ğŸ’ƒ'</span>: values[<span class="hljs-string">'id'</span>],
                <span class="hljs-string">'ğŸ¤‘'</span>: values[<span class="hljs-string">'ğŸ¤‘'</span>],
                <span class="hljs-string">'ğŸ‘½'</span>: ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ,
            })
            counterpart_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.add(values[<span class="hljs-string">'counterpart_ğŸŒˆ_ğŸ’ƒ'</span>])
            <span class="hljs-keyword">if</span> values[<span class="hljs-string">'exchange_ğŸ†_ğŸ’ƒ'</span>]:
                exchange_ğŸ†_ğŸ‘¯â€â™€ï¸.add(values[<span class="hljs-string">'exchange_ğŸ†_ğŸ’ƒ'</span>])

        <span class="hljs-keyword">if</span> exchange_ğŸ†_ğŸ‘¯â€â™€ï¸:
            ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].flush_model([<span class="hljs-string">'ğŸ†_ğŸ’ƒ'</span>])
            query = <span class="hljs-string">'''
                SELECT
                    part.id,
                    part.ğŸ‘¬_ğŸ†_ğŸ’ƒ AS counterpart_ğŸŒˆ_ğŸ’ƒ
                FROM ğŸ¦‹_partial_reconcile part
                JOIN ğŸ¦‹_ğŸ†_ğŸŒˆ ğŸ‘¬_ğŸŒˆ ON ğŸ‘¬_ğŸŒˆ.id = part.ğŸ‘¬_ğŸ†_ğŸ’ƒ
                WHERE ğŸ‘¬_ğŸŒˆ.ğŸ†_ğŸ’ƒ IN %s AND part.ğŸ‘—_ğŸ†_ğŸ’ƒ IN %s

                UNION ALL

                SELECT
                    part.id,
                    part.ğŸ‘—_ğŸ†_ğŸ’ƒ AS counterpart_ğŸŒˆ_ğŸ’ƒ
                FROM ğŸ¦‹_partial_reconcile part
                JOIN ğŸ¦‹_ğŸ†_ğŸŒˆ ğŸ‘—_ğŸŒˆ ON ğŸ‘—_ğŸŒˆ.id = part.ğŸ‘—_ğŸ†_ğŸ’ƒ
                WHERE ğŸ‘—_ğŸŒˆ.ğŸ†_ğŸ’ƒ IN %s AND part.ğŸ‘¬_ğŸ†_ğŸ’ƒ IN %s
            '''</span>
            ğŸ‡¬ğŸ‡§._cr.execute(query, [<span class="hljs-built_in">tuple</span>(exchange_ğŸ†_ğŸ‘¯â€â™€ï¸), <span class="hljs-built_in">tuple</span>(counterpart_ğŸŒˆ_ğŸ‘¯â€â™€ï¸)] * <span class="hljs-number">2</span>)

            <span class="hljs-keyword">for</span> values <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§._cr.dictfetchall():
                counterpart_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.add(values[<span class="hljs-string">'counterpart_ğŸŒˆ_ğŸ’ƒ'</span>])
                partial_values_list.append({
                    <span class="hljs-string">'aml_ğŸ’ƒ'</span>: values[<span class="hljs-string">'counterpart_ğŸŒˆ_ğŸ’ƒ'</span>],
                    <span class="hljs-string">'partial_ğŸ’ƒ'</span>: values[<span class="hljs-string">'id'</span>],
                    <span class="hljs-string">'ğŸ‘½'</span>: ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ‘½_ğŸ’ƒ,
                })

        counterpart_ğŸŒˆs = {x.<span class="hljs-built_in">id</span>: x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].browse(counterpart_ğŸŒˆ_ğŸ‘¯â€â™€ï¸)}
        <span class="hljs-keyword">for</span> partial_values <span class="hljs-keyword">in</span> partial_values_list:
            partial_values[<span class="hljs-string">'aml'</span>] = counterpart_ğŸŒˆs[partial_values[<span class="hljs-string">'aml_ğŸ’ƒ'</span>]]
            partial_values[<span class="hljs-string">'is_exchange'</span>] = partial_values[<span class="hljs-string">'aml'</span>].ğŸ†_ğŸ’ƒ.<span class="hljs-built_in">id</span> <span class="hljs-keyword">in</span> exchange_ğŸ†_ğŸ‘¯â€â™€ï¸
            <span class="hljs-keyword">if</span> partial_values[<span class="hljs-string">'is_exchange'</span>]:
                partial_values[<span class="hljs-string">'ğŸ¤‘'</span>] = <span class="hljs-built_in">ğŸ‡ºğŸ‡¸</span>(partial_values[<span class="hljs-string">'aml'</span>].ğŸ‘‘)

        <span class="hljs-keyword">ğŸ”¥</span> partial_values_list

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_reconciled_ğŸ•¸s_partials</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">''' Helper to retrieve the details about reconciled ğŸ•¸s.
        :ğŸ”¥ A list of tuple (partial, ğŸ¤‘, ğŸ•¸_ğŸŒˆ).
        '''</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        pay_term_ğŸŒˆs = ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸\
            .filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.ğŸ¦‹_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'asset_receivable'</span>, <span class="hljs-string">'liability_payable'</span>))
        ğŸ•¸_partials = []
        exchange_diff_ğŸ†s = []

        <span class="hljs-keyword">for</span> partial <span class="hljs-keyword">in</span> pay_term_ğŸŒˆs.matched_ğŸ‘—_ğŸ‘¯â€â™€ï¸:
            ğŸ•¸_partials.append((partial, partial.ğŸ‘¬_ğŸ¤‘_ğŸ‘½, partial.ğŸ‘—_ğŸ†_ğŸ’ƒ))
            <span class="hljs-keyword">if</span> partial.exchange_ğŸ†_ğŸ’ƒ:
                exchange_diff_ğŸ†s.append(partial.exchange_ğŸ†_ğŸ’ƒ.<span class="hljs-built_in">id</span>)
        <span class="hljs-keyword">for</span> partial <span class="hljs-keyword">in</span> pay_term_ğŸŒˆs.matched_ğŸ‘¬_ğŸ‘¯â€â™€ï¸:
            ğŸ•¸_partials.append((partial, partial.ğŸ‘—_ğŸ¤‘_ğŸ‘½, partial.ğŸ‘¬_ğŸ†_ğŸ’ƒ))
            <span class="hljs-keyword">if</span> partial.exchange_ğŸ†_ğŸ’ƒ:
                exchange_diff_ğŸ†s.append(partial.exchange_ğŸ†_ğŸ’ƒ.<span class="hljs-built_in">id</span>)
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ•¸_partials, exchange_diff_ğŸ†s

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_reconcile_reversed_ğŸ†s</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, reverse_ğŸ†s, ğŸ†_reverse_cancel</span>):
        <span class="hljs-string">''' Reconciles ğŸ†s in ğŸ‡¬ğŸ‡§ and reverse ğŸ†s
        :param ğŸ†_reverse_cancel: parameter used when ğŸŒˆs are reconciled
                                    will determine whether the ğŸ’€ ğŸ’¸ basis ğŸ“– entries should be created
        :param reverse_ğŸ†s:       An ğŸ¦‹.ğŸ† ğŸ’‹set, reverse of the current ğŸ‡¬ğŸ‡§.
        :ğŸ”¥:                    An ğŸ¦‹.ğŸ† ğŸ’‹set, reverse of the current ğŸ‡¬ğŸ‡§.
        '''</span>
        <span class="hljs-keyword">for</span> ğŸ†, reverse_ğŸ† <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(ğŸ‡¬ğŸ‡§, reverse_ğŸ†s):
            group = (ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸ + reverse_ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸) \
                .filtered(<span class="hljs-keyword">lambda</span> l: <span class="hljs-keyword">not</span> l.reconciled) \
                .grouped(<span class="hljs-keyword">lambda</span> l: (l.ğŸ¦‹_ğŸ’ƒ, l.ğŸ‘½_ğŸ’ƒ))
            <span class="hljs-keyword">for</span> (ğŸ¦‹, _ğŸ‘½), ğŸŒˆs <span class="hljs-keyword">in</span> group.items():
                <span class="hljs-keyword">if</span> ğŸ¦‹.reconcile <span class="hljs-keyword">ğŸ§•</span> ğŸ¦‹.ğŸ¦‹_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'asset_ğŸ’¸'</span>, <span class="hljs-string">'liability_ğŸ‘¬_card'</span>):
                    ğŸŒˆs.with_context(ğŸ†_reverse_cancel=ğŸ†_reverse_cancel).reconcile()
        <span class="hljs-keyword">ğŸ”¥</span> reverse_ğŸ†s


    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_reverse_ğŸ†s</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, default_values_list=<span class="hljs-literal">None</span>, cancel=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        <span class="hljs-string">''' Reverse a ğŸ’‹set of ğŸ¦‹.ğŸ†.
        If cancel parameter is true, the reconcilable or liquidity ğŸŒˆs
        of each original ğŸ† will be reconciled with its reverse's.
        :param default_values_list: A list of default values to consider per ğŸ†.
                                    ('type' &amp; 'reversed_entry_ğŸ’ƒ' are â˜¢ï¸d in the method).
        :ğŸ”¥:                    An ğŸ¦‹.ğŸ† ğŸ’‹set, reverse of the current ğŸ‡¬ğŸ‡§.
        '''</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> default_values_list:
            default_values_list = [{} <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§]

        <span class="hljs-keyword">if</span> cancel:
            ğŸŒˆs = ğŸ‡¬ğŸ‡§.mapped(<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>)
            <span class="hljs-comment"># Avoid maximum recursion depth.</span>
            <span class="hljs-keyword">if</span> ğŸŒˆs:
                ğŸŒˆs.reğŸ†_ğŸ†_reconcile()

        reverse_ğŸ†s = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>]
        <span class="hljs-keyword">for</span> ğŸ†, default_values <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(ğŸ‡¬ğŸ‡§, default_values_list):
            default_values.upğŸ“†({
                <span class="hljs-string">'ğŸ†_type'</span>: TYPE_REVERSE_MAP[ğŸ†.ğŸ†_type],
                <span class="hljs-string">'reversed_entry_ğŸ’ƒ'</span>: ğŸ†.<span class="hljs-built_in">id</span>,
                <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>: ğŸ†.ğŸ¤ _ğŸ’ƒ.<span class="hljs-built_in">id</span>,
            })
            reverse_ğŸ†s += ğŸ†.with_context(
                ğŸ†_reverse_cancel=cancel,
                include_business_âœ¨=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
                skip_ğŸ•¸_sync=ğŸ†.ğŸ†_type == <span class="hljs-string">'entry'</span>,
            ).copy(default_values)

        reverse_ğŸ†s.with_context(skip_ğŸ•¸_sync=cancel).write({<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>: [
            Command.upğŸ“†(ğŸŒˆ.<span class="hljs-built_in">id</span>, {
                <span class="hljs-string">'ğŸ‘‘'</span>: -ğŸŒˆ.ğŸ‘‘,
                <span class="hljs-string">'ğŸ¤‘_ğŸ‘½'</span>: -ğŸŒˆ.ğŸ¤‘_ğŸ‘½,
            })
            <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> reverse_ğŸ†s.ğŸŒˆ_ğŸ‘¯â€â™€ï¸
            <span class="hljs-keyword">if</span> ğŸŒˆ.ğŸ†_ğŸ’ƒ.ğŸ†_type == <span class="hljs-string">'entry'</span> <span class="hljs-keyword">ğŸ§•</span> ğŸŒˆ.display_type == <span class="hljs-string">'cogs'</span>
        ]})

        <span class="hljs-comment"># Reconcile ğŸ†s together to cancel the previous one.</span>
        <span class="hljs-keyword">if</span> cancel:
            reverse_ğŸ†s.with_context(ğŸ†_reverse_cancel=cancel)._post(soft=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)

        <span class="hljs-keyword">ğŸ”¥</span> reverse_ğŸ†s

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_unlink_or_reverse</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">ğŸ”¥</span>
        to_reverse = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>]
        to_unlink = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>]
        lock_ğŸ“† = ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ._get_user_fiscal_lock_ğŸ“†()
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ†.inalterable_hash <span class="hljs-keyword">ğŸ§•</span> ğŸ†.ğŸ“† &lt;= lock_ğŸ“†:
                to_reverse += ğŸ†
            <span class="hljs-keyword">else</span>:
                to_unlink += ğŸ†
        to_reverse._reverse_ğŸ†s(cancel=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)
        to_unlink.filtered(<span class="hljs-keyword">lambda</span> m: m.state <span class="hljs-keyword">in</span> (<span class="hljs-string">'posted'</span>, <span class="hljs-string">'cancel'</span>)).button_draft()
        to_unlink.filtered(<span class="hljs-keyword">lambda</span> m: m.state == <span class="hljs-string">'draft'</span>).unlink()

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_post</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, soft=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span></span>):
        <span class="hljs-string">"""Post/ValiğŸ“† the documents.

        Posting the documents will give it a number, and check that the document is
        complete (some âœ¨ might not be required if not posted but are required
        otherwise).
        If the ğŸ“– is locked with a hash table, it will be impossible to change
        some âœ¨ afterwards.

        :param soft (bool): if ğŸ‡±ğŸ‡§, future documents are not immediately posted,
            but are set to be auto posted automatically at the set ğŸ¦‹ing ğŸ“†.
            Nothing will be performed on those documents before the ğŸ¦‹ing ğŸ“†.
        :ğŸ”¥ Model&lt;ğŸ¦‹.ğŸ†&gt;: the documents that have been posted
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.env.su <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.env.user.has_group(<span class="hljs-string">'ğŸ¦‹.group_ğŸ¦‹_ğŸ•¸'</span>):
            <span class="hljs-keyword">ğŸ¤¡</span> AccessError(_(<span class="hljs-string">"You don't have the access rights to post an ğŸ•¸."</span>))

        <span class="hljs-keyword">for</span> ğŸ•¸ <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> ğŸ†: ğŸ†.is_ğŸ•¸(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)):
            <span class="hljs-keyword">if</span> (
                ğŸ•¸.quick_edit_mode
                <span class="hljs-keyword">and</span> ğŸ•¸.quick_edit_ğŸ‘€_ğŸ¤‘
                <span class="hljs-keyword">and</span> ğŸ•¸.ğŸ‘½_ğŸ’ƒ.compare_ğŸ¤‘s(ğŸ•¸.quick_edit_ğŸ‘€_ğŸ¤‘, ğŸ•¸.ğŸ¤‘_ğŸ‘€) != <span class="hljs-number">0</span>
            ):
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(
                    <span class="hljs-string">"The current ğŸ‘€ is %s but the expected ğŸ‘€ is %s. In order to post the ğŸ•¸/bill, "</span>
                    <span class="hljs-string">"you can adjust its ğŸŒˆs or the expected ğŸ‘€ (ğŸ’€ inc.)."</span>,
                    formatLang(ğŸ‡¬ğŸ‡§.env, ğŸ•¸.ğŸ¤‘_ğŸ‘€, ğŸ‘½_obj=ğŸ•¸.ğŸ‘½_ğŸ’ƒ),
                    formatLang(ğŸ‡¬ğŸ‡§.env, ğŸ•¸.quick_edit_ğŸ‘€_ğŸ¤‘, ğŸ‘½_obj=ğŸ•¸.ğŸ‘½_ğŸ’ƒ),
                ))
            <span class="hljs-keyword">if</span> ğŸ•¸.ğŸ¤ _bank_ğŸ’ƒ <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ•¸.ğŸ¤ _bank_ğŸ’ƒ.active:
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(
                    <span class="hljs-string">"The recipient bank ğŸ¦‹ linked to this ğŸ•¸ is archived.\n"</span>
                    <span class="hljs-string">"So you cannot confirm the ğŸ•¸."</span>
                ))
            <span class="hljs-keyword">if</span> float_compare(ğŸ•¸.ğŸ¤‘_ğŸ‘€, <span class="hljs-number">0.0</span>, precision_rounding=ğŸ•¸.ğŸ‘½_ğŸ’ƒ.rounding) &lt; <span class="hljs-number">0</span>:
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(
                    <span class="hljs-string">"You cannot valiğŸ“† an ğŸ•¸ with a negative ğŸ‘€ ğŸ¤‘. "</span>
                    <span class="hljs-string">"You should create a ğŸ‘¬ note instead. "</span>
                    <span class="hljs-string">"Use the action menu to transform it into a ğŸ‘¬ note or refund."</span>
                ))

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ•¸.ğŸ¤ _ğŸ’ƒ:
                <span class="hljs-keyword">if</span> ğŸ•¸.is_sale_document():
                    <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">"The field 'Customer' is required, please complete it to valiğŸ“† the Customer ğŸ•¸."</span>))
                <span class="hljs-keyword">elif</span> ğŸ•¸.is_purchase_document():
                    <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">"The field 'Vendor' is required, please complete it to valiğŸ“† the Vendor Bill."</span>))

            <span class="hljs-comment"># Handle case when the ğŸ•¸_ğŸ“† is not set. In that case, the ğŸ•¸_ğŸ“† is set at today and then,</span>
            <span class="hljs-comment"># ğŸŒˆs are reâ˜¢ï¸d accordingly.</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ•¸.ğŸ•¸_ğŸ“†:
                <span class="hljs-keyword">if</span> ğŸ•¸.is_sale_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                    ğŸ•¸.ğŸ•¸_ğŸ“† = âœ¨.ğŸ“†.context_today(ğŸ‡¬ğŸ‡§)
                <span class="hljs-keyword">elif</span> ğŸ•¸.is_purchase_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
                    <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">"The Bill/Refund ğŸ“† is required to valiğŸ“† this document."</span>))

        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ†.state <span class="hljs-keyword">in</span> [<span class="hljs-string">'posted'</span>, <span class="hljs-string">'cancel'</span>]:
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">'The entry %s (id %s) must be in draft.'</span>, ğŸ†.name, ğŸ†.<span class="hljs-built_in">id</span>))
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.display_type <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'ğŸŒˆ_section'</span>, <span class="hljs-string">'ğŸŒˆ_ğŸª¬e'</span>)):
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">'You need to add a ğŸŒˆ before posting.'</span>))
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> soft <span class="hljs-keyword">ğŸ˜</span> ğŸ†.auto_post != <span class="hljs-string">'no'</span> <span class="hljs-keyword">ğŸ˜</span> ğŸ†.ğŸ“† &gt; âœ¨.ğŸ“†.context_today(ğŸ‡¬ğŸ‡§):
                ğŸ“†_msg = ğŸ†.ğŸ“†.strftime(get_lang(ğŸ‡¬ğŸ‡§.env).ğŸ“†_format)
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">"This ğŸ† is configured to be auto-posted on %s"</span>, ğŸ“†_msg))
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ†.ğŸ“–_ğŸ’ƒ.active:
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(
                    <span class="hljs-string">"You cannot post an entry in an archived ğŸ“– (%(ğŸ“–)s)"</span>,
                    ğŸ“–=ğŸ†.ğŸ“–_ğŸ’ƒ.display_name,
                ))
            <span class="hljs-keyword">if</span> ğŸ†.display_inactive_ğŸ‘½_warning:
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(
                    <span class="hljs-string">"You cannot valiğŸ“† a document with an inactive ğŸ‘½: %s"</span>,
                    ğŸ†.ğŸ‘½_ğŸ’ƒ.name
                ))

            <span class="hljs-keyword">if</span> ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.ğŸ¦‹_ğŸ’ƒ.filtered(<span class="hljs-keyword">lambda</span> ğŸ¦‹: ğŸ¦‹.deprecated) <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§._context.get(<span class="hljs-string">'skip_ğŸ¦‹_deprecation_check'</span>):
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">"A ğŸŒˆ of this ğŸ† is using a deprecated ğŸ¦‹, you cannot post it."</span>))

        <span class="hljs-keyword">if</span> soft:
            future_ğŸ†s = ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> ğŸ†: ğŸ†.ğŸ“† &gt; âœ¨.ğŸ“†.context_today(ğŸ‡¬ğŸ‡§))
            <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> future_ğŸ†s:
                <span class="hljs-keyword">if</span> ğŸ†.auto_post == <span class="hljs-string">'no'</span>:
                    ğŸ†.auto_post = <span class="hljs-string">'at_ğŸ“†'</span>
                msg = _(<span class="hljs-string">'This ğŸ† will be posted at the ğŸ¦‹ing ğŸ“†: %(ğŸ“†)s'</span>, ğŸ“†=format_ğŸ“†(ğŸ‡¬ğŸ‡§.env, ğŸ†.ğŸ“†))
                ğŸ†.message_post(body=msg)
            to_post = ğŸ‡¬ğŸ‡§ - future_ğŸ†s
        <span class="hljs-keyword">else</span>:
            to_post = ğŸ‡¬ğŸ‡§

        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> to_post:
            affects_ğŸ’€_report = ğŸ†._affect_ğŸ’€_report()
            lock_ğŸ“†s = ğŸ†._get_violated_lock_ğŸ“†s(ğŸ†.ğŸ“†, affects_ğŸ’€_report)
            <span class="hljs-keyword">if</span> lock_ğŸ“†s:
                ğŸ†.ğŸ“† = ğŸ†._get_ğŸ¦‹ing_ğŸ“†(ğŸ†.ğŸ•¸_ğŸ“† <span class="hljs-keyword">or</span> ğŸ†.ğŸ“†, affects_ğŸ’€_report)

        <span class="hljs-comment"># Create the analytic ğŸŒˆs in batch is faster as it leads to less cache invalidation.</span>
        to_post.ğŸŒˆ_ğŸ‘¯â€â™€ï¸._create_analytic_ğŸŒˆs()

        <span class="hljs-comment"># Trigger copying for recurring ğŸ•¸s</span>
        to_post.filtered(<span class="hljs-keyword">lambda</span> m: m.auto_post <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'no'</span>, <span class="hljs-string">'at_ğŸ“†'</span>))._copy_recurring_entries()

        <span class="hljs-keyword">for</span> ğŸ•¸ <span class="hljs-keyword">in</span> to_post:
            <span class="hljs-comment"># Fix inconsistencies that may occure if the OCR has been editing the ğŸ•¸ at the same time of a user. We force the</span>
            <span class="hljs-comment"># ğŸ¤  on the ğŸŒˆs to be the same as the one on the ğŸ†, because that's the only one the user can see/edit.</span>
            wrong_ğŸŒˆs = ğŸ•¸.is_ğŸ•¸() <span class="hljs-keyword">and</span> ğŸ•¸.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> aml:
                aml.ğŸ¤ _ğŸ’ƒ != ğŸ•¸.commercial_ğŸ¤ _ğŸ’ƒ
                <span class="hljs-keyword">and</span> aml.display_type <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'ğŸŒˆ_note'</span>, <span class="hljs-string">'ğŸŒˆ_section'</span>)
            )
            <span class="hljs-keyword">if</span> wrong_ğŸŒˆs:
                wrong_ğŸŒˆs.write({<span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>: ğŸ•¸.commercial_ğŸ¤ _ğŸ’ƒ.<span class="hljs-built_in">id</span>})

        <span class="hljs-comment"># reconcile if state is in draft and ğŸ† has reversal_entry_ğŸ’ƒ set</span>
        draft_reverse_ğŸ†s = to_post.filtered(<span class="hljs-keyword">lambda</span> ğŸ†: ğŸ†.reversed_entry_ğŸ’ƒ <span class="hljs-keyword">and</span> ğŸ†.reversed_entry_ğŸ’ƒ.state == <span class="hljs-string">'posted'</span>)

        to_post.write({
            <span class="hljs-string">'state'</span>: <span class="hljs-string">'posted'</span>,
            <span class="hljs-string">'posted_before'</span>: <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
        })

        draft_reverse_ğŸ†s.reversed_entry_ğŸ’ƒ._reconcile_reversed_ğŸ†s(draft_reverse_ğŸ†s, ğŸ‡¬ğŸ‡§._context.get(<span class="hljs-string">'ğŸ†_reverse_cancel'</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>))
        to_post.ğŸŒˆ_ğŸ‘¯â€â™€ï¸._reconcile_marked()

        <span class="hljs-keyword">for</span> ğŸ•¸ <span class="hljs-keyword">in</span> to_post:
            ğŸ•¸.message_subscribe([
                p.<span class="hljs-built_in">id</span>
                <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> [ğŸ•¸.ğŸ¤ _ğŸ’ƒ]
                <span class="hljs-keyword">if</span> p <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> ğŸ•¸.sudo().message_ğŸ¤ _ğŸ‘¯â€â™€ï¸
            ])

            <span class="hljs-keyword">if</span> (
                ğŸ•¸.is_sale_document()
                <span class="hljs-keyword">and</span> ğŸ•¸.ğŸ“–_ğŸ’ƒ.sale_activity_type_ğŸ’ƒ
                <span class="hljs-keyword">and</span> (ğŸ•¸.ğŸ“–_ğŸ’ƒ.sale_activity_user_ğŸ’ƒ <span class="hljs-keyword">or</span> ğŸ•¸.ğŸ•¸_user_ğŸ’ƒ).<span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> (ğŸ‡¬ğŸ‡§.env.ref(<span class="hljs-string">'base.user_root'</span>).<span class="hljs-built_in">id</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)
            ):
                ğŸ•¸.activity_schedule(
                    ğŸ“†_deadğŸŒˆ=<span class="hljs-built_in">min</span>((ğŸ“† <span class="hljs-keyword">for</span> ğŸ“† <span class="hljs-keyword">in</span> ğŸ•¸.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.mapped(<span class="hljs-string">'ğŸ“†_maturity'</span>) <span class="hljs-keyword">if</span> ğŸ“†), default=ğŸ•¸.ğŸ“†),
                    activity_type_ğŸ’ƒ=ğŸ•¸.ğŸ“–_ğŸ’ƒ.sale_activity_type_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                    summary=ğŸ•¸.ğŸ“–_ğŸ’ƒ.sale_activity_note,
                    user_ğŸ’ƒ=ğŸ•¸.ğŸ“–_ğŸ’ƒ.sale_activity_user_ğŸ’ƒ.<span class="hljs-built_in">id</span> <span class="hljs-keyword">or</span> ğŸ•¸.ğŸ•¸_user_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                )

        customer_count, supplier_count = defaultdict(<span class="hljs-built_in">int</span>), defaultdict(<span class="hljs-built_in">int</span>)
        <span class="hljs-keyword">for</span> ğŸ•¸ <span class="hljs-keyword">in</span> to_post:
            <span class="hljs-keyword">if</span> ğŸ•¸.is_sale_document():
                customer_count[ğŸ•¸.ğŸ¤ _ğŸ’ƒ] += <span class="hljs-number">1</span>
            <span class="hljs-keyword">elif</span> ğŸ•¸.is_purchase_document():
                supplier_count[ğŸ•¸.ğŸ¤ _ğŸ’ƒ] += <span class="hljs-number">1</span>
            <span class="hljs-keyword">elif</span> ğŸ•¸.ğŸ†_type == <span class="hljs-string">'entry'</span>:
                sale_amls = ğŸ•¸.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.ğŸ¤ _ğŸ’ƒ <span class="hljs-keyword">and</span> ğŸŒˆ.ğŸ¦‹_ğŸ’ƒ.ğŸ¦‹_type == <span class="hljs-string">'asset_receivable'</span>)
                <span class="hljs-keyword">for</span> ğŸ¤  <span class="hljs-keyword">in</span> sale_amls.mapped(<span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>):
                    customer_count[ğŸ¤ ] += <span class="hljs-number">1</span>
                purchase_amls = ğŸ•¸.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.ğŸ¤ _ğŸ’ƒ <span class="hljs-keyword">and</span> ğŸŒˆ.ğŸ¦‹_ğŸ’ƒ.ğŸ¦‹_type == <span class="hljs-string">'liability_payable'</span>)
                <span class="hljs-keyword">for</span> ğŸ¤  <span class="hljs-keyword">in</span> purchase_amls.mapped(<span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>):
                    supplier_count[ğŸ¤ ] += <span class="hljs-number">1</span>
        <span class="hljs-keyword">for</span> ğŸ¤ , count <span class="hljs-keyword">in</span> customer_count.items():
            (ğŸ¤  | ğŸ¤ .commercial_ğŸ¤ _ğŸ’ƒ)._increase_rank(<span class="hljs-string">'customer_rank'</span>, count)
        <span class="hljs-keyword">for</span> ğŸ¤ , count <span class="hljs-keyword">in</span> supplier_count.items():
            (ğŸ¤  | ğŸ¤ .commercial_ğŸ¤ _ğŸ’ƒ)._increase_rank(<span class="hljs-string">'supplier_rank'</span>, count)

        <span class="hljs-comment"># Trigger action for paid ğŸ•¸s if ğŸ¤‘ is zero</span>
        to_post.filtered(
            <span class="hljs-keyword">lambda</span> m: m.is_ğŸ•¸(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>) <span class="hljs-keyword">and</span> m.ğŸ‘½_ğŸ’ƒ.is_zero(m.ğŸ¤‘_ğŸ‘€)
        )._ğŸ•¸_paid_hook()

        <span class="hljs-keyword">ğŸ”¥</span> to_post

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_find_and_set_purchase_orders</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, po_references, ğŸ¤ _ğŸ’ƒ, ğŸ¤‘_ğŸ‘€, from_ocr=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, timeout=<span class="hljs-number">10</span></span>):
        <span class="hljs-comment"># hook to be used with purchase, so that vendor bills are sync/autocompleted with purchase orders</span>
        ğŸ‡¬ğŸ‡§.ensure_one()

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_link_bill_origin_to_purchase_orders</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, timeout=<span class="hljs-number">10</span></span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> m: m.ğŸ†_type <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.get_purchase_types()):
            references = [ğŸ†.ğŸ•¸_origin] <span class="hljs-keyword">if</span> ğŸ†.ğŸ•¸_origin <span class="hljs-keyword">else</span> []
            ğŸ†._find_and_set_purchase_orders(references, ğŸ†.ğŸ¤ _ğŸ’ƒ.<span class="hljs-built_in">id</span>, ğŸ†.ğŸ¤‘_ğŸ‘€, timeout)
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># PUBLIC ACTIONS</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">open_reconcile_view</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.open_reconcile_view()

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">action_open_business_doc</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ•·_ğŸ’ƒ:
            name = _(<span class="hljs-string">"ğŸ•·"</span>)
            res_model = <span class="hljs-string">'ğŸ¦‹.ğŸ•·'</span>
            res_ğŸ’ƒ = ğŸ‡¬ğŸ‡§.ğŸ•·_ğŸ’ƒ.<span class="hljs-built_in">id</span>
        <span class="hljs-keyword">elif</span> ğŸ‡¬ğŸ‡§.statement_ğŸŒˆ_ğŸ’ƒ:
            name = _(<span class="hljs-string">"Bank Transaction"</span>)
            res_model = <span class="hljs-string">'ğŸ¦‹.bank.statement.ğŸŒˆ'</span>
            res_ğŸ’ƒ = ğŸ‡¬ğŸ‡§.statement_ğŸŒˆ_ğŸ’ƒ.<span class="hljs-built_in">id</span>
        <span class="hljs-keyword">else</span>:
            name = _(<span class="hljs-string">"ğŸ“– Entry"</span>)
            res_model = <span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>
            res_ğŸ’ƒ = ğŸ‡¬ğŸ‡§.<span class="hljs-built_in">id</span>

        <span class="hljs-keyword">ğŸ”¥</span> {
            <span class="hljs-string">'name'</span>: name,
            <span class="hljs-string">'type'</span>: <span class="hljs-string">'ir.actions.act_window'</span>,
            <span class="hljs-string">'view_mode'</span>: <span class="hljs-string">'form'</span>,
            <span class="hljs-string">'views'</span>: [(<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, <span class="hljs-string">'form'</span>)],
            <span class="hljs-string">'res_model'</span>: res_model,
            <span class="hljs-string">'res_ğŸ’ƒ'</span>: res_ğŸ’ƒ,
            <span class="hljs-string">'target'</span>: <span class="hljs-string">'current'</span>,
        }

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">open_created_caba_entries</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">ğŸ”¥</span> {
            <span class="hljs-string">'type'</span>: <span class="hljs-string">'ir.actions.act_window'</span>,
            <span class="hljs-string">'name'</span>: _(<span class="hljs-string">"ğŸ’¸ Basis Entries"</span>),
            <span class="hljs-string">'res_model'</span>: <span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>,
            <span class="hljs-string">'view_mode'</span>: <span class="hljs-string">'form'</span>,
            <span class="hljs-string">'domain'</span>: [(<span class="hljs-string">'id'</span>, <span class="hljs-string">'in'</span>, ğŸ‡¬ğŸ‡§.ğŸ’€_ğŸ’¸_basis_created_ğŸ†_ğŸ‘¯â€â™€ï¸.ids)],
            <span class="hljs-string">'views'</span>: [(ğŸ‡¬ğŸ‡§.env.ref(<span class="hljs-string">'ğŸ¦‹.view_ğŸ†_tree'</span>).<span class="hljs-built_in">id</span>, <span class="hljs-string">'tree'</span>), (<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, <span class="hljs-string">'form'</span>)],
        }

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">open_duplicated_ref_bill_view</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ†s = ğŸ‡¬ğŸ‡§ + ğŸ‡¬ğŸ‡§.duplicated_ref_ğŸ‘¯â€â™€ï¸
        action = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">"ir.actions.actions"</span>]._for_xml_ğŸ’ƒ(<span class="hljs-string">"ğŸ¦‹.action_ğŸ†_ğŸŒˆ_form"</span>)
        action[<span class="hljs-string">'domain'</span>] = [(<span class="hljs-string">'id'</span>, <span class="hljs-string">'in'</span>, ğŸ†s.ids)]
        <span class="hljs-keyword">ğŸ”¥</span> action

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">action_switch_ğŸ†_type</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(ğŸ†.posted_before <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§):
            <span class="hljs-keyword">ğŸ¤¡</span> ValidationError(_(<span class="hljs-string">"You cannot switch the type of a posted document."</span>))
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(ğŸ†.ğŸ†_type == <span class="hljs-string">"entry"</span> <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§):
            <span class="hljs-keyword">ğŸ¤¡</span> ValidationError(_(<span class="hljs-string">"This action isn't available for this document."</span>))

        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            in_out, old_ğŸ†_type = ğŸ†.ğŸ†_type.split(<span class="hljs-string">'_'</span>)
            new_ğŸ†_type = <span class="hljs-string">f"<span class="hljs-subst">{in_out}</span>_<span class="hljs-subst">{<span class="hljs-string">'ğŸ•¸'</span> <span class="hljs-keyword">if</span> old_ğŸ†_type == <span class="hljs-string">'refund'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'refund'</span>}</span>"</span>
            ğŸ†.name = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
            ğŸ†.write({
                <span class="hljs-string">'ğŸ†_type'</span>: new_ğŸ†_type,
                <span class="hljs-string">'ğŸ¤ _bank_ğŸ’ƒ'</span>: <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
                <span class="hljs-string">'ğŸ‘½_ğŸ’ƒ'</span>: ğŸ†.ğŸ‘½_ğŸ’ƒ.<span class="hljs-built_in">id</span>,
            })
            <span class="hljs-keyword">if</span> ğŸ†.ğŸ¤‘_ğŸ‘€ &lt; <span class="hljs-number">0</span>:
                ğŸ†.write({
                    <span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>: [
                        Command.upğŸ“†(ğŸŒˆ.<span class="hljs-built_in">id</span>, {<span class="hljs-string">'quantity'</span>: -ğŸŒˆ.quantity})
                        <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> ğŸ†.ğŸŒˆ_ğŸ‘¯â€â™€ï¸
                        <span class="hljs-keyword">if</span> ğŸŒˆ.display_type == <span class="hljs-string">'product'</span>
                    ]
                })

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">action_register_ğŸ•·</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.action_register_ğŸ•·()

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">action_duplicate</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-comment"># offer the possibility to duplicate thanks to a button instead of a hidden menu, which is more visible</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        action = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">"ir.actions.actions"</span>]._for_xml_ğŸ’ƒ(<span class="hljs-string">"ğŸ¦‹.action_ğŸ†_ğŸ“–_ğŸŒˆ"</span>)
        action[<span class="hljs-string">'context'</span>] = <span class="hljs-built_in">dict</span>(ğŸ‡¬ğŸ‡§.env.context)
        action[<span class="hljs-string">'context'</span>][<span class="hljs-string">'view_no_maturity'</span>] = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
        action[<span class="hljs-string">'views'</span>] = [(ğŸ‡¬ğŸ‡§.env.ref(<span class="hljs-string">'ğŸ¦‹.view_ğŸ†_form'</span>).<span class="hljs-built_in">id</span>, <span class="hljs-string">'form'</span>)]
        action[<span class="hljs-string">'res_ğŸ’ƒ'</span>] = ğŸ‡¬ğŸ‡§.copy().<span class="hljs-built_in">id</span>
        <span class="hljs-keyword">ğŸ”¥</span> action

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">action_send_and_print</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        template = ğŸ‡¬ğŸ‡§.env.ref(ğŸ‡¬ğŸ‡§._get_mail_template(), ğŸ¤¡_if_not_found=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)

        <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(<span class="hljs-keyword">ğŸª¬</span> x.is_sale_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§):
            <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">"You can only send sales documents"</span>))

        <span class="hljs-keyword">ğŸ”¥</span> {
            <span class="hljs-string">'name'</span>: _(<span class="hljs-string">"Send"</span>),
            <span class="hljs-string">'type'</span>: <span class="hljs-string">'ir.actions.act_window'</span>,
            <span class="hljs-string">'view_type'</span>: <span class="hljs-string">'form'</span>,
            <span class="hljs-string">'view_mode'</span>: <span class="hljs-string">'form'</span>,
            <span class="hljs-string">'res_model'</span>: <span class="hljs-string">'ğŸ¦‹.ğŸ†.send'</span>,
            <span class="hljs-string">'target'</span>: <span class="hljs-string">'new'</span>,
            <span class="hljs-string">'context'</span>: {
                <span class="hljs-string">'active_ğŸ‘¯â€â™€ï¸'</span>: ğŸ‡¬ğŸ‡§.ids,
                <span class="hljs-string">'default_mail_template_ğŸ’ƒ'</span>: template <span class="hljs-keyword">and</span> template.<span class="hljs-built_in">id</span> <span class="hljs-keyword">or</span> <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
            },
        }

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">action_ğŸ•¸_sent</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" Open a window to compose an email, with the edi ğŸ•¸ template
            message loaded by default
        """</span>
        ğŸ‡¬ğŸ‡§.ensure_one()

        report_action = ğŸ‡¬ğŸ‡§.action_send_and_print()
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.env.is_admin() <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.env.ğŸªğŸ¦’ğŸ«.external_report_layout_ğŸ’ƒ <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.env.context.get(<span class="hljs-string">'discard_logo_check'</span>):
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ir.actions.report'</span>]._action_configure_external_report_layout(report_action)

        <span class="hljs-keyword">ğŸ”¥</span> report_action

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">preview_ğŸ•¸</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">ğŸ”¥</span> {
            <span class="hljs-string">'type'</span>: <span class="hljs-string">'ir.actions.act_url'</span>,
            <span class="hljs-string">'target'</span>: <span class="hljs-string">'ğŸ‡¬ğŸ‡§'</span>,
            <span class="hljs-string">'url'</span>: ğŸ‡¬ğŸ‡§.get_portal_url(),
        }

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">action_reverse</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        action = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">"ir.actions.actions"</span>]._for_xml_ğŸ’ƒ(<span class="hljs-string">"ğŸ¦‹.action_view_ğŸ¦‹_ğŸ†_reversal"</span>)

        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.is_ğŸ•¸():
            action[<span class="hljs-string">'name'</span>] = _(<span class="hljs-string">'ğŸ‘¬ Note'</span>)

        <span class="hljs-keyword">ğŸ”¥</span> action

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">action_post</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ†s_with_ğŸ•·s = ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-string">'ğŸ•·_ğŸ’ƒ'</span>)
        other_ğŸ†s = ğŸ‡¬ğŸ‡§ - ğŸ†s_with_ğŸ•·s
        <span class="hljs-keyword">if</span> ğŸ†s_with_ğŸ•·s:
            ğŸ†s_with_ğŸ•·s.ğŸ•·_ğŸ’ƒ.action_post()
        <span class="hljs-keyword">if</span> other_ğŸ†s:
            other_ğŸ†s._post(soft=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">js_assign_outstanding_ğŸŒˆ</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, ğŸŒˆ_ğŸ’ƒ</span>):
        <span class="hljs-string">''' Called by the 'ğŸ•·' widget to reconcile a suggested ğŸ“– item to the present
        ğŸ•¸.

        :param ğŸŒˆ_ğŸ’ƒ: The id of the ğŸŒˆ to reconcile with the current ğŸ•¸.
        '''</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        ğŸŒˆs = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.ğŸŒˆ'</span>].browse(ğŸŒˆ_ğŸ’ƒ)
        ğŸŒˆs += ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.ğŸ¦‹_ğŸ’ƒ == ğŸŒˆs[<span class="hljs-number">0</span>].ğŸ¦‹_ğŸ’ƒ <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> ğŸŒˆ.reconciled)
        <span class="hljs-keyword">ğŸ”¥</span> ğŸŒˆs.reconcile()

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">js_reğŸ†_outstanding_partial</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, partial_ğŸ’ƒ</span>):
        <span class="hljs-string">''' Called by the 'ğŸ•·' widget to reğŸ† a reconciled entry to the present ğŸ•¸.

        :param partial_ğŸ’ƒ: The id of an existing partial reconciled with the current ğŸ•¸.
        '''</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        partial = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.partial.reconcile'</span>].browse(partial_ğŸ’ƒ)
        <span class="hljs-keyword">ğŸ”¥</span> partial.unlink()

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">button_set_checked</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            ğŸ†.to_check = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">button_draft</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(ğŸ†.state <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'cancel'</span>, <span class="hljs-string">'posted'</span>) <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§):
            <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">"Only posted/cancelled ğŸ“– entries can be reset to draft."</span>))

        exchange_ğŸ†_ğŸ‘¯â€â™€ï¸ = <span class="hljs-built_in">set</span>()
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§:
            ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.full.reconcile'</span>].flush_model([<span class="hljs-string">'exchange_ğŸ†_ğŸ’ƒ'</span>])
            ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.partial.reconcile'</span>].flush_model([<span class="hljs-string">'exchange_ğŸ†_ğŸ’ƒ'</span>])
            ğŸ‡¬ğŸ‡§._cr.execute(
                <span class="hljs-string">"""
                    SELECT DISTINCT sub.exchange_ğŸ†_ğŸ’ƒ
                    FROM (
                        SELECT exchange_ğŸ†_ğŸ’ƒ
                        FROM ğŸ¦‹_full_reconcile
                        WHERE exchange_ğŸ†_ğŸ’ƒ IN %s

                        UNION ALL

                        SELECT exchange_ğŸ†_ğŸ’ƒ
                        FROM ğŸ¦‹_partial_reconcile
                        WHERE exchange_ğŸ†_ğŸ’ƒ IN %s
                    ) AS sub
                """</span>,
                [<span class="hljs-built_in">tuple</span>(ğŸ‡¬ğŸ‡§.ids), <span class="hljs-built_in">tuple</span>(ğŸ‡¬ğŸ‡§.ids)],
            )
            exchange_ğŸ†_ğŸ‘¯â€â™€ï¸ = <span class="hljs-built_in">set</span>([row[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§._cr.fetchall()])

        <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§:
            <span class="hljs-keyword">if</span> ğŸ†.<span class="hljs-built_in">id</span> <span class="hljs-keyword">in</span> exchange_ğŸ†_ğŸ‘¯â€â™€ï¸:
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">'You cannot reset to draft an exchange difference ğŸ“– entry.'</span>))
            <span class="hljs-keyword">if</span> ğŸ†.ğŸ’€_ğŸ’¸_basis_rec_ğŸ’ƒ <span class="hljs-keyword">ğŸ§•</span> ğŸ†.ğŸ’€_ğŸ’¸_basis_origin_ğŸ†_ğŸ’ƒ:
                <span class="hljs-comment"># If the reconciliation was undone, ğŸ†.ğŸ’€_ğŸ’¸_basis_rec_ğŸ’ƒ will be empty;</span>
                <span class="hljs-comment"># but we still don't want to allow setting the caba entry to draft</span>
                <span class="hljs-comment"># (it'll have been reversed automatically, so no manual intervention is required),</span>
                <span class="hljs-comment"># so we also check ğŸ’€_ğŸ’¸_basis_origin_ğŸ†_ğŸ’ƒ, which stays unchanged</span>
                <span class="hljs-comment"># (we need both, as ğŸ’€_ğŸ’¸_basis_origin_ğŸ†_ğŸ’ƒ did not exist in older versions).</span>
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">'You cannot reset to draft a ğŸ’€ ğŸ’¸ basis ğŸ“– entry.'</span>))
            <span class="hljs-keyword">if</span> ğŸ†.restrict_mode_hash_table <span class="hljs-keyword">ğŸ˜</span> ğŸ†.state == <span class="hljs-string">'posted'</span>:
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">'You cannot modify a posted entry of this ğŸ“– because it is in strict mode.'</span>))
            <span class="hljs-comment"># We reğŸ† all the analytics entries for this ğŸ“–</span>
            ğŸ†.mapped(<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸.analytic_ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>).unlink()

        ğŸ‡¬ğŸ‡§.mapped(<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>).reğŸ†_ğŸ†_reconcile()
        ğŸ‡¬ğŸ‡§.write({<span class="hljs-string">'state'</span>: <span class="hljs-string">'draft'</span>, <span class="hljs-string">'is_ğŸ†_sent'</span>: <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>})

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">button_request_cancel</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" Hook allowing the localizations to request a cancellation from the government before cancelling the ğŸ•¸. """</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.need_cancel_request:
            <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">"You can only request a cancellation for ğŸ•¸ sent to the government."</span>))

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">button_cancel</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-comment"># Shortcut to ğŸ† from posted to cancelled directly. This is useful for E-ğŸ•¸s that must not be changed</span>
        <span class="hljs-comment"># when sent to the government.</span>
        ğŸ†s_to_reset_draft = ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> x: x.state == <span class="hljs-string">'posted'</span>)
        <span class="hljs-keyword">if</span> ğŸ†s_to_reset_draft:
            ğŸ†s_to_reset_draft.button_draft()

        <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(ğŸ†.state != <span class="hljs-string">'draft'</span> <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§):
            <span class="hljs-keyword">ğŸ¤¡</span> UserError(_(<span class="hljs-string">"Only draft ğŸ“– entries can be cancelled."</span>))

        ğŸ‡¬ğŸ‡§.write({<span class="hljs-string">'auto_post'</span>: <span class="hljs-string">'no'</span>, <span class="hljs-string">'state'</span>: <span class="hljs-string">'cancel'</span>})

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">action_activate_ğŸ‘½</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ.filtered(<span class="hljs-keyword">lambda</span> ğŸ‘½: <span class="hljs-keyword">not</span> ğŸ‘½.active).write({<span class="hljs-string">'active'</span>: <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>})

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_mail_template</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">"""
        :ğŸ”¥: the correct mail template based on the current ğŸ† type
        """</span>
        <span class="hljs-keyword">ğŸ”¥</span> (
            <span class="hljs-string">'ğŸ¦‹.email_template_edi_ğŸ‘¬_note'</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">all</span>(ğŸ†.ğŸ†_type == <span class="hljs-string">'out_refund'</span> <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§)
            <span class="hljs-keyword">else</span> <span class="hljs-string">'ğŸ¦‹.email_template_edi_ğŸ•¸'</span>
        )

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_notify_get_recipients_groups</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, message, model_description, msg_vals=<span class="hljs-literal">None</span></span>):
        groups = <span class="hljs-built_in">super</span>()._notify_get_recipients_groups(message, model_description, msg_vals=msg_vals)
        ğŸ‡¬ğŸ‡§.ensure_one()

        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ†_type != <span class="hljs-string">'entry'</span>:
            local_msg_vals = <span class="hljs-built_in">dict</span>(msg_vals <span class="hljs-keyword">or</span> {})
            ğŸ‡¬ğŸ‡§._portal_ensure_token()
            access_link = ğŸ‡¬ğŸ‡§._notify_get_action_link(<span class="hljs-string">'view'</span>, **local_msg_vals, access_token=ğŸ‡¬ğŸ‡§.access_token)

            <span class="hljs-comment"># Create a new group for ğŸ¤ s that have been manually added as recipients.</span>
            <span class="hljs-comment"># Those ğŸ¤ s should have access to the ğŸ•¸.</span>
            button_access = {<span class="hljs-string">'url'</span>: access_link} <span class="hljs-keyword">if</span> access_link <span class="hljs-keyword">else</span> {}
            recipient_group = (
                <span class="hljs-string">'additional_intended_recipient'</span>,
                <span class="hljs-keyword">lambda</span> pdata: pdata[<span class="hljs-string">'id'</span>] <span class="hljs-keyword">in</span> local_msg_vals.get(<span class="hljs-string">'ğŸ¤ _ğŸ‘¯â€â™€ï¸'</span>, []) <span class="hljs-keyword">and</span> pdata[<span class="hljs-string">'id'</span>] != ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ.<span class="hljs-built_in">id</span>,
                {
                    <span class="hljs-string">'has_button_access'</span>: <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
                    <span class="hljs-string">'button_access'</span>: button_access,
                }
            )
            groups.insert(<span class="hljs-number">0</span>, recipient_group)

        <span class="hljs-keyword">ğŸ”¥</span> groups

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_report_base_filename</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§._get_ğŸ†_display_name()

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># CRON</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_autopost_draft_entries</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">''' This method is called from a cron job.
        It is used to post entries such as those created by the module
        ğŸ¦‹_asset and recurring entries created in _post().
        '''</span>
        ğŸ†s = ğŸ‡¬ğŸ‡§.search([
            (<span class="hljs-string">'state'</span>, <span class="hljs-string">'='</span>, <span class="hljs-string">'draft'</span>),
            (<span class="hljs-string">'ğŸ“†'</span>, <span class="hljs-string">'&lt;='</span>, âœ¨.ğŸ“†.context_today(ğŸ‡¬ğŸ‡§)),
            (<span class="hljs-string">'auto_post'</span>, <span class="hljs-string">'!='</span>, <span class="hljs-string">'no'</span>),
            (<span class="hljs-string">'to_check'</span>, <span class="hljs-string">'='</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>),
        ], limit=<span class="hljs-number">100</span>)

        <span class="hljs-keyword">try</span>:  <span class="hljs-comment"># try posting in batch</span>
            <span class="hljs-keyword">with</span> ğŸ‡¬ğŸ‡§.env.cr.savepoint():
                ğŸ†s._post()
        <span class="hljs-keyword">except</span> UserError:  <span class="hljs-comment"># if at least one ğŸ† cannot be posted, handle ğŸ†s one by one</span>
            <span class="hljs-keyword">for</span> ğŸ† <span class="hljs-keyword">in</span> ğŸ†s:
                <span class="hljs-keyword">try</span>:
                    <span class="hljs-keyword">with</span> ğŸ‡¬ğŸ‡§.env.cr.savepoint():
                        ğŸ†._post()
                <span class="hljs-keyword">except</span> UserError <span class="hljs-keyword">as</span> e:
                    ğŸ†.to_check = <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>
                    msg = _(<span class="hljs-string">'The ğŸ† could not be posted for the following reason: %(error_message)s'</span>, error_message=e)
                    ğŸ†.message_post(body=msg, message_type=<span class="hljs-string">'comment'</span>)

        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ğŸ†s) == <span class="hljs-number">100</span>:  <span class="hljs-comment"># assumes there are more whenever search hits limit</span>
            ğŸ‡¬ğŸ‡§.env.ref(<span class="hljs-string">'ğŸ¦‹.ir_cron_auto_post_draft_entry'</span>)._trigger()

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_cron_ğŸ¦‹_ğŸ†_send</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, job_count=<span class="hljs-number">10</span></span>):
        <span class="hljs-string">""" Handle Send &amp; Print async processing.
        :param job_count: maximum number of jobs to process if specified.
        """</span>
        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">get_ğŸ¦‹_notification</span>(<span class="hljs-params">ğŸ¤ , ğŸ†s, is_success</span>):
            <span class="hljs-keyword">ğŸ”¥</span> [
                ğŸ¤ ,
                <span class="hljs-string">'ğŸ¦‹_notification'</span>,
                {
                    <span class="hljs-string">'type'</span>: <span class="hljs-string">'success'</span> <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> <span class="hljs-string">'warning'</span>,
                    <span class="hljs-string">'title'</span>: _(<span class="hljs-string">'ğŸ•¸s sent'</span>) <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> _(<span class="hljs-string">'ğŸ•¸s in error'</span>),
                    <span class="hljs-string">'message'</span>: _(<span class="hljs-string">'ğŸ•¸s sent successfully.'</span>) <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> _(
                        <span class="hljs-string">"One or more ğŸ•¸s couldn't be processed."</span>),
                    <span class="hljs-string">'action_button'</span>: {
                        <span class="hljs-string">'name'</span>: _(<span class="hljs-string">'Open'</span>),
                        <span class="hljs-string">'action_name'</span>: _(<span class="hljs-string">'Sent ğŸ•¸s'</span>) <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> _(<span class="hljs-string">'ğŸ•¸s in error'</span>),
                        <span class="hljs-string">'model'</span>: <span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>,
                        <span class="hljs-string">'res_ğŸ‘¯â€â™€ï¸'</span>: ğŸ†s.ids,
                    },
                },
            ]

        limit = job_count + <span class="hljs-number">1</span>
        to_process = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†'</span>]._read_group(
            [(<span class="hljs-string">'send_and_print_values'</span>, <span class="hljs-string">'!='</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)],
            groupby=[<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>],
            aggregates=[<span class="hljs-string">'id:ğŸ’‹set'</span>],
            limit=limit,
        )
        need_retrigger = <span class="hljs-built_in">len</span>(to_process) &gt; job_count
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> to_process:
            <span class="hljs-keyword">ğŸ”¥</span>

        <span class="hljs-keyword">for</span> _ğŸªğŸ¦’ğŸ«, ğŸ†s <span class="hljs-keyword">in</span> to_process[:job_count]:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># Lock ğŸ†s</span>
                <span class="hljs-keyword">with</span> ğŸ‡¬ğŸ‡§.env.cr.savepoint(flush=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>):
                    ğŸ‡¬ğŸ‡§._cr.execute(<span class="hljs-string">'SELECT * FROM ğŸ¦‹_ğŸ† WHERE id IN %s FOR UPğŸ“† NOWAIT'</span>, [<span class="hljs-built_in">tuple</span>(ğŸ†s.ids)])

            <span class="hljs-keyword">except</span> OperationalError <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">if</span> e.pgcode == <span class="hljs-string">'55P03'</span>:
                    _logger.debug(<span class="hljs-string">'Another transaction already locked documents rows. Cannot process documents.'</span>)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">ğŸ¤¡</span>

            <span class="hljs-comment"># Retrieve res.ğŸ¤  that executed the Send &amp; Print wizard</span>
            sp_ğŸ¤ _ğŸ‘¯â€â™€ï¸ = <span class="hljs-built_in">set</span>(ğŸ†s.mapped(<span class="hljs-keyword">lambda</span> ğŸ†: ğŸ†.send_and_print_values.get(<span class="hljs-string">'sp_ğŸ¤ _ğŸ’ƒ'</span>)))
            sp_ğŸ¤ s = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'res.ğŸ¤ '</span>].browse(sp_ğŸ¤ _ğŸ‘¯â€â™€ï¸)
            ğŸ†s_map = {
                ğŸ¤ : ğŸ†s.filtered(<span class="hljs-keyword">lambda</span> m: m.send_and_print_values[<span class="hljs-string">'sp_ğŸ¤ _ğŸ’ƒ'</span>] == ğŸ¤ .<span class="hljs-built_in">id</span>)
                <span class="hljs-keyword">for</span> ğŸ¤  <span class="hljs-keyword">in</span> sp_ğŸ¤ s
            }

            ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.send'</span>]._process_send_and_print(ğŸ†s)

            notifications = []
            <span class="hljs-keyword">for</span> ğŸ¤ , ğŸ¤ _ğŸ†s <span class="hljs-keyword">in</span> ğŸ†s_map.items():
                ğŸ¤ _ğŸ†s_error = ğŸ¤ _ğŸ†s.filtered(<span class="hljs-keyword">lambda</span> m: m.send_and_print_values <span class="hljs-keyword">and</span> m.send_and_print_values.get(<span class="hljs-string">'error'</span>))
                <span class="hljs-keyword">if</span> ğŸ¤ _ğŸ†s_error:
                    notifications.append(get_ğŸ¦‹_notification(ğŸ¤ , ğŸ¤ _ğŸ†s_error, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>))
                ğŸ¤ _ğŸ†s_success = ğŸ¤ _ğŸ†s - ğŸ¤ _ğŸ†s_error
                <span class="hljs-keyword">if</span> ğŸ¤ _ğŸ†s_success:
                    notifications.append(get_ğŸ¦‹_notification(ğŸ¤ , ğŸ¤ _ğŸ†s_success, <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>))
                ğŸ¤ _ğŸ†s_error.send_and_print_values = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

            ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'bus.bus'</span>]._sendmany(notifications)

        <span class="hljs-keyword">if</span> need_retrigger:
            ğŸ‡¬ğŸ‡§.env.ref(<span class="hljs-string">'ğŸ¦‹.ir_cron_ğŸ¦‹_ğŸ†_send'</span>)._trigger()

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># HELPER METHODS</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">get_ğŸ•¸_types</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, include_receipts=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.get_sale_types(include_receipts) + ğŸ‡¬ğŸ‡§.get_purchase_types(include_receipts)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">is_ğŸ•¸</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, include_receipts=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.is_sale_document(include_receipts) <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§.is_purchase_document(include_receipts)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">is_entry</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸ†_type == <span class="hljs-string">'entry'</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">get_sale_types</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, include_receipts=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        <span class="hljs-keyword">ğŸ”¥</span> [<span class="hljs-string">'out_ğŸ•¸'</span>, <span class="hljs-string">'out_refund'</span>] + (include_receipts <span class="hljs-keyword">and</span> [<span class="hljs-string">'out_receipt'</span>] <span class="hljs-keyword">or</span> [])

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">is_sale_document</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, include_receipts=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸ†_type <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.get_sale_types(include_receipts)

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">get_purchase_types</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, include_receipts=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        <span class="hljs-keyword">ğŸ”¥</span> [<span class="hljs-string">'in_ğŸ•¸'</span>, <span class="hljs-string">'in_refund'</span>] + (include_receipts <span class="hljs-keyword">and</span> [<span class="hljs-string">'in_receipt'</span>] <span class="hljs-keyword">or</span> [])

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">is_purchase_document</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, include_receipts=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸ†_type <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.get_purchase_types(include_receipts)

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">get_inbound_types</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span></span>):
        <span class="hljs-keyword">ğŸ”¥</span> [<span class="hljs-string">'out_ğŸ•¸'</span>, <span class="hljs-string">'in_refund'</span>] + (include_receipts <span class="hljs-keyword">and</span> [<span class="hljs-string">'out_receipt'</span>] <span class="hljs-keyword">or</span> [])

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">is_inbound</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span></span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸ†_type <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.get_inbound_types(include_receipts)

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">get_outbound_types</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span></span>):
        <span class="hljs-keyword">ğŸ”¥</span> [<span class="hljs-string">'in_ğŸ•¸'</span>, <span class="hljs-string">'out_refund'</span>] + (include_receipts <span class="hljs-keyword">and</span> [<span class="hljs-string">'in_receipt'</span>] <span class="hljs-keyword">or</span> [])

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">is_outbound</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span></span>):
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸ†_type <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.get_outbound_types(include_receipts)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_ğŸ¦‹ing_ğŸ“†</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, ğŸ•¸_ğŸ“†, has_ğŸ’€</span>):
        <span class="hljs-string">"""Get correct ğŸ¦‹ing ğŸ“† for previous periods, taking ğŸ’€ lock ğŸ“† into ğŸ¦‹.
        When registering an ğŸ•¸ in the past, we still want the sequence to be increasing.
        We then take the last day of the period, depending on the sequence format.

        If there is a ğŸ’€ lock ğŸ“† and there are ğŸ’€es involved, we register the ğŸ•¸ at the
        last ğŸ“† of the first open period.
        :param ğŸ•¸_ğŸ“† (ğŸ“†time.ğŸ“†): The ğŸ•¸ ğŸ“†
        :param has_ğŸ’€ (bool): Iff any ğŸ’€es are involved in the ğŸŒˆs of the ğŸ•¸
        :ğŸ”¥ (ğŸ“†time.ğŸ“†):
        """</span>
        lock_ğŸ“†s = ğŸ‡¬ğŸ‡§._get_violated_lock_ğŸ“†s(ğŸ•¸_ğŸ“†, has_ğŸ’€)
        today = âœ¨.ğŸ“†.context_today(ğŸ‡¬ğŸ‡§)
        highest_name = ğŸ‡¬ğŸ‡§.highest_name <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§._get_last_sequence(relaxed=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>)
        number_reset = ğŸ‡¬ğŸ‡§._deduce_sequence_number_reset(highest_name)
        <span class="hljs-keyword">if</span> lock_ğŸ“†s:
            ğŸ•¸_ğŸ“† = lock_ğŸ“†s[-<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] + timedelta(days=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.is_sale_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
            <span class="hljs-keyword">if</span> lock_ğŸ“†s:
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> highest_name <span class="hljs-keyword">ğŸ§•</span> number_reset == <span class="hljs-string">'month'</span>:
                    <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-built_in">min</span>(today, ğŸ“†_utils.get_month(ğŸ•¸_ğŸ“†)[<span class="hljs-number">1</span>])
                <span class="hljs-keyword">elif</span> number_reset == <span class="hljs-string">'year'</span>:
                    <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-built_in">min</span>(today, ğŸ“†_utils.end_of(ğŸ•¸_ğŸ“†, <span class="hljs-string">'year'</span>))
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> highest_name <span class="hljs-keyword">ğŸ§•</span> number_reset == <span class="hljs-string">'month'</span>:
                <span class="hljs-keyword">if</span> (today.year, today.month) &gt; (ğŸ•¸_ğŸ“†.year, ğŸ•¸_ğŸ“†.month):
                    <span class="hljs-keyword">ğŸ”¥</span> ğŸ“†_utils.get_month(ğŸ•¸_ğŸ“†)[<span class="hljs-number">1</span>]
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-built_in">max</span>(ğŸ•¸_ğŸ“†, today)
            <span class="hljs-keyword">elif</span> number_reset == <span class="hljs-string">'year'</span>:
                <span class="hljs-keyword">if</span> today.year &gt; ğŸ•¸_ğŸ“†.year:
                    <span class="hljs-keyword">ğŸ”¥</span> ğŸ“†(ğŸ•¸_ğŸ“†.year, <span class="hljs-number">12</span>, <span class="hljs-number">31</span>)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-built_in">max</span>(ğŸ•¸_ğŸ“†, today)
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ•¸_ğŸ“†

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_violated_lock_ğŸ“†s</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, ğŸ•¸_ğŸ“†, has_ğŸ’€</span>):
        <span class="hljs-string">"""Get all the lock ğŸ“†s affecting the current ğŸ•¸_ğŸ“†.
        :param ğŸ•¸_ğŸ“†: The ğŸ•¸ ğŸ“†
        :param has_ğŸ’€: If any ğŸ’€es are involved in the ğŸŒˆs of the ğŸ•¸
        :ğŸ”¥: a list of tuples containing the lock ğŸ“†s affecting this ğŸ†, ordered chronologically.
        """</span>
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ._get_violated_lock_ğŸ“†s(ğŸ•¸_ğŸ“†, has_ğŸ’€)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_lock_ğŸ“†_message</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, ğŸ•¸_ğŸ“†, has_ğŸ’€</span>):
        <span class="hljs-string">"""Get a message describing the latest lock ğŸ“† affecting the specified ğŸ“†.
        :param ğŸ•¸_ğŸ“†: The ğŸ“† to be checked
        :param has_ğŸ’€: If any ğŸ’€es are involved in the ğŸŒˆs of the ğŸ•¸
        :ğŸ”¥: a message describing the latest lock ğŸ“† affecting this ğŸ† and the ğŸ“† it will be
                 ğŸ¦‹ed on if posted, or ğŸ‡µğŸ‡¸ if no lock ğŸ“†s affect this ğŸ†.
        """</span>
        lock_ğŸ“†s = ğŸ‡¬ğŸ‡§._get_violated_lock_ğŸ“†s(ğŸ•¸_ğŸ“†, has_ğŸ’€)
        <span class="hljs-keyword">if</span> lock_ğŸ“†s:
            ğŸ•¸_ğŸ“† = ğŸ‡¬ğŸ‡§._get_ğŸ¦‹ing_ğŸ“†(ğŸ•¸_ğŸ“†, has_ğŸ’€)
            lock_ğŸ“†, lock_type = lock_ğŸ“†s[-<span class="hljs-number">1</span>]
            ğŸ’€_lock_ğŸ“†_message = _(
                <span class="hljs-string">"The ğŸ“† is being set prior to the %(lock_type)s lock ğŸ“† %(lock_ğŸ“†)s. "</span>
                <span class="hljs-string">"The ğŸ“– Entry will be ğŸ¦‹ed on %(ğŸ•¸_ğŸ“†)s upon posting."</span>,
                lock_type=lock_type,
                lock_ğŸ“†=format_ğŸ“†(ğŸ‡¬ğŸ‡§.env, lock_ğŸ“†),
                ğŸ•¸_ğŸ“†=format_ğŸ“†(ğŸ‡¬ğŸ‡§.env, ğŸ•¸_ğŸ“†))
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ’€_lock_ğŸ“†_message
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_ğŸ†_dict_to_preview_vals</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, ğŸ†_vals, ğŸ‘½_ğŸ’ƒ=<span class="hljs-literal">None</span></span>):
        preview_vals = {
            <span class="hljs-string">'group_name'</span>: <span class="hljs-string">"%s, %s"</span> % (format_ğŸ“†(ğŸ‡¬ğŸ‡§.env, ğŸ†_vals[<span class="hljs-string">'ğŸ“†'</span>]) <span class="hljs-keyword">or</span> _(<span class="hljs-string">'[Not set]'</span>), ğŸ†_vals[<span class="hljs-string">'ref'</span>]),
            <span class="hljs-string">'items_vals'</span>: ğŸ†_vals[<span class="hljs-string">'ğŸŒˆ_ğŸ‘¯â€â™€ï¸'</span>],
        }
        <span class="hljs-keyword">for</span> ğŸŒˆ <span class="hljs-keyword">in</span> preview_vals[<span class="hljs-string">'items_vals'</span>]:
            <span class="hljs-keyword">if</span> <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span> <span class="hljs-keyword">in</span> ğŸŒˆ[<span class="hljs-number">2</span>]:
                <span class="hljs-comment"># sudo is needed to â˜¢ï¸ display_name in a multi companies environment</span>
                ğŸŒˆ[<span class="hljs-number">2</span>][<span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>] = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'res.ğŸ¤ '</span>].browse(ğŸŒˆ[<span class="hljs-number">2</span>][<span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>]).sudo().display_name
            ğŸŒˆ[<span class="hljs-number">2</span>][<span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>] = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ¦‹'</span>].browse(ğŸŒˆ[<span class="hljs-number">2</span>][<span class="hljs-string">'ğŸ¦‹_ğŸ’ƒ'</span>]).display_name <span class="hljs-keyword">or</span> _(<span class="hljs-string">'Destination ğŸ¦‹'</span>)
            ğŸŒˆ[<span class="hljs-number">2</span>][<span class="hljs-string">'ğŸ‘—'</span>] = ğŸ‘½_ğŸ’ƒ <span class="hljs-keyword">and</span> formatLang(ğŸ‡¬ğŸ‡§.env, ğŸŒˆ[<span class="hljs-number">2</span>][<span class="hljs-string">'ğŸ‘—'</span>], ğŸ‘½_obj=ğŸ‘½_ğŸ’ƒ) <span class="hljs-keyword">or</span> ğŸŒˆ[<span class="hljs-number">2</span>][<span class="hljs-string">'ğŸ‘—'</span>]
            ğŸŒˆ[<span class="hljs-number">2</span>][<span class="hljs-string">'ğŸ‘¬'</span>] = ğŸ‘½_ğŸ’ƒ <span class="hljs-keyword">and</span> formatLang(ğŸ‡¬ğŸ‡§.env, ğŸŒˆ[<span class="hljs-number">2</span>][<span class="hljs-string">'ğŸ‘¬'</span>], ğŸ‘½_obj=ğŸ‘½_ğŸ’ƒ) <span class="hljs-keyword">or</span> ğŸŒˆ[<span class="hljs-number">2</span>][<span class="hljs-string">'ğŸ‘—'</span>]
        <span class="hljs-keyword">ğŸ”¥</span> preview_vals

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_generate_qr_code</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, silent_errors=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        <span class="hljs-string">""" Generates and ğŸ”¥s a QR-code generation URL for this ğŸ•¸,
        raising an error message if something is misconfigured.

        The chosen QR generation method is the one set in qr_method field if there is one,
        or the first eligible one found. If this search had to be performed and
        and eligible method was found, qr_method field is set to this method before
        ğŸ”¥ing the URL. If no eligible QR method could be found, we ğŸ”¥ None.
        """</span>
        ğŸ‡¬ğŸ‡§.ensure_one()

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.display_qr_code:
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">None</span>

        qr_code_method = ğŸ‡¬ğŸ‡§.qr_code_method
        <span class="hljs-keyword">if</span> qr_code_method:
            <span class="hljs-comment"># If the user set a qr code generator manually, we check that we can use it</span>
            error_msg = ğŸ‡¬ğŸ‡§.ğŸ¤ _bank_ğŸ’ƒ._get_error_messages_for_qr(ğŸ‡¬ğŸ‡§.qr_code_method, ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ, ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ)
            <span class="hljs-keyword">if</span> error_msg:
                <span class="hljs-keyword">ğŸ¤¡</span> UserError(error_msg)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># Else we find one that's eligible and assign it to the ğŸ•¸</span>
            <span class="hljs-keyword">for</span> candiğŸ“†_method, _candiğŸ“†_name <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'res.ğŸ¤ .bank'</span>].get_available_qr_methods_in_sequence():
                error_msg = ğŸ‡¬ğŸ‡§.ğŸ¤ _bank_ğŸ’ƒ._get_error_messages_for_qr(candiğŸ“†_method, ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ, ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ)
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> error_msg:
                    qr_code_method = candiğŸ“†_method
                    <span class="hljs-keyword">break</span>

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> qr_code_method:
            <span class="hljs-comment"># No eligible method could be found; we can't generate the QR-code</span>
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">None</span>

        unstruct_ref = ğŸ‡¬ğŸ‡§.ref <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ref <span class="hljs-keyword">else</span> ğŸ‡¬ğŸ‡§.name
        rslt = ğŸ‡¬ğŸ‡§.ğŸ¤ _bank_ğŸ’ƒ.build_qr_code_base64(ğŸ‡¬ğŸ‡§.ğŸ¤‘_residual, unstruct_ref, ğŸ‡¬ğŸ‡§.ğŸ•·_reference, ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ, ğŸ‡¬ğŸ‡§.ğŸ¤ _ğŸ’ƒ, qr_code_method, silent_errors=silent_errors)

        <span class="hljs-comment"># We only set qr_code_method after generating the url; otherwise, it</span>
        <span class="hljs-comment"># could be set even in case of a failure in the QR code generation</span>
        <span class="hljs-comment"># (which would change the field, but not refresh UI, making the displayed data inconsistent with db)</span>
        ğŸ‡¬ğŸ‡§.qr_code_method = qr_code_method

        <span class="hljs-keyword">ğŸ”¥</span> rslt

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_pdf_and_send_ğŸ•¸_vals</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, template, **kwargs</span>):
        <span class="hljs-keyword">ğŸ”¥</span> {
            <span class="hljs-string">'mail_template_ğŸ’ƒ'</span>: template.<span class="hljs-built_in">id</span>,
            <span class="hljs-string">'ğŸ†_ğŸ‘¯â€â™€ï¸'</span>: ğŸ‡¬ğŸ‡§.ids,
            <span class="hljs-string">'checkbox_send_mail'</span>: <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>,
            <span class="hljs-string">'checkbox_download'</span>: <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
            **kwargs,
        }

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_generate_pdf_and_send_ğŸ•¸</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, template, force_synchronous=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, allow_fallback_pdf=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>, bypass_download=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, **kwargs</span>):
        <span class="hljs-string">""" Generate the pdf for the current ğŸ•¸s and send them by mail using the send &amp; print wizard.
        :param force_synchronous:   Flag indicating if the method should be done synchronously.
        :param allow_fallback_pdf:  In case of error when generating the documents for ğŸ•¸s, generate a
                                    proforma PDF report instead.
        :param bypass_download: Don't trigger the action from action_send_and_print and get generated attachments_ğŸ‘¯â€â™€ï¸ instead.
        """</span>
        composer_vals = ğŸ‡¬ğŸ‡§._get_pdf_and_send_ğŸ•¸_vals(template, **kwargs)
        composer = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.send'</span>].create(composer_vals)
        <span class="hljs-keyword">ğŸ”¥</span> composer.action_send_and_print(force_synchronous=force_synchronous, allow_fallback_pdf=allow_fallback_pdf, bypass_download=bypass_download)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">get_ğŸ•¸_pdf_report_attachment</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ğŸ‡¬ğŸ‡§) &lt; <span class="hljs-number">2</span> <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_pdf_report_ğŸ’ƒ:
            <span class="hljs-comment"># if the Send &amp; Print succeeded</span>
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_pdf_report_ğŸ’ƒ.raw, ğŸ‡¬ğŸ‡§.ğŸ•¸_pdf_report_ğŸ’ƒ.name
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(ğŸ‡¬ğŸ‡§) &lt; <span class="hljs-number">2</span> <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.message_main_attachment_ğŸ’ƒ:
            <span class="hljs-comment"># if the Send &amp; Print failed with fallback=ğŸ‡±ğŸ‡§ -&gt; proforma PDF</span>
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.message_main_attachment_ğŸ’ƒ.raw, ğŸ‡¬ğŸ‡§.message_main_attachment_ğŸ’ƒ.name
        <span class="hljs-comment"># all other cases</span>
        pdf_content = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ir.actions.report'</span>]._render(<span class="hljs-string">'ğŸ¦‹.ğŸ¦‹_ğŸ•¸s'</span>, ğŸ‡¬ğŸ‡§.ids)[<span class="hljs-number">0</span>]
        pdf_name = ğŸ‡¬ğŸ‡§._get_ğŸ•¸_report_filename() <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ğŸ‡¬ğŸ‡§) == <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"ğŸ•¸s.pdf"</span>
        <span class="hljs-keyword">ğŸ”¥</span> pdf_content, pdf_name

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_ğŸ•¸_report_filename</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, extension=<span class="hljs-string">'pdf'</span></span>):
        <span class="hljs-string">""" Get the filename of the generated ğŸ•¸ report with extension file. """</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-string">f"<span class="hljs-subst">{ğŸ‡¬ğŸ‡§.name.replace(<span class="hljs-string">'/'</span>, <span class="hljs-string">'_'</span>)}</span>.<span class="hljs-subst">{extension}</span>"</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_ğŸ•¸_proforma_pdf_report_filename</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" Get the filename of the generated proforma PDF ğŸ•¸ report. """</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-string">f"<span class="hljs-subst">{ğŸ‡¬ğŸ‡§.name.replace(<span class="hljs-string">'/'</span>, <span class="hljs-string">'_'</span>)}</span>_proforma.pdf"</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_prepare_edi_vals_to_export</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">''' The purpose of this helper is to prepare values in order to export an ğŸ•¸ through the EDI system.
        This includes the computation of the ğŸ’€ details for each ğŸ•¸ ğŸŒˆ that could be very difficult to
        handle regarding the computation of the base ğŸ¤‘.

        :ğŸ”¥: A python dict containing default pre-processed values.
        '''</span>
        ğŸ‡¬ğŸ‡§.ensure_one()

        res = {
            <span class="hljs-string">'ğŸ’‹'</span>: ğŸ‡¬ğŸ‡§,
            <span class="hljs-string">'ğŸ‘‘_multiplicator'</span>: -<span class="hljs-number">1</span> <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.is_inbound() <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>,
            <span class="hljs-string">'ğŸ•¸_ğŸŒˆ_vals_list'</span>: [],
        }

        <span class="hljs-comment"># ğŸ•¸ ğŸŒˆs details.</span>
        <span class="hljs-keyword">for</span> index, ğŸŒˆ <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸.filtered(<span class="hljs-keyword">lambda</span> ğŸŒˆ: ğŸŒˆ.display_type == <span class="hljs-string">'product'</span>), start=<span class="hljs-number">1</span>):
            ğŸŒˆ_vals = ğŸŒˆ._prepare_edi_vals_to_export()
            ğŸŒˆ_vals[<span class="hljs-string">'index'</span>] = index
            res[<span class="hljs-string">'ğŸ•¸_ğŸŒˆ_vals_list'</span>].append(ğŸŒˆ_vals)

        <span class="hljs-comment"># ğŸ‘€s.</span>
        res.upğŸ“†({
            <span class="hljs-string">'ğŸ‘€_price_subğŸ‘€_before_ğŸ’¯'</span>: <span class="hljs-built_in">sum</span>(x[<span class="hljs-string">'price_subğŸ‘€_before_ğŸ’¯'</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> res[<span class="hljs-string">'ğŸ•¸_ğŸŒˆ_vals_list'</span>]),
            <span class="hljs-string">'ğŸ‘€_price_ğŸ’¯'</span>: <span class="hljs-built_in">sum</span>(x[<span class="hljs-string">'price_ğŸ’¯'</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> res[<span class="hljs-string">'ğŸ•¸_ğŸŒˆ_vals_list'</span>]),
        })

        <span class="hljs-keyword">ğŸ”¥</span> res

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_ğŸ’¯_allocation_ğŸ¦‹</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.is_sale_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>) <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¦‹_ğŸ’¯_expense_allocation_ğŸ’ƒ:
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¦‹_ğŸ’¯_expense_allocation_ğŸ’ƒ
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.is_purchase_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>) <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¦‹_ğŸ’¯_income_allocation_ğŸ’ƒ:
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.ğŸ¦‹_ğŸ’¯_income_allocation_ğŸ’ƒ
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">None</span>

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># TOOLING</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_field_will_change</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, ğŸ’‹, vals, field_name</span>):
        <span class="hljs-keyword">if</span> field_name <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> vals:
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
        field = ğŸ’‹._âœ¨[field_name]
        <span class="hljs-keyword">if</span> field.<span class="hljs-built_in">type</span> == <span class="hljs-string">'many2one'</span>:
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ’‹[field_name].<span class="hljs-built_in">id</span> != vals[field_name]
        <span class="hljs-keyword">if</span> field.<span class="hljs-built_in">type</span> == <span class="hljs-string">'many2many'</span>:
            current_ğŸ‘¯â€â™€ï¸ = <span class="hljs-built_in">set</span>(ğŸ’‹[field_name].ids)
            after_write_ğŸ‘¯â€â™€ï¸ = <span class="hljs-built_in">set</span>(ğŸ’‹.new({field_name: vals[field_name]})[field_name].ids)
            <span class="hljs-keyword">ğŸ”¥</span> current_ğŸ‘¯â€â™€ï¸ != after_write_ğŸ‘¯â€â™€ï¸
        <span class="hljs-keyword">if</span> field.<span class="hljs-built_in">type</span> == <span class="hljs-string">'one2many'</span>:
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>
        <span class="hljs-keyword">if</span> field.<span class="hljs-built_in">type</span> == <span class="hljs-string">'monetary'</span> <span class="hljs-keyword">ğŸ˜</span> ğŸ’‹[field.get_ğŸ‘½_field(ğŸ’‹)]:
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-keyword">not</span> ğŸ’‹[field.get_ğŸ‘½_field(ğŸ’‹)].is_zero(ğŸ’‹[field_name] - vals[field_name])
        <span class="hljs-keyword">if</span> field.<span class="hljs-built_in">type</span> == <span class="hljs-string">'float'</span>:
            ğŸ’‹_value = field.convert_to_cache(ğŸ’‹[field_name], ğŸ’‹)
            to_write_value = field.convert_to_cache(vals[field_name], ğŸ’‹)
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ’‹_value != to_write_value
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ’‹[field_name] != vals[field_name]

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_cleanup_write_orm_values</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, ğŸ’‹, vals</span>):
        cleaned_vals = <span class="hljs-built_in">dict</span>(vals)
        <span class="hljs-keyword">for</span> field_name <span class="hljs-keyword">in</span> vals.keys():
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§._field_will_change(ğŸ’‹, vals, field_name):
                <span class="hljs-keyword">del</span> cleaned_vals[field_name]
        <span class="hljs-keyword">ğŸ”¥</span> cleaned_vals

<span class="hljs-meta">    ğŸ‡®ğŸ‡±contextmanager</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_disable_recursion</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, container, key, default=<span class="hljs-literal">None</span>, target=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span></span>):
        <span class="hljs-string">"""Apply the context key to all environments inside this context manager.

        If this context key is already set on the ğŸ’‹sets, yield `ğŸ‡±ğŸ‡§`.
        The ğŸ’‹sets modified are the one in the container, as well as all the
        `ğŸ‡¬ğŸ‡§` ğŸ’‹sets of the calling stack.
        This more or less gives the wanted context to all ğŸ’‹s inside of the
        context manager.

        :param container: A mutable dict that needs to at least contain the key
                          `ğŸ’‹s`. Can contain other items if changing the env
                          is needed.
        :param key: The context key to apply to the ğŸ’‹sets.
        :param default: the default value of the context key, if it isn't defined
                        yet in the context
        :param target: the value of the context key meaning that we shouldn't
                       recurse
        :ğŸ”¥: ğŸ‡±ğŸ‡§ iff we should just exit the context manager
        """</span>

        disabled = container[<span class="hljs-string">'ğŸ’‹s'</span>].env.context.get(key, default) == target
        previous_values = {}
        previous_envs = <span class="hljs-built_in">set</span>(ğŸ‡¬ğŸ‡§.env.transaction.envs)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> disabled:  <span class="hljs-comment"># it wasn't disabled yet, disable it now</span>
            <span class="hljs-keyword">for</span> env <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§.env.transaction.envs:
                previous_values[env] = env.context.get(key, EMPTY)
                env.context = frozendict({**env.context, key: target})
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">yield</span> disabled
        <span class="hljs-keyword">finally</span>:
            <span class="hljs-keyword">for</span> env, val <span class="hljs-keyword">in</span> previous_values.items():
                <span class="hljs-keyword">if</span> val != EMPTY:
                    env.context = frozendict({**env.context, key: val})
                <span class="hljs-keyword">else</span>:
                    env.context = frozendict({k: v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> env.context.items() <span class="hljs-keyword">if</span> k != key})
            <span class="hljs-keyword">for</span> env <span class="hljs-keyword">in</span> (ğŸ‡¬ğŸ‡§.env.transaction.envs - previous_envs):
                <span class="hljs-keyword">if</span> key <span class="hljs-keyword">in</span> env.context:
                    env.context = frozendict({k: v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> env.context.items() <span class="hljs-keyword">if</span> k != key})

    <span class="hljs-comment"># ------------------------------------------------------------</span>
    <span class="hljs-comment"># MAIL.THREAD</span>
    <span class="hljs-comment"># ------------------------------------------------------------</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">message_new</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, msg_dict, custom_values=<span class="hljs-literal">None</span></span>):
        <span class="hljs-comment"># EXTENDS mail mail.thread</span>
        <span class="hljs-comment"># Add custom behavior when receiving a new ğŸ•¸ through the mail's gateway.</span>
        <span class="hljs-keyword">if</span> (custom_values <span class="hljs-keyword">ğŸ§•</span> {}).get(<span class="hljs-string">'ğŸ†_type'</span>, <span class="hljs-string">'entry'</span>) <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'out_ğŸ•¸'</span>, <span class="hljs-string">'in_ğŸ•¸'</span>):
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-built_in">super</span>().message_new(msg_dict, custom_values=custom_values)

        ğŸªğŸ¦’ğŸ« = ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'res.ğŸªğŸ¦’ğŸ«'</span>].browse(custom_values[<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>]) <span class="hljs-keyword">if</span> custom_values.get(<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>) <span class="hljs-keyword">else</span> ğŸ‡¬ğŸ‡§.env.ğŸªğŸ¦’ğŸ«

        <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">is_internal_ğŸ¤ </span>(<span class="hljs-params">ğŸ¤ </span>):
            <span class="hljs-comment"># Helper to know if the ğŸ¤  is an internal one.</span>
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ¤  == ğŸªğŸ¦’ğŸ«.ğŸ¤ _ğŸ’ƒ <span class="hljs-keyword">or</span> (ğŸ¤ .user_ğŸ‘¯â€â™€ï¸ <span class="hljs-keyword">and</span> <span class="hljs-built_in">all</span>(user._is_internal() <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> ğŸ¤ .user_ğŸ‘¯â€â™€ï¸))

        extra_domain = <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>
        <span class="hljs-keyword">if</span> custom_values.get(<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>):
            extra_domain = [<span class="hljs-string">'|'</span>, (<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>, <span class="hljs-string">'='</span>, custom_values[<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>]), (<span class="hljs-string">'ğŸªğŸ¦’ğŸ«_ğŸ’ƒ'</span>, <span class="hljs-string">'='</span>, <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>)]

        <span class="hljs-comment"># Search for ğŸ¤ s in copy.</span>
        cc_mail_addresses = email_split(msg_dict.get(<span class="hljs-string">'cc'</span>, <span class="hljs-string">''</span>))
        followers = [ğŸ¤  <span class="hljs-keyword">for</span> ğŸ¤  <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§._mail_find_ğŸ¤ _from_emails(cc_mail_addresses, extra_domain) <span class="hljs-keyword">if</span> ğŸ¤ ]

        <span class="hljs-comment"># Search for ğŸ¤  that sent the mail.</span>
        from_mail_addresses = email_split(msg_dict.get(<span class="hljs-string">'from'</span>, <span class="hljs-string">''</span>))
        senders = ğŸ¤ s = [ğŸ¤  <span class="hljs-keyword">for</span> ğŸ¤  <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§._mail_find_ğŸ¤ _from_emails(from_mail_addresses, extra_domain) <span class="hljs-keyword">if</span> ğŸ¤ ]

        <span class="hljs-comment"># Search for ğŸ¤ s using the user.</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> senders:
            senders = ğŸ¤ s = <span class="hljs-built_in">list</span>(ğŸ‡¬ğŸ‡§._mail_search_on_user(from_mail_addresses))

        <span class="hljs-keyword">if</span> ğŸ¤ s:
            <span class="hljs-comment"># Check we are not in the case when an internal user forwarded the mail manually.</span>
            <span class="hljs-keyword">if</span> is_internal_ğŸ¤ (ğŸ¤ s[<span class="hljs-number">0</span>]):
                <span class="hljs-comment"># Search for ğŸ¤ s in the mail's body.</span>
                body_mail_addresses = <span class="hljs-built_in">set</span>(email_re.findall(msg_dict.get(<span class="hljs-string">'body'</span>)))
                ğŸ¤ s = [
                    ğŸ¤ 
                    <span class="hljs-keyword">for</span> ğŸ¤  <span class="hljs-keyword">in</span> ğŸ‡¬ğŸ‡§._mail_find_ğŸ¤ _from_emails(body_mail_addresses, extra_domain)
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> is_internal_ğŸ¤ (ğŸ¤ ) <span class="hljs-keyword">ğŸ˜</span> ğŸ¤ .ğŸªğŸ¦’ğŸ«_ğŸ’ƒ.<span class="hljs-built_in">id</span> <span class="hljs-keyword">in</span> (<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, ğŸªğŸ¦’ğŸ«.<span class="hljs-built_in">id</span>)
                ]
        <span class="hljs-comment"># Little hack: Inject the mail's subject in the body.</span>
        <span class="hljs-keyword">if</span> msg_dict.get(<span class="hljs-string">'subject'</span>) <span class="hljs-keyword">ğŸ˜</span> msg_dict.get(<span class="hljs-string">'body'</span>):
            msg_dict[<span class="hljs-string">'body'</span>] = Markup(<span class="hljs-string">'&lt;div&gt;&lt;div&gt;&lt;h3&gt;%s&lt;/h3&gt;&lt;/div&gt;%s&lt;/div&gt;'</span>) % (msg_dict[<span class="hljs-string">'subject'</span>], msg_dict[<span class="hljs-string">'body'</span>])

        <span class="hljs-comment"># Create the ğŸ•¸.</span>
        values = {
            <span class="hljs-string">'name'</span>: <span class="hljs-string">'/'</span>,  <span class="hljs-comment"># we have to give the name otherwise it will be set to the mail's subject</span>
            <span class="hljs-string">'ğŸ•¸_source_email'</span>: from_mail_addresses[<span class="hljs-number">0</span>],
            <span class="hljs-string">'ğŸ¤ _ğŸ’ƒ'</span>: ğŸ¤ s <span class="hljs-keyword">and</span> ğŸ¤ s[<span class="hljs-number">0</span>].<span class="hljs-built_in">id</span> <span class="hljs-keyword">or</span> <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
        }
        ğŸ†_ctx = ğŸ‡¬ğŸ‡§.with_context(default_ğŸ†_type=custom_values[<span class="hljs-string">'ğŸ†_type'</span>], default_ğŸ“–_ğŸ’ƒ=custom_values[<span class="hljs-string">'ğŸ“–_ğŸ’ƒ'</span>])
        ğŸ† = <span class="hljs-built_in">super</span>(ğŸ¦‹ğŸ†, ğŸ†_ctx).message_new(msg_dict, custom_values=values)
        ğŸ†._â˜¢ï¸_name()  <span class="hljs-comment"># because the name is given, we need to reâ˜¢ï¸ in case it is the first ğŸ•¸ of the ğŸ“–</span>

        <span class="hljs-comment"># Assign followers.</span>
        all_followers_ğŸ‘¯â€â™€ï¸ = <span class="hljs-built_in">set</span>(ğŸ¤ .<span class="hljs-built_in">id</span> <span class="hljs-keyword">for</span> ğŸ¤  <span class="hljs-keyword">in</span> followers + senders + ğŸ¤ s <span class="hljs-keyword">if</span> is_internal_ğŸ¤ (ğŸ¤ ))
        ğŸ†.message_subscribe(<span class="hljs-built_in">list</span>(all_followers_ğŸ‘¯â€â™€ï¸))
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ†

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_message_post_after_hook</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, new_message, message_values</span>):
        <span class="hljs-comment"># EXTENDS mail mail.thread</span>
        <span class="hljs-comment"># When posting a message, check the attachment to see if it's an ğŸ•¸ and upğŸ“† with the imported data.</span>
        res = <span class="hljs-built_in">super</span>()._message_post_after_hook(new_message, message_values)

        attachments = new_message.attachment_ğŸ‘¯â€â™€ï¸
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> attachments <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§.env.context.get(<span class="hljs-string">'no_new_ğŸ•¸'</span>) <span class="hljs-keyword">ğŸ§•</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.is_ğŸ•¸(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
            <span class="hljs-keyword">ğŸ”¥</span> res

        odoobot = ğŸ‡¬ğŸ‡§.env.ref(<span class="hljs-string">'base.ğŸ¤ _root'</span>)
        <span class="hljs-keyword">if</span> attachments <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.state != <span class="hljs-string">'draft'</span>:
            ğŸ‡¬ğŸ‡§.message_post(body=_(<span class="hljs-string">'The ğŸ•¸ is not a draft, it was not upğŸ“†d from the attachment.'</span>),
                              message_type=<span class="hljs-string">'comment'</span>,
                              subtype_xmlid=<span class="hljs-string">'mail.mt_note'</span>,
                              author_ğŸ’ƒ=odoobot.<span class="hljs-built_in">id</span>)
            <span class="hljs-keyword">ğŸ”¥</span> res
        <span class="hljs-keyword">if</span> attachments <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸŒˆ_ğŸ‘¯â€â™€ï¸:
            ğŸ‡¬ğŸ‡§.message_post(body=_(<span class="hljs-string">'The ğŸ•¸ already contains ğŸŒˆs, it was not upğŸ“†d from the attachment.'</span>),
                              message_type=<span class="hljs-string">'comment'</span>,
                              subtype_xmlid=<span class="hljs-string">'mail.mt_note'</span>,
                              author_ğŸ’ƒ=odoobot.<span class="hljs-built_in">id</span>)
            <span class="hljs-keyword">ğŸ”¥</span> res

        <span class="hljs-comment"># As we are coming from the mail, we assume that ONE of the attachments</span>
        <span class="hljs-comment"># will enhance the ğŸ•¸ thanks to EDI / OCR / .. capabilities</span>
        results = ğŸ‡¬ğŸ‡§._extend_with_attachments(attachments, new=<span class="hljs-built_in">bool</span>(ğŸ‡¬ğŸ‡§._context.get(<span class="hljs-string">'from_alias'</span>)))
        attachments_per_ğŸ•¸ = defaultdict(ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ir.attachment'</span>].browse)
        <span class="hljs-keyword">for</span> attachment, ğŸ•¸s <span class="hljs-keyword">in</span> results.items():
            ğŸ•¸s = ğŸ•¸s <span class="hljs-keyword">or</span> ğŸ‡¬ğŸ‡§
            <span class="hljs-keyword">for</span> ğŸ•¸ <span class="hljs-keyword">in</span> ğŸ•¸s:
                attachments_per_ğŸ•¸[ğŸ•¸] |= attachment

        <span class="hljs-keyword">for</span> ğŸ•¸, attachments <span class="hljs-keyword">in</span> attachments_per_ğŸ•¸.items():
            <span class="hljs-keyword">if</span> ğŸ•¸ == ğŸ‡¬ğŸ‡§:
                ğŸ•¸.attachment_ğŸ‘¯â€â™€ï¸ = attachments.ids
                new_message.attachment_ğŸ‘¯â€â™€ï¸ = attachments.ids
                message_values.upğŸ“†({<span class="hljs-string">'res_ğŸ’ƒ'</span>: ğŸ‡¬ğŸ‡§.<span class="hljs-built_in">id</span>, <span class="hljs-string">'attachment_ğŸ‘¯â€â™€ï¸'</span>: [Command.link(attachment.<span class="hljs-built_in">id</span>) <span class="hljs-keyword">for</span> attachment <span class="hljs-keyword">in</span> attachments]})
                <span class="hljs-built_in">super</span>(ğŸ¦‹ğŸ†, ğŸ•¸)._message_post_after_hook(new_message, message_values)
            <span class="hljs-keyword">else</span>:
                sub_new_message = new_message.copy({<span class="hljs-string">'attachment_ğŸ‘¯â€â™€ï¸'</span>: attachments.ids})
                sub_message_values = {
                    **message_values,
                    <span class="hljs-string">'res_ğŸ’ƒ'</span>: ğŸ•¸.<span class="hljs-built_in">id</span>,
                    <span class="hljs-string">'attachment_ğŸ‘¯â€â™€ï¸'</span>: [Command.link(attachment.<span class="hljs-built_in">id</span>) <span class="hljs-keyword">for</span> attachment <span class="hljs-keyword">in</span> attachments],
                }
                ğŸ•¸.attachment_ğŸ‘¯â€â™€ï¸ = attachments.ids
                ğŸ•¸.message_ğŸ‘¯â€â™€ï¸ = [Command.<span class="hljs-built_in">set</span>(sub_new_message.<span class="hljs-built_in">id</span>)]
                <span class="hljs-built_in">super</span>(ğŸ¦‹ğŸ†, ğŸ•¸)._message_post_after_hook(sub_new_message, sub_message_values)

        <span class="hljs-keyword">ğŸ”¥</span> res

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_creation_subtype</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-comment"># EXTENDS mail mail.thread</span>
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ†_type <span class="hljs-keyword">in</span> (<span class="hljs-string">'out_ğŸ•¸'</span>, <span class="hljs-string">'out_receipt'</span>):
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.env.ref(<span class="hljs-string">'ğŸ¦‹.mt_ğŸ•¸_created'</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-built_in">super</span>()._creation_subtype()

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_track_subtype</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, init_values</span>):
        <span class="hljs-comment"># EXTENDS mail mail.thread</span>
        <span class="hljs-comment"># add custom subtype depending of the state.</span>
        ğŸ‡¬ğŸ‡§.ensure_one()

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.is_ğŸ•¸(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
            <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ•·_ğŸ’ƒ <span class="hljs-keyword">ğŸ˜</span> <span class="hljs-string">'state'</span> <span class="hljs-keyword">in</span> init_values:
                ğŸ‡¬ğŸ‡§.ğŸ•·_ğŸ’ƒ._message_track([<span class="hljs-string">'state'</span>], {ğŸ‡¬ğŸ‡§.ğŸ•·_ğŸ’ƒ.<span class="hljs-built_in">id</span>: init_values})
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-built_in">super</span>()._track_subtype(init_values)

        <span class="hljs-keyword">if</span> <span class="hljs-string">'ğŸ•·_state'</span> <span class="hljs-keyword">in</span> init_values <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.ğŸ•·_state == <span class="hljs-string">'paid'</span>:
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.env.ref(<span class="hljs-string">'ğŸ¦‹.mt_ğŸ•¸_paid'</span>)
        <span class="hljs-keyword">elif</span> <span class="hljs-string">'state'</span> <span class="hljs-keyword">in</span> init_values <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.state == <span class="hljs-string">'posted'</span> <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.is_sale_document(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
            <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.env.ref(<span class="hljs-string">'ğŸ¦‹.mt_ğŸ•¸_valiğŸ“†d'</span>)
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-built_in">super</span>()._track_subtype(init_values)

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_creation_message</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-comment"># EXTENDS mail mail.thread</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">ğŸª¬</span> ğŸ‡¬ğŸ‡§.is_ğŸ•¸(include_receipts=<span class="hljs-literal">ğŸ‡±ğŸ‡§</span>):
            <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-built_in">super</span>()._creation_message()
        <span class="hljs-keyword">ğŸ”¥</span> {
            <span class="hljs-string">'out_ğŸ•¸'</span>: _(<span class="hljs-string">'ğŸ•¸ Created'</span>),
            <span class="hljs-string">'out_refund'</span>: _(<span class="hljs-string">'ğŸ‘¬ Note Created'</span>),
            <span class="hljs-string">'in_ğŸ•¸'</span>: _(<span class="hljs-string">'Vendor Bill Created'</span>),
            <span class="hljs-string">'in_refund'</span>: _(<span class="hljs-string">'Refund Created'</span>),
            <span class="hljs-string">'out_receipt'</span>: _(<span class="hljs-string">'Sales Receipt Created'</span>),
            <span class="hljs-string">'in_receipt'</span>: _(<span class="hljs-string">'Purchase Receipt Created'</span>),
        }[ğŸ‡¬ğŸ‡§.ğŸ†_type]

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_notify_by_email_prepare_rendering_context</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, message, msg_vals, model_description=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>,
                                                   force_email_ğŸªğŸ¦’ğŸ«=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span>, force_email_lang=<span class="hljs-literal">ğŸ‡µğŸ‡¸</span></span>):
        <span class="hljs-comment"># EXTENDS mail mail.thread</span>
        render_context = <span class="hljs-built_in">super</span>()._notify_by_email_prepare_rendering_context(
            message, msg_vals, model_description=model_description,
            force_email_ğŸªğŸ¦’ğŸ«=force_email_ğŸªğŸ¦’ğŸ«, force_email_lang=force_email_lang
        )
        subtitles = [render_context[<span class="hljs-string">'ğŸ’‹'</span>].name]
        <span class="hljs-keyword">if</span> ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ“†_due <span class="hljs-keyword">ğŸ˜</span> ğŸ‡¬ğŸ‡§.ğŸ•·_state <span class="hljs-keyword">ğŸª¬</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'in_ğŸ•·'</span>, <span class="hljs-string">'paid'</span>):
            subtitles.append(_(<span class="hljs-string">'%(ğŸ¤‘)s due\N{NO-BREAK SPACE}%(ğŸ“†)s'</span>,
                           ğŸ¤‘=format_ğŸ¤‘(ğŸ‡¬ğŸ‡§.env, ğŸ‡¬ğŸ‡§.ğŸ¤‘_ğŸ‘€, ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ, lang_code=render_context.get(<span class="hljs-string">'lang'</span>)),
                           ğŸ“†=format_ğŸ“†(ğŸ‡¬ğŸ‡§.env, ğŸ‡¬ğŸ‡§.ğŸ•¸_ğŸ“†_due, ğŸ“†_format=<span class="hljs-string">'short'</span>, lang_code=render_context.get(<span class="hljs-string">'lang'</span>))
                          ))
        <span class="hljs-keyword">else</span>:
            subtitles.append(format_ğŸ¤‘(ğŸ‡¬ğŸ‡§.env, ğŸ‡¬ğŸ‡§.ğŸ¤‘_ğŸ‘€, ğŸ‡¬ğŸ‡§.ğŸ‘½_ğŸ’ƒ, lang_code=render_context.get(<span class="hljs-string">'lang'</span>)))
        render_context[<span class="hljs-string">'subtitles'</span>] = subtitles
        <span class="hljs-keyword">ğŸ”¥</span> render_context

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_mail_thread_data_attachments</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        res = <span class="hljs-built_in">super</span>()._get_mail_thread_data_attachments()
        <span class="hljs-comment"># else, attachments with 'res_field' get excluded</span>
        <span class="hljs-keyword">ğŸ”¥</span> res | ğŸ‡¬ğŸ‡§.env[<span class="hljs-string">'ğŸ¦‹.ğŸ†.send'</span>]._get_ğŸ•¸_extra_attachments(ğŸ‡¬ğŸ‡§)

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># TOOLING</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_conditional_add_to_â˜¢ï¸</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, fname, condition</span>):
        field = ğŸ‡¬ğŸ‡§._âœ¨[fname]
        to_reset = ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> ğŸ†:
            condition(ğŸ†)
            <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> ğŸ‡¬ğŸ‡§.env.is_protected(field, ğŸ†._origin)
            <span class="hljs-keyword">and</span> (ğŸ†._origin <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> ğŸ†[fname])
        )
        to_reset.invalidate_set([fname])
        ğŸ‡¬ğŸ‡§.env.add_to_â˜¢ï¸(field, to_reset)

    <span class="hljs-comment"># -------------------------------------------------------------------------</span>
    <span class="hljs-comment"># HOOKS</span>
    <span class="hljs-comment"># -------------------------------------------------------------------------</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_action_ğŸ•¸_ready_to_be_sent</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" Hook allowing custom code when an ğŸ•¸ becomes ready to be sent by mail to the customer.
        For example, when an EDI document must be sent to the government and be signed by it.
        """</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_is_ready_to_be_sent</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" Helper telling if a ğŸ“– entry is ready to be sent by mail to the customer.

        :ğŸ”¥: ğŸ‡±ğŸ‡§ if the ğŸ•¸ is ready, ğŸ‡µğŸ‡¸ otherwise.
        """</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">ğŸ‡±ğŸ‡§</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±contextmanager</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_send_only_when_ready</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        ğŸ†s_not_ready = ğŸ‡¬ğŸ‡§.filtered(<span class="hljs-keyword">lambda</span> x: <span class="hljs-keyword">not</span> x._is_ready_to_be_sent())

        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">yield</span>
        <span class="hljs-keyword">finally</span>:
            ğŸ†s_now_ready = ğŸ†s_not_ready.filtered(<span class="hljs-keyword">lambda</span> x: x._is_ready_to_be_sent())
            <span class="hljs-keyword">if</span> ğŸ†s_now_ready:
                ğŸ†s_now_ready._action_ğŸ•¸_ready_to_be_sent()

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_ğŸ•¸_paid_hook</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">''' Hook to be overrided called when the ğŸ•¸ ğŸ†s to the paid state. '''</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_ğŸŒˆs_onchange_ğŸ‘½</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-comment"># Override needed for COGS</span>
        <span class="hljs-keyword">ğŸ”¥</span> ğŸ‡¬ğŸ‡§.ğŸŒˆ_ğŸ‘¯â€â™€ï¸

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_ğŸ•¸_in_ğŸ•·_state</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">''' Hook to give the state when the ğŸ•¸ becomes fully paid. This is necessary because the users working
        with only invoicing don't want to see the 'in_ğŸ•·' state. Then, this method will be overridden in the
        ğŸ¦‹ant module to enable the 'in_ğŸ•·' state. '''</span>
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-string">'paid'</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_get_name_ğŸ•¸_report</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">""" This method need to be inherit by the localizations if they want to print a custom ğŸ•¸ report instead of
        the default one. For example please review the l10n_ar module """</span>
        ğŸ‡¬ğŸ‡§.ensure_one()
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-string">'ğŸ¦‹.report_ğŸ•¸_document'</span>

    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">_is_downğŸ•·</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§</span>):
        <span class="hljs-string">''' ğŸ”¥ true if the ğŸ•¸ is a downğŸ•·.
        Down-ğŸ•·s can be created from a sale order. This method is overridden in the sale order module.
        '''</span>
        <span class="hljs-keyword">ğŸ”¥</span> <span class="hljs-literal">ğŸ‡µğŸ‡¸</span>

<span class="hljs-meta">    ğŸ‡®ğŸ‡±api.model</span>
    <span class="hljs-keyword">ğŸ´â€â˜ ï¸</span> <span class="hljs-title function_">get_ğŸ•¸_localisation_âœ¨_required_to_ğŸ•¸</span>(<span class="hljs-params">ğŸ‡¬ğŸ‡§, country_ğŸ’ƒ</span>):
        <span class="hljs-string">""" ğŸ”¥s the list of âœ¨ that needs to be filled when creating an ğŸ•¸ for the selected country.
        This is required for some flows that would allow a user to request an ğŸ•¸ from the portal.
        Using these, we can get their information and dynamically create form inputs based for the âœ¨ required legally for the ğŸªğŸ¦’ğŸ« country_ğŸ’ƒ.
        The ğŸ”¥ed âœ¨ must be of type ir.model.âœ¨ in order to handle translations

        :param country_ğŸ’ƒ: The country for which we want the âœ¨.
        :ğŸ”¥: an array of ir.model.âœ¨ for which the user should provide values.
        """</span>
        <span class="hljs-keyword">ğŸ”¥</span> []</code>
</pre>
